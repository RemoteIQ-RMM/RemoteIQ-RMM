

====================================================================================================
=  RemoteIQ Admin Permissions Export
====================================================================================================

Generated: 11/7/2025 11:46:56 AM
Repo Root: C:\Users\Last Stop\Documents\Programming Projects\RemoteIQ V7 - Ticketing

This file aggregates key Admin/ACL files with line numbers for precise review.
Sections:
 - Frontend Admin gates, tab registry, and one representative tab
 - Frontend auth/session helper
 - Backend policy/guard and admin-related controllers


----------------------------------------------------------------------------------------------------
File: remoteiq-frontend\app\administration\AdminGate.tsx
Size: 5,044 bytes    Modified: 11/7/2025 1:39:53 AM
----------------------------------------------------------------------------------------------------
     1: "use client";
     2: 
     3: import * as React from "react";
     4: import { useRouter } from "next/navigation";
     5: import TopBar from "@/components/top-bar";
     6: 
     7: // Flexible helper: honor NEXT_PUBLIC_API_BASE if set, otherwise same-origin
     8: function getApiBase(): string {
     9:     const raw = (process.env.NEXT_PUBLIC_API_BASE || "").replace(/\/+$/, "");
    10:     if (!raw) return ""; // same-origin
    11:     return raw.endsWith("/api") ? raw.slice(0, -4) : raw;
    12: }
    13: 
    14: type RoleLike =
    15:     | { permissions?: string[] | Record<string, boolean> }
    16:     | Record<string, unknown>;
    17: 
    18: type MeUser = {
    19:     id: string;
    20:     email?: string;
    21:     name?: string;
    22:     role?: string;
    23:     roles?: Array<{ id: string; name: string; permissions?: string[] | Record<string, boolean> }>;
    24:     permissions?: string[] | Record<string, boolean>;
    25: };
    26: 
    27: type MeResponse = { user: MeUser | null };
    28: 
    29: function toPermKeys(p?: string[] | Record<string, boolean>): string[] {
    30:     if (!p) return [];
    31:     if (Array.isArray(p)) return p;
    32:     return Object.entries(p)
    33:         .filter(([, v]) => Boolean(v))
    34:         .map(([k]) => k);
    35: }
    36: 
    37: function roleHasAdminAccess(role: RoleLike): boolean {
    38:     const keys = toPermKeys((role as any)?.permissions);
    39:     return keys.includes("admin.access");
    40: }
    41: 
    42: export default function AdminGate({ children }: { children: React.ReactNode }) {
    43:     const router = useRouter();
    44:     const [loading, setLoading] = React.useState(true);
    45:     const [allowed, setAllowed] = React.useState<boolean>(false);
    46: 
    47:     React.useEffect(() => {
    48:         let cancelled = false;
    49:         (async () => {
    50:             try {
    51:                 const base = getApiBase();
    52:                 const res = await fetch(`${base}/api/auth/me`, { credentials: "include" });
    53:                 if (!res.ok) throw new Error(String(res.status));
    54:                 const data: MeResponse = await res.json();
    55: 
    56:                 if (cancelled) return;
    57: 
    58:                 // Not logged in → send to login with next=/administration
    59:                 if (!data.user) {
    60:                     router.replace("/login?next=/administration");
    61:                     return;
    62:                 }
    63: 
    64:                 // Owners always allowed; otherwise require admin.access on user or any role
    65:                 const u = data.user;
    66:                 const userPerms = toPermKeys(u.permissions);
    67:                 const anyRoleHas = Array.isArray(u.roles) && u.roles.some((r) => roleHasAdminAccess(r));
    68:                 const isOwner = (u.role || "").toLowerCase() === "owner";
    69:                 const hasAdmin = isOwner || userPerms.includes("admin.access") || anyRoleHas;
    70: 
    71:                 setAllowed(hasAdmin);
    72:             } catch {
    73:                 // On error, punt back to login (token likely invalid)
    74:                 router.replace("/login?next=/administration");
    75:                 return;
    76:             } finally {
    77:                 if (!cancelled) setLoading(false);
    78:             }
    79:         })();
    80: 
    81:         return () => {
    82:             cancelled = true;
    83:         };
    84:     }, [router]);
    85: 
    86:     // Loading shimmer
    87:     if (loading) {
    88:         return (
    89:             <>
    90:                 <TopBar />
    91:                 <div
    92:                     className="bg-background h-[calc(100vh-3.5rem)] overflow-y-scroll"
    93:                     style={{ scrollbarGutter: "stable both-edges" }}
    94:                 >
    95:                     <div className="pt-14 flex items-center justify-center">
    96:                         <div className="text-sm text-muted-foreground">Checking access…</div>
    97:                     </div>
    98:                 </div>
    99:             </>
   100:         );
   101:     }
   102: 
   103:     // Forbidden
   104:     if (!allowed) {
   105:         return (
   106:             <>
   107:                 <TopBar />
   108:                 <div
   109:                     className="bg-background h-[calc(100vh-3.5rem)] overflow-y-scroll"
   110:                     style={{ scrollbarGutter: "stable both-edges" }}
   111:                 >
   112:                     <div className="pt-14 max-w-2xl mx-auto px-4">
   113:                         <div className="rounded-md border bg-card text-card-foreground p-6 mt-6">
   114:                             <h2 className="text-lg font-semibold">403 — Not authorized</h2>
   115:                             <p className="mt-1 text-sm text-muted-foreground">
   116:                                 You don’t have permission to access the Administration area. Ask an administrator to grant the{" "}
   117:                                 <code className="px-1 rounded bg-muted">admin.access</code> permission to your user or role.
   118:                             </p>
   119:                         </div>
   120:                     </div>
   121:                 </div>
   122:             </>
   123:         );
   124:     }
   125: 
   126:     // Allowed → render the original shell + children
   127:     return (
   128:         <>
   129:             <TopBar />
   130:             <div
   131:                 className="bg-background h-[calc(100vh-3.5rem)] overflow-y-scroll"
   132:                 style={{ scrollbarGutter: "stable both-edges" }}
   133:             >
   134:                 <div className="pt-14">{children}</div>
   135:             </div>
   136:         </>
   137:     );
   138: }

----------------------------------------------------------------------------------------------------
File: remoteiq-frontend\app\administration\helpers.tsx
Size: 5,131 bytes    Modified: 10/19/2025 12:41:50 AM
----------------------------------------------------------------------------------------------------
     1: // app/administration/helpers.tsx
     2: "use client";
     3: 
     4: import * as React from "react";
     5: import { Input } from "@/components/ui/input";
     6: import { Label } from "@/components/ui/label";
     7: import { Switch } from "@/components/ui/switch";
     8: import { Textarea } from "@/components/ui/textarea";
     9: import {
    10:     Select,
    11:     SelectTrigger,
    12:     SelectValue,
    13:     SelectContent,
    14:     SelectItem,
    15: } from "@/components/ui/select";
    16: import { cn } from "@/lib/utils";
    17: 
    18: /* ------------------- Inputs ------------------- */
    19: 
    20: export function LabeledInput({
    21:     label,
    22:     value,
    23:     onChange,
    24:     type = "text",
    25:     placeholder,
    26:     className,
    27: }: {
    28:     label: string;
    29:     value: string;
    30:     onChange: (v: string) => void;
    31:     type?: string;
    32:     placeholder?: string;
    33:     className?: string;
    34: }) {
    35:     return (
    36:         <div className={cn("grid gap-1", className)}>
    37:             <Label className="text-sm">{label}</Label>
    38:             <Input
    39:                 value={value}
    40:                 onChange={(e) => onChange(e.target.value)}
    41:                 type={type}
    42:                 placeholder={placeholder}
    43:             />
    44:         </div>
    45:     );
    46: }
    47: 
    48: export function LabeledTextarea({
    49:     label,
    50:     value,
    51:     onChange,
    52:     rows = 6,
    53: }: {
    54:     label: string;
    55:     value: string;
    56:     onChange: (v: string) => void;
    57:     rows?: number;
    58: }) {
    59:     return (
    60:         <div className="grid gap-1">
    61:             <Label className="text-sm">{label}</Label>
    62:             <Textarea value={value} onChange={(e) => onChange(e.target.value)} rows={rows} />
    63:         </div>
    64:     );
    65: }
    66: 
    67: export function LabeledNumber({
    68:     label,
    69:     value,
    70:     onChange,
    71: }: {
    72:     label: string;
    73:     value: number | "";
    74:     onChange: (v: number | "") => void;
    75: }) {
    76:     return (
    77:         <div className="grid gap-1">
    78:             <Label className="text-sm">{label}</Label>
    79:             <Input
    80:                 inputMode="numeric"
    81:                 value={value}
    82:                 onChange={(e) => {
    83:                     const v = e.target.value;
    84:                     onChange(v === "" ? "" : Number(v));
    85:                 }}
    86:             />
    87:         </div>
    88:     );
    89: }
    90: 
    91: export function CheckToggle({
    92:     label,
    93:     checked,
    94:     onChange,
    95: }: {
    96:     label: string;
    97:     checked: boolean;
    98:     onChange: (v: boolean) => void;
    99: }) {
   100:     return (
   101:         <label className="inline-flex items-center gap-2">
   102:             <Switch checked={checked} onCheckedChange={onChange} />
   103:             <span className="text-sm">{label}</span>
   104:         </label>
   105:     );
   106: }
   107: 
   108: export function LabeledSelect({
   109:     label,
   110:     value,
   111:     onChange,
   112:     options,
   113:     placeholder,
   114: }: {
   115:     label: string;
   116:     value: string;
   117:     onChange: (v: string) => void;
   118:     options: { value: string; label: string }[];
   119:     placeholder?: string;
   120: }) {
   121:     return (
   122:         <div className="grid gap-1">
   123:             <Label className="text-sm">{label}</Label>
   124:             <Select value={value} onValueChange={onChange}>
   125:                 <SelectTrigger>
   126:                     <SelectValue placeholder={placeholder} />
   127:                 </SelectTrigger>
   128:                 <SelectContent>
   129:                     {options.map((opt) => (
   130:                         <SelectItem key={opt.value} value={opt.value}>
   131:                             {opt.label}
   132:                         </SelectItem>
   133:                     ))}
   134:                 </SelectContent>
   135:             </Select>
   136:         </div>
   137:     );
   138: }
   139: 
   140: /* ------------------- Layout helpers ------------------- */
   141: 
   142: export function SettingCard({
   143:     icon,
   144:     title,
   145:     desc,
   146:     children,
   147: }: {
   148:     icon: React.ReactNode;
   149:     title: string;
   150:     desc: string;
   151:     children: React.ReactNode;
   152: }) {
   153:     return (
   154:         <div className="rounded-md border p-3">
   155:             <div className="mb-2 flex items-center gap-2">
   156:                 {icon}
   157:                 <div className="font-medium">{title}</div>
   158:             </div>
   159:             <div className="text-xs text-muted-foreground mb-3">{desc}</div>
   160:             {children}
   161:         </div>
   162:     );
   163: }
   164: 
   165: /* ------------------- Admin/Toast types ------------------- */
   166: 
   167: export type ToastKind = "default" | "success" | "destructive" | "warning";
   168: 
   169: export type Toast = {
   170:     id: string;
   171:     title: string;
   172:     desc?: string;
   173:     kind: ToastKind;
   174: };
   175: 
   176: /**
   177:  * Broad, forgiving signature to match callers in page.tsx and tabs.
   178:  * `kind` is optional; default it in your toast impl if omitted.
   179:  */
   180: export type ToastFn = (o: { title: string; desc?: string; kind?: ToastKind }) => void;
   181: 
   182: /* ------------------- Roles/Permissions row ------------------- */
   183: 
   184: export function PermRow({
   185:     label,
   186:     hint,
   187:     children,
   188: }: {
   189:     label: string;
   190:     hint?: string;
   191:     children: React.ReactNode;
   192: }) {
   193:     return (
   194:         <div className="flex items-start justify-between gap-4 py-2 border-b border-border/40">
   195:             <div>
   196:                 <div className="font-medium">{label}</div>
   197:                 {hint && <div className="text-xs text-muted-foreground">{hint}</div>}
   198:             </div>
   199:             <div>{children}</div>
   200:         </div>
   201:     );
   202: }

----------------------------------------------------------------------------------------------------
File: remoteiq-frontend\app\administration\page.tsx
Size: 28,157 bytes    Modified: 11/6/2025 2:09:12 AM
----------------------------------------------------------------------------------------------------
     1: // app/administration/page.tsx
     2: "use client";
     3: 
     4: import * as React from "react";
     5: import dynamic from "next/dynamic";
     6: import { useRouter, useSearchParams } from "next/navigation";
     7: import { Card } from "@/components/ui/card";
     8: import { Button } from "@/components/ui/button";
     9: import { Input } from "@/components/ui/input";
    10: import { Label } from "@/components/ui/label";
    11: import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
    12: import {
    13:     Dialog,
    14:     DialogContent,
    15:     DialogHeader,
    16:     DialogTitle,
    17:     DialogDescription,
    18:     DialogFooter,
    19: } from "@/components/ui/dialog";
    20: import {
    21:     Shield,
    22:     ShieldCheck,
    23:     Users,
    24:     KeyRound,
    25:     ServerCog,
    26:     FileText,
    27:     Rocket,
    28:     Mail,
    29:     Database,
    30:     Cloud,
    31:     ArchiveRestore,
    32:     FileSignature,
    33:     Building2,
    34:     CreditCard,
    35:     ReceiptText,
    36:     Palette,
    37:     Languages,
    38:     BellRing,
    39:     LockKeyhole,
    40:     Gavel,
    41:     Plug,
    42:     Laptop2,
    43:     Workflow,
    44:     ArrowRightLeft,
    45:     ListPlus,
    46:     Gem,
    47:     UserCog,
    48:     Ticket,
    49:     Vault,
    50:     Table,
    51:     DatabaseZap,
    52:     BarChart3,
    53:     BookUser,
    54:     CalendarClock,
    55:     Lock,
    56:     UserCheck,
    57:     ChevronDown,
    58: } from "lucide-react";
    59: import { cn } from "@/lib/utils";
    60: 
    61: // API
    62: import {
    63:     getAdminUsers,
    64:     getAdminRoles,
    65:     removeUser,
    66:     getLocalizationSettings,
    67:     type UserDTO,
    68: } from "@/lib/api";
    69: 
    70: // Shared UI types
    71: import type { User as UiUser, LocalizationSettings } from "./types";
    72: 
    73: // Tabs (lazy)
    74: const UsersTab = dynamic(() => import("./tabs/UsersTab"));
    75: const RolesTab = dynamic(() => import("./tabs/RolesTab"));
    76: const CompanyTab = dynamic(() => import("./tabs/CompanyTab"));
    77: const BillingTab = dynamic(() => import("./tabs/BillingTab"));
    78: const InvoicesTab = dynamic(() => import("./tabs/InvoicesTab"));
    79: const SmtpTab = dynamic(() => import("./tabs/SmtpTab"));
    80: const SystemTab = dynamic(() => import("./tabs/SystemTab"));
    81: const SsoTab = dynamic(() => import("./tabs/SsoTab"));
    82: const DatabaseTab = dynamic(() => import("./tabs/DatabaseTab"));
    83: const StorageTab = dynamic(() => import("./tabs/StorageTab"));
    84: const BackupsTab = dynamic(() => import("./tabs/BackupsTab"));
    85: const EmailTemplatesTab = dynamic(() => import("./tabs/TemplatesTab"));
    86: const AuditLogsTab = dynamic(() => import("./tabs/AuditLogsTab"));
    87: const ApiTab = dynamic(() => import("./tabs/ApiTab"));
    88: const FeatureFlagsTab = dynamic(() => import("./tabs/FlagsTab"));
    89: const BrandingTab = dynamic(() => import("./tabs/BrandingTab"));
    90: const LocalizationTab = dynamic(() => import("./tabs/LocalizationTab"));
    91: const NotificationsTab = dynamic(() => import("./tabs/NotificationsTab"));
    92: const SecurityPoliciesTab = dynamic(() => import("./tabs/SecurityPoliciesTab"));
    93: const IntegrationsTab = dynamic(() => import("./tabs/IntegrationsTab"));
    94: const SubscriptionTab = dynamic(() => import("./tabs/SubscriptionTab"));
    95: const ClientPortalTab = dynamic(() => import("./tabs/ClientPortalTab"));
    96: const ComplianceTab = dynamic(() => import("./tabs/ComplianceTab"));
    97: const AgentsTab = dynamic(() => import("./tabs/AgentsTab"));
    98: const WorkflowsTab = dynamic(() => import("./tabs/WorkflowsTab"));
    99: const ImportExportTab = dynamic(() => import("./tabs/ImportExportTab"));
   100: const CustomFieldsTab = dynamic(() => import("./tabs/CustomFieldsTab"));
   101: const SlaTab = dynamic(() => import("./tabs/SlaTab"));
   102: const TicketingTab = dynamic(() => import("./tabs/TicketingTab"));
   103: const SecretsTab = dynamic(() => import("./tabs/SecretsTab"));
   104: // ✅ Use the SessionsTab from account (has onDirtyChange/saveHandleRef)
   105: const SessionsTab = dynamic(() => import("../account/tabs/SessionsTab"));
   106: const RolesMatrixTab = dynamic(() => import("./tabs/RolesMatrixTab"));
   107: const MigrationsTab = dynamic(() => import("./tabs/MigrationsTab"));
   108: const SupportTab = dynamic(() => import("./tabs/SupportTab"));
   109: const ReportsTab = dynamic(() => import("./tabs/ReportsTab"));
   110: 
   111: /* ---------------- Toasts ---------------- */
   112: type Toast = {
   113:     id: string;
   114:     title: string;
   115:     desc?: string;
   116:     kind: "success" | "destructive" | "warning" | "default";
   117: };
   118: 
   119: function useToasts() {
   120:     const [toasts, setToasts] = React.useState<Toast[]>([]);
   121:     const push = React.useCallback((t: Omit<Toast, "id">) => {
   122:         const id = Math.random().toString(36).slice(2);
   123:         setToasts((prev) => [...prev, { ...t, id }]);
   124:         window.setTimeout(
   125:             () => setToasts((prev) => prev.filter((x) => x.id !== id)),
   126:             4200
   127:         );
   128:     }, []);
   129:     return { toasts, push };
   130: }
   131: 
   132: /* ---------------- Helpers ---------------- */
   133: function mapUserDTO(u: UserDTO): UiUser {
   134:     // keep API fields intact; UsersTab expects UiUser shape
   135:     return { ...(u as any) } as unknown as UiUser;
   136: }
   137: 
   138: // API base helper (so we can call /api/roles directly)
   139: function getApiBase(): string {
   140:     const raw = (process.env.NEXT_PUBLIC_API_BASE || "").replace(/\/+$/, "");
   141:     if (!raw) return "/api";
   142:     return raw.endsWith("/api") ? raw : `${raw}/api`;
   143: }
   144: const API_BASE = getApiBase();
   145: 
   146: // Coerce API firstDayOfWeek into the UI union: "sunday" | "monday"
   147: function coerceFirstDay(apiVal: unknown): "sunday" | "monday" {
   148:     if (typeof apiVal === "string") {
   149:         const v = apiVal.toLowerCase();
   150:         if (v === "sunday" || v === "monday") return v;
   151:     }
   152:     if (typeof apiVal === "number") {
   153:         return apiVal === 0 ? "sunday" : "monday";
   154:     }
   155:     return "monday";
   156: }
   157: 
   158: function mapLocalization(apiLoc: any): LocalizationSettings {
   159:     const allowedLangs = new Set(["en-US", "en-GB", "es-ES", "fr-FR"]);
   160:     const langRaw = apiLoc?.language;
   161:     const language = allowedLangs.has(langRaw) ? langRaw : "en-US";
   162: 
   163:     return {
   164:         language,
   165:         timeZone: apiLoc?.timeZone ?? apiLoc?.timezone ?? "UTC",
   166:         numberFormat: apiLoc?.numberFormat ?? "1,234.56",
   167:         dateFormat: apiLoc?.dateFormat ?? "YYYY-MM-DD",
   168:         timeFormat: apiLoc?.timeFormat ?? "24h",
   169:         firstDayOfWeek: coerceFirstDay(apiLoc?.firstDayOfWeek),
   170:     };
   171: }
   172: 
   173: export default function AdministrationPage() {
   174:     const { toasts, push: pushToast } = useToasts();
   175:     const push = pushToast;
   176: 
   177:     // -------- tab state with URL + localStorage persistence --------
   178:     const router = useRouter();
   179:     const searchParams = useSearchParams();
   180:     const [tab, setTab] = React.useState("company");
   181: 
   182:     // ===== SHARED DATA =====
   183:     const [users, setUsers] = React.useState<UiUser[]>([]);
   184:     const [roles, setRoles] = React.useState<any[]>([]); // pass-through; RolesTab normalizes
   185:     const [loading, setLoading] = React.useState(false);
   186:     const [loc, setLoc] = React.useState<LocalizationSettings | null>(null);
   187: 
   188:     const loadedRef = React.useRef(false);
   189: 
   190:     /* ---------------- Left Nav model (used for VALID_TABS) ---------------- */
   191:     const navItemGroups = React.useMemo(
   192:         () => [
   193:             {
   194:                 title: "General",
   195:                 items: [
   196:                     { v: "company", label: "Company", Icon: Building2 },
   197:                     { v: "branding", label: "Branding", Icon: Palette },
   198:                     { v: "localization", label: "Localization", Icon: Languages },
   199:                     { v: "support", label: "Support & Legal", Icon: BookUser },
   200:                 ],
   201:             },
   202:             {
   203:                 title: "Access Management",
   204:                 items: [
   205:                     { v: "users", label: "Users", Icon: Users },
   206:                     { v: "roles", label: "Roles", Icon: ShieldCheck },
   207:                     { v: "sso", label: "SSO", Icon: Lock },
   208:                     { v: "security_policies", label: "Security Policies", Icon: LockKeyhole },
   209:                     { v: "sessions", label: "Session Mgmt", Icon: UserCheck },
   210:                     { v: "roles_matrix", label: "Roles Matrix", Icon: Table },
   211:                 ],
   212:             },
   213:             {
   214:                 title: "Billing",
   215:                 items: [
   216:                     { v: "subscription", label: "Subscription", Icon: Gem },
   217:                     { v: "billing", label: "Billing", Icon: CreditCard },
   218:                     { v: "invoices", label: "Invoices", Icon: ReceiptText },
   219:                 ],
   220:             },
   221:             {
   222:                 title: "Communications",
   223:                 items: [
   224:                     { v: "smtp", label: "SMTP", Icon: Mail },
   225:                     { v: "notifications", label: "Notifications", Icon: BellRing },
   226:                     { v: "templates", label: "Email Templates", Icon: FileSignature },
   227:                 ],
   228:             },
   229:             {
   230:                 title: "Infrastructure",
   231:                 items: [
   232:                     { v: "system", label: "System", Icon: ServerCog },
   233:                     { v: "database", label: "Database", Icon: Database },
   234:                     { v: "storage", label: "Storage (S3)", Icon: Cloud },
   235:                     { v: "backups", label: "Backups", Icon: ArchiveRestore },
   236:                     { v: "agents", label: "Agents", Icon: Laptop2 },
   237:                     { v: "migrations", label: "Data Migrations", Icon: DatabaseZap },
   238:                 ],
   239:             },
   240:             {
   241:                 title: "Advanced",
   242:                 items: [
   243:                     { v: "audit", label: "Audit Logs", Icon: FileText },
   244:                     { v: "api", label: "API", Icon: KeyRound },
   245:                     { v: "integrations", label: "Integrations", Icon: Plug },
   246:                     { v: "secrets", label: "Secrets", Icon: Vault },
   247:                     { v: "workflows", label: "Workflows", Icon: Workflow },
   248:                     { v: "import_export", label: "Import / Export", Icon: ArrowRightLeft },
   249:                     { v: "custom_fields", label: "Custom Fields", Icon: ListPlus },
   250:                     { v: "client_portal", label: "Client Portal", Icon: UserCog },
   251:                     { v: "sla", label: "SLA", Icon: CalendarClock },
   252:                     { v: "ticketing", label: "Ticketing", Icon: Ticket },
   253:                     { v: "reports", label: "Reports", Icon: BarChart3 },
   254:                     { v: "flags", label: "Feature Flags", Icon: Rocket },
   255:                     { v: "compliance", label: "Compliance", Icon: Gavel },
   256:                 ],
   257:             },
   258:         ],
   259:         []
   260:     );
   261: 
   262:     // Build set of valid tab keys for validation
   263:     const VALID_TABS = React.useMemo(
   264:         () => new Set(navItemGroups.flatMap((g) => g.items.map((i) => i.v))),
   265:         [navItemGroups]
   266:     );
   267: 
   268:     // On first mount, derive initial tab from URL (?tab=) or localStorage
   269:     React.useEffect(() => {
   270:         const fromQuery = searchParams?.get("tab") || "";
   271:         const fromStorage =
   272:             typeof window !== "undefined" ? localStorage.getItem("admin.tab") || "" : "";
   273: 
   274:         const initial =
   275:             (fromQuery && VALID_TABS.has(fromQuery)) ? fromQuery :
   276:                 (fromStorage && VALID_TABS.has(fromStorage)) ? fromStorage :
   277:                     "company";
   278: 
   279:         setTab(initial);
   280:         // eslint-disable-next-line react-hooks/exhaustive-deps
   281:     }, []);
   282: 
   283:     // Persist tab changes to URL + localStorage
   284:     React.useEffect(() => {
   285:         if (!tab) return;
   286: 
   287:         if (typeof window !== "undefined") {
   288:             localStorage.setItem("admin.tab", tab);
   289:         }
   290: 
   291:         const current = new URLSearchParams(searchParams ? searchParams.toString() : "");
   292:         current.set("tab", tab);
   293:         router.replace(`?${current.toString()}`, { scroll: false });
   294:     }, [tab, searchParams, router]);
   295: 
   296:     /* ---------------- Data fetching ---------------- */
   297:     const refetchUsers = React.useCallback(async () => {
   298:         try {
   299:             const { items } = await getAdminUsers();
   300:             setUsers(items.map(mapUserDTO));
   301:         } catch (e: any) {
   302:             push({
   303:                 title: "Failed to refresh users",
   304:                 desc: e?.message ?? "Internal server error",
   305:                 kind: "destructive",
   306:             });
   307:         }
   308:     }, [push]);
   309: 
   310:     React.useEffect(() => {
   311:         if (loadedRef.current) return;
   312:         loadedRef.current = true;
   313: 
   314:         (async () => {
   315:             setLoading(true);
   316:             try {
   317:                 const [usersRes, rolesRes, locRes] = await Promise.allSettled([
   318:                     getAdminUsers(),
   319:                     getAdminRoles(),
   320:                     getLocalizationSettings(),
   321:                 ]);
   322: 
   323:                 // Users
   324:                 if (usersRes.status === "fulfilled") {
   325:                     const items = usersRes.value?.items ?? [];
   326:                     setUsers(items.map(mapUserDTO));
   327:                 } else {
   328:                     setUsers([]);
   329:                     push({
   330:                         title: "Failed to load users",
   331:                         desc: (usersRes.reason as any)?.message ?? "Internal server error",
   332:                         kind: "destructive",
   333:                     });
   334:                 }
   335: 
   336:                 // Roles — prefer full /api/roles if the admin listing is "short"
   337:                 if (rolesRes.status === "fulfilled") {
   338:                     const maybe = Array.isArray((rolesRes.value as any)?.items)
   339:                         ? (rolesRes.value as any).items
   340:                         : Array.isArray(rolesRes.value)
   341:                             ? (rolesRes.value as any)
   342:                             : [];
   343: 
   344:                     const looksShort =
   345:                         Array.isArray(maybe) &&
   346:                         maybe.length > 0 &&
   347:                         maybe[0] &&
   348:                         maybe[0].description === undefined &&
   349:                         maybe[0].permissions === undefined;
   350: 
   351:                     try {
   352:                         const full = looksShort
   353:                             ? await fetch(`${API_BASE}/roles`, {
   354:                                 cache: "no-store",
   355:                                 credentials: "include",
   356:                             }).then((r) => {
   357:                                 if (!r.ok) throw new Error(`Failed to GET /roles (${r.status})`);
   358:                                 return r.json() as Promise<any[]>;
   359:                             })
   360:                             : maybe ?? [];
   361: 
   362:                         setRoles(full as any[]);
   363:                     } catch (e: any) {
   364:                         setRoles(maybe as any[]);
   365:                         push({
   366:                             title: "Failed to load role details",
   367:                             desc: e?.message ?? "Request failed",
   368:                             kind: "destructive",
   369:                         });
   370:                     }
   371:                 } else {
   372:                     setRoles([]);
   373:                     push({
   374:                         title: "Failed to load roles",
   375:                         desc: (rolesRes.reason as any)?.message ?? "Internal server error",
   376:                         kind: "destructive",
   377:                     });
   378:                 }
   379: 
   380:                 // Localization
   381:                 if (locRes.status === "fulfilled") {
   382:                     const apiLoc = locRes.value ?? null;
   383:                     setLoc(apiLoc ? mapLocalization(apiLoc) : null);
   384:                 } else {
   385:                     setLoc(null);
   386:                 }
   387:             } finally {
   388:                 setLoading(false);
   389:             }
   390:         })();
   391:     }, [push]);
   392: 
   393:     // Invite modal (optional)
   394:     const [inviteOpen, setInviteOpen] = React.useState(false);
   395:     const [inviteEmails, setInviteEmails] = React.useState("");
   396: 
   397:     function onInviteUsers() {
   398:         const emails = inviteEmails
   399:             .split(",")
   400:             .map((e) => e.trim())
   401:             .filter(Boolean);
   402:         if (!emails.length) {
   403:             push({ title: "No emails provided", kind: "warning" });
   404:             return;
   405:         }
   406:         setInviteEmails("");
   407:         setInviteOpen(false);
   408:         push({
   409:             title: "Invitations queued",
   410:             desc: `Sent to ${emails.length} recipient(s).`,
   411:             kind: "success",
   412:         });
   413:     }
   414: 
   415:     const [removeUserId, setRemoveUserId] = React.useState<string | null>(null);
   416:     const [reset2FAUserId, setReset2FAUserId] = React.useState<string | null>(null);
   417: 
   418:     async function onConfirmRemoveUser() {
   419:         if (!removeUserId) return;
   420:         const id = removeUserId;
   421:         setRemoveUserId(null);
   422: 
   423:         const before = users;
   424:         setUsers((prev) => prev.filter((p) => p.id !== id));
   425:         try {
   426:             await removeUser(id);
   427:             await refetchUsers();
   428:             push({ title: "User deleted", kind: "success" });
   429:         } catch (e: any) {
   430:             setUsers(before);
   431:             push({
   432:                 title: "Failed to delete user",
   433:                 desc: e?.message ?? "Request failed",
   434:                 kind: "destructive",
   435:             });
   436:         }
   437:     }
   438: 
   439:     /* ---------------- Left Nav UI state ---------------- */
   440:     const [openGroups, setOpenGroups] = React.useState<string[]>([]);
   441: 
   442:     React.useEffect(() => {
   443:         const currentGroup = navItemGroups.find((g) =>
   444:             g.items.some((item) => item.v === tab)
   445:         );
   446:         if (currentGroup) {
   447:             setOpenGroups((prev) =>
   448:                 prev.includes(currentGroup.title) ? prev : [...prev, currentGroup.title]
   449:             );
   450:         }
   451:     }, [tab, navItemGroups]);
   452: 
   453:     const toggleGroup = (title: string) => {
   454:         setOpenGroups((prev) =>
   455:             prev.includes(title) ? prev.filter((g) => g !== title) : [...prev, title]
   456:         );
   457:     };
   458: 
   459:     return (
   460:         <main className="p-4 sm:p-6">
   461:             <div className="mx-auto max-w-7xl">
   462:                 <div className="mb-6">
   463:                     <h1 className="text-xl font-semibold flex items-center gap-2">
   464:                         <Shield className="h-5 w-5" /> Administration
   465:                     </h1>
   466:                     <p className="text-sm text-muted-foreground">
   467:                         Organization-wide settings, users, roles, storage, billing and system
   468:                         controls.
   469:                     </p>
   470:                 </div>
   471: 
   472:                 <Tabs
   473:                     value={tab}
   474:                     onValueChange={setTab}
   475:                     className="grid grid-cols-[240px_1fr] items-start gap-6"
   476:                 >
   477:                     {/* Left rail */}
   478:                     <aside className="w-[240px] shrink-0 self-start sticky top-[70px] sm:top-[70px]">
   479:                         <Card>
   480:                             <TabsList className="flex h-auto w-full flex-col items-start justify-start gap-1 bg-transparent p-2">
   481:                                 {navItemGroups.map((group, groupIndex) => (
   482:                                     <div
   483:                                         key={group.title}
   484:                                         className={cn("w-full", groupIndex > 0 && "border-t mt-2 pt-2")}
   485:                                     >
   486:                                         <button
   487:                                             onClick={() => toggleGroup(group.title)}
   488:                                             className="w-full flex items-center justify-start gap-2 rounded-md px-2 py-2 text-sm font-semibold text-foreground hover:bg-muted/50"
   489:                                         >
   490:                                             <ChevronDown
   491:                                                 className={cn(
   492:                                                     "h-4 w-4 transition-transform text-muted-foreground",
   493:                                                     openGroups.includes(group.title) ? "rotate-0" : "-rotate-90"
   494:                                                 )}
   495:                                             />
   496:                                             {group.title}
   497:                                         </button>
   498:                                         {group.items.map(({ v, label, Icon }) => {
   499:                                             const isOpen = openGroups.includes(group.title);
   500:                                             const isActive = tab === v;
   501:                                             if (!isOpen && !isActive) return null;
   502:                                             return (
   503:                                                 <TabsTrigger
   504:                                                     key={v}
   505:                                                     value={v}
   506:                                                     className="w-full justify-start rounded-md border-l-2 border-transparent px-3 py-2 pl-8 text-sm text-muted-foreground hover:bg-muted/50 data-[state=active]:border-l-primary data-[state=active]:bg-primary/10 data-[state=active]:font-semibold data-[state=active]:text-primary"
   507:                                                 >
   508:                                                     <Icon className="mr-2 h-4 w-4" />
   509:                                                     {label}
   510:                                                 </TabsTrigger>
   511:                                             );
   512:                                         })}
   513:                                     </div>
   514:                                 ))}
   515:                             </TabsList>
   516:                         </Card>
   517:                     </aside>
   518: 
   519:                     {/* Right side */}
   520:                     <div className="min-w-0 flex-1">
   521:                         {tab === "users" && (
   522:                             <UsersTab
   523:                                 users={users}
   524:                                 setUsers={setUsers}
   525:                                 roles={roles as any[]}
   526:                                 push={push}
   527:                                 setRemoveUserId={() => { }}
   528:                                 setReset2FAUserId={() => { }}
   529:                                 setInviteOpen={() => { }}
   530:                                 refetchUsers={refetchUsers}
   531:                                 localization={loc ?? undefined}
   532:                             />
   533:                         )}
   534: 
   535:                         {tab === "roles" && (
   536:                             <RolesTab
   537:                                 roles={roles as any[]} // pass-through (keeps description + permissions)
   538:                                 setRoles={setRoles as any}
   539:                                 push={push}
   540:                             />
   541:                         )}
   542: 
   543:                         {tab === "company" && <CompanyTab push={push} />}
   544:                         {tab === "branding" && <BrandingTab push={push} />}
   545:                         {tab === "localization" && <LocalizationTab push={push} />}
   546:                         {tab === "support" && <SupportTab push={push} />}
   547: 
   548:                         {tab === "subscription" && <SubscriptionTab push={push} />}
   549:                         {tab === "billing" && <BillingTab push={push} />}
   550:                         {tab === "invoices" && <InvoicesTab push={push} />}
   551:                         {tab === "security_policies" && <SecurityPoliciesTab push={push} />}
   552:                         {tab === "smtp" && <SmtpTab push={push} />}
   553:                         {tab === "notifications" && <NotificationsTab push={push} />}
   554:                         {tab === "templates" && <EmailTemplatesTab push={push} />}
   555: 
   556:                         {tab === "system" && <SystemTab push={push} />}
   557:                         {tab === "database" && <DatabaseTab push={push} />}
   558: 
   559:                         {/* ⬇️ FIX: stop passing `push` to StorageTab and BackupsTab */}
   560:                         {tab === "storage" && <StorageTab />}
   561:                         {tab === "backups" && <BackupsTab />}
   562: 
   563:                         {tab === "agents" && <AgentsTab push={push} />}
   564:                         {tab === "migrations" && <MigrationsTab push={push} />}
   565: 
   566:                         {tab === "audit" && <AuditLogsTab push={push} />}
   567:                         {tab === "api" && <ApiTab push={push} />}
   568:                         {tab === "integrations" && <IntegrationsTab push={push} />}
   569:                         {tab === "secrets" && <SecretsTab push={push} />}
   570:                         {tab === "workflows" && <WorkflowsTab push={push} />}
   571:                         {tab === "import_export" && <ImportExportTab push={push} />}
   572:                         {tab === "custom_fields" && <CustomFieldsTab push={push} />}
   573:                         {tab === "client_portal" && <ClientPortalTab push={push} />}
   574:                         {tab === "sla" && <SlaTab push={push} />}
   575:                         {tab === "ticketing" && <TicketingTab push={push} />}
   576:                         {tab === "reports" && <ReportsTab push={push} />}
   577:                         {tab === "flags" && <FeatureFlagsTab push={push} />}
   578:                         {tab === "compliance" && <ComplianceTab push={push} />}
   579: 
   580:                         {/* ✅ Sessions tab now imports the account version with matching props */}
   581:                         {tab === "sessions" && (
   582:                             <SessionsTab onDirtyChange={() => { }} saveHandleRef={() => { }} />
   583:                         )}
   584: 
   585:                         {tab === "roles_matrix" && <RolesMatrixTab push={push} />}
   586:                         {tab === "sso" && <SsoTab push={push} />}
   587:                     </div>
   588:                 </Tabs>
   589:             </div>
   590: 
   591:             {/* Invite dialog */}
   592:             <Dialog open={inviteOpen} onOpenChange={setInviteOpen}>
   593:                 <DialogContent>
   594:                     <DialogHeader>
   595:                         <DialogTitle>Invite users</DialogTitle>
   596:                         <DialogDescription>
   597:                             Enter one or more email addresses, separated by commas.
   598:                         </DialogDescription>
   599:                     </DialogHeader>
   600:                     <div className="space-y-2">
   601:                         <Label htmlFor="invite-emails">Email addresses</Label>
   602:                         <Input
   603:                             id="invite-emails"
   604:                             placeholder="alice@acme.com, bob@acme.com"
   605:                             value={inviteEmails}
   606:                             onChange={(e) => setInviteEmails(e.target.value)}
   607:                         />
   608:                     </div>
   609:                     <DialogFooter className="mt-4">
   610:                         <Button variant="outline" onClick={() => setInviteOpen(false)}>
   611:                             Cancel
   612:                         </Button>
   613:                         <Button variant="success" onClick={onInviteUsers}>
   614:                             Send invites
   615:                         </Button>
   616:                     </DialogFooter>
   617:                 </DialogContent>
   618:             </Dialog>
   619: 
   620:             {/* Toasts */}
   621:             <div className="fixed bottom-4 right-4 z-[100] space-y-2">
   622:                 {toasts.map((t) => {
   623:                     const klass =
   624:                         t.kind === "success"
   625:                             ? "border-emerald-200 bg-emerald-50 text-emerald-900 dark:border-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-200"
   626:                             : t.kind === "destructive"
   627:                                 ? "border-red-200 bg-red-50 text-red-900 dark:border-red-700 dark:bg-red-900/20 dark:text-red-200"
   628:                                 : t.kind === "warning"
   629:                                     ? "border-amber-300 bg-amber-50 text-amber-900 dark:border-amber-600 dark:bg-amber-900/20 dark:text-amber-200"
   630:                                     : "border-border bg-card text-card-foreground";
   631:                     return (
   632:                         <div
   633:                             key={t.id}
   634:                             className={cn("w-[340px] rounded-md border px-4 py-3 shadow-md", klass)}
   635:                         >
   636:                             <div className="text-sm font-medium">{t.title}</div>
   637:                             {t.desc ? <div className="mt-1 text-xs opacity-90">{t.desc}</div> : null}
   638:                         </div>
   639:                     );
   640:                 })}
   641:             </div>
   642:         </main>
   643:     );
   644: }

----------------------------------------------------------------------------------------------------
File: remoteiq-frontend\app\administration\layout.tsx
Size: 456 bytes    Modified: 11/7/2025 1:40:03 AM
----------------------------------------------------------------------------------------------------
     1: // app/administration/layout.tsx
     2: import * as React from "react";
     3: import AdminGate from "./AdminGate";
     4: 
     5: export const metadata = {
     6:     title: "Administration • RemoteIQ",
     7: };
     8: 
     9: export default function AdministrationLayout({
    10:     children,
    11: }: {
    12:     children: React.ReactNode;
    13: }) {
    14:     // Keep this file server-only so `metadata` is allowed.
    15:     // All client logic & UI shell live in AdminGate.
    16:     return <AdminGate>{children}</AdminGate>;
    17: }

----------------------------------------------------------------------------------------------------
File: remoteiq-frontend\app\administration\types.ts
Size: 9,134 bytes    Modified: 11/6/2025 5:36:57 PM
----------------------------------------------------------------------------------------------------
     1: // ===== Shared Types for Administration Page =====
     2: 
     3: export type ToastKind = "success" | "destructive" | "warning" | "default";
     4: export type Toast = { id: string; title: string; desc?: string; kind: ToastKind };
     5: export type ToastFn = (t: Omit<Toast, "id">) => void;
     6: 
     7: // In your shared types file
     8: export type User = {
     9:     id: string;
    10:     name: string;
    11:     email: string;
    12:     role: string;
    13:     roleId?: string | null;
    14:     roles?: Array<{ id: string; name: string }>;
    15:     status: string;
    16:     lastSeen: string;
    17:     twoFactorEnabled?: boolean;
    18:     suspended?: boolean;
    19: 
    20:     // Optional profile fields used by the Edit User modal
    21:     phone?: string | null;
    22:     address1?: string | null;
    23:     address2?: string | null;
    24:     city?: string | null;
    25:     state?: string | null;
    26:     postal?: string | null;
    27:     country?: string | null;
    28: 
    29:     // Optional timestamps (if present)
    30:     createdAt?: string;
    31:     updatedAt?: string;
    32: };
    33: 
    34: 
    35: 
    36: export type PermissionKey =
    37:     | "view_devices"
    38:     | "manage_devices"
    39:     | "manage_users"
    40:     | "billing_access"
    41:     | "view_audit"
    42:     | "manage_api"
    43:     | "manage_flags";
    44: 
    45: export type Role = {
    46:     id: string;
    47:     name: string;
    48:     description?: string;  
    49:     permissions: Record<PermissionKey, boolean>;
    50:     builtIn?: boolean;
    51:     rawPermissions?: string[]; 
    52: };
    53: 
    54: export type CompanyInfo = {
    55:     name: string;
    56:     legalName: string;
    57:     email: string;
    58:     phone: string;
    59:     fax: string;
    60:     website: string;
    61:     vatTin: string;
    62:     address1: string;
    63:     address2: string;
    64:     city: string;
    65:     state: string;
    66:     postal: string;
    67:     country: string;
    68: };
    69: 
    70: // ===== Billing (Gateways & Bank) =====
    71: export type Currency = "USD" | "EUR" | "GBP" | "CAD" | "AUD";
    72: export type TaxMode = "exclusive" | "inclusive" | "none";
    73: 
    74: export type StripeCfg = { enabled: boolean; publishableKey: string; secretKey: string; webhookSecret: string };
    75: export type PaypalCfg = { enabled: boolean; clientId: string; clientSecret: string; mode: "live" | "sandbox" };
    76: export type SquareCfg = { enabled: boolean; accessToken: string; locationId: string };
    77: export type AuthorizeCfg = { enabled: boolean; apiLoginId: string; transactionKey: string };
    78: 
    79: export type BankCfg = {
    80:     enableACH: boolean;
    81:     accountHolder: string;
    82:     routingNumber: string;
    83:     accountNumber: string;
    84:     accountType: "checking" | "savings" | "";
    85:     bankName: string;
    86: };
    87: 
    88: export type BillingConfig = {
    89:     currency: Currency;
    90:     taxMode: TaxMode;
    91:     defaultTaxRate: number | "";
    92:     statementDescriptor: string;
    93:     stripe: StripeCfg;
    94:     paypal: PaypalCfg;
    95:     square: SquareCfg;
    96:     authorize: AuthorizeCfg;
    97:     bank: BankCfg;
    98: };
    99: 
   100: // ===== Invoices =====
   101: export type InvoiceConfig = {
   102:     numberingPrefix: string;
   103:     nextNumber: number | "";
   104:     defaultNetTerms: 7 | 14 | 30 | 45 | 60;
   105:     defaultDiscountPct: number | "";
   106:     defaultLateFeePct: number | "";
   107:     defaultNotes: string;
   108:     footer: string;
   109:     showCompanyAddress: boolean;
   110:     attachPdfToEmail: boolean;
   111:     emailFrom: string;
   112: };
   113: 
   114: // ===== SMTP =====
   115: export type EmailPurpose = "alerts" | "invites" | "password_resets" | "reports";
   116: 
   117: export type SmtpSettings = {
   118:     host: string;
   119:     port: number | "";
   120:     username: string;
   121:     password: string;
   122:     useTLS: boolean;
   123:     useSSL: boolean;
   124:     fromAddress: string;
   125: };
   126: 
   127: export type ImapSettings = {
   128:     host: string;
   129:     port: number | "";
   130:     username: string;
   131:     password: string;
   132:     useSSL: boolean;
   133: };
   134: 
   135: export type PopSettings = {
   136:     host: string;
   137:     port: number | "";
   138:     username: string;
   139:     password: string;
   140:     useSSL: boolean;
   141: };
   142: 
   143: export type EmailProfile = {
   144:     smtp: SmtpSettings;
   145:     imap: ImapSettings;
   146:     pop: PopSettings;
   147:     enabled: boolean;
   148: };
   149: 
   150: // ===== 2FA + SSO =====
   151: export type SsoProvider = "saml" | "oidc";
   152: 
   153: export type SamlConfig = {
   154:     metadataUrl: string;
   155:     idpEntityId: string;
   156:     idpSsoUrl: string;
   157:     idpCertificate: string;
   158:     nameIdFormat: string;
   159:     attrEmail: string;
   160:     attrFirstName: string;
   161:     attrLastName: string;
   162:     attrGroups: string;
   163:     jitProvisioning: boolean;
   164:     groupRoleSync: boolean;
   165: };
   166: 
   167: export type OidcConfig = {
   168:     issuer: string;
   169:     clientId: string;
   170:     clientSecret: string;
   171:     scopes: string;
   172:     discoveryUrl: string;
   173: };
   174: 
   175: // ===== Database =====
   176: export type DbEngine = "postgresql" | "mysql" | "mssql" | "sqlite" | "mongodb";
   177: export type DbAuthMode = "url" | "fields";
   178: export type StorageDomain =
   179:     | "users"
   180:     | "roles"
   181:     | "sessions"
   182:     | "audit_logs"
   183:     | "devices"
   184:     | "policies"
   185:     | "email_queue";
   186: 
   187: export type DatabaseConfig = {
   188:     enabled: boolean;
   189:     engine: DbEngine;
   190:     authMode: DbAuthMode;
   191:     url: string;
   192:     host: string;
   193:     port: number | "";
   194:     dbName: string;
   195:     username: string;
   196:     password: string;
   197:     ssl: boolean;
   198:     poolMin: number | "";
   199:     poolMax: number | "";
   200:     readReplicas: string;
   201:     mappings: Record<StorageDomain, string>;
   202: };
   203: 
   204: // ===== S3 Storage =====
   205: export type S3Provider = "aws" | "minio" | "wasabi" | "other";
   206: export type StorageBackend = "local" | "s3";
   207: export type S3Config = {
   208:     enabled: boolean;
   209:     backend: StorageBackend;
   210:     provider: S3Provider;
   211:     accessKeyId: string;
   212:     secretAccessKey: string;
   213:     bucket: string;
   214:     region: string;
   215:     endpoint: string;
   216:     prefix: string;
   217:     pathStyle: boolean;
   218:     sse: "none" | "AES256" | "aws:kms";
   219:     kmsKeyId: string;
   220: };
   221: 
   222: // ===== Backups =====
   223: export type BackupTarget =
   224:     | "users"
   225:     | "roles"
   226:     | "devices"
   227:     | "policies"
   228:     | "audit_logs"
   229:     | "settings"
   230:     | "templates";
   231: 
   232: export type BackupDestination = { kind: "local" } | { kind: "s3"; bucket: string; prefix: string };
   233: 
   234: export type BackupConfig = {
   235:     enabled: boolean;
   236:     targets: BackupTarget[];
   237:     schedule: "hourly" | "daily" | "weekly" | "cron";
   238:     cronExpr: string;
   239:     retentionDays: number | "";
   240:     encrypt: boolean;
   241:     destination: BackupDestination;
   242: };
   243: 
   244: export type BackupHistoryRow = {
   245:     id: string;
   246:     at: string;
   247:     status: "success" | "running" | "failed";
   248:     note?: string;
   249: };
   250: 
   251: // ===== Email Templates =====
   252: export type TemplateKey = "invite" | "password_reset" | "alert";
   253: export type Template = { subject: string; body: string };
   254: 
   255: // ===== Audit types =====
   256: export type AuditCategory = "security" | "role" | "user" | "auth" | "email" | "device" | "system";
   257: export type AuditSeverity = "info" | "warning" | "error";
   258: export type AuditLog = {
   259:     id: string;
   260:     at: string;
   261:     category: AuditCategory;
   262:     severity: AuditSeverity;
   263:     actor: string;
   264:     action: string;
   265:     details?: string;
   266: };
   267: 
   268: // ===== API tab types =====
   269: export type ApiKeyScope =
   270:     | "read:devices"
   271:     | "write:devices"
   272:     | "read:users"
   273:     | "write:users"
   274:     | "read:audit"
   275:     | "admin:roles"
   276:     | "admin:flags";
   277: 
   278: export type ApiKeyRow = {
   279:     id: string;
   280:     label: string;
   281:     prefix: string;
   282:     scopes: ApiKeyScope[];
   283:     rateLimitRpm?: number;
   284:     lastUsedAt?: string;
   285:     createdAt: string;
   286:     type: "personal" | "service";
   287:     ipAllowlist?: string[];
   288: };
   289: 
   290: // ===== Branding / Appearance =====
   291: export type BrandingSettings = {
   292:     primaryColor: string;
   293:     secondaryColor: string;
   294:     emailHeader: string;
   295:     emailFooter: string;
   296:     customCss: string;
   297:     allowClientThemeToggle: boolean;
   298: };
   299: 
   300: // ===== Localization =====
   301: export type LocalizationSettings = {
   302:     language: "en-US" | "en-GB" | "es-ES" | "fr-FR";
   303:     dateFormat: "MM/DD/YYYY" | "DD/MM/YYYY" | "YYYY-MM-DD";
   304:     timeFormat: "12h" | "24h";
   305:     numberFormat: "1,234.56" | "1.234,56";
   306:     timeZone: string;
   307:     firstDayOfWeek: "sunday" | "monday";
   308: };
   309: 
   310: // ===== Notifications =====
   311: export type NotificationChannel = "email" | "sms" | "slack" | "teams" | "push";
   312: export type NotificationRule = {
   313:     id: string;
   314:     event: string;
   315:     severity: "info" | "warning" | "error" | "critical";
   316:     channels: NotificationChannel[];
   317:     recipients: string;
   318:     enabled: boolean;
   319: };
   320: 
   321: // ===== Security Policies =====
   322: export type SecurityPolicySettings = {
   323:     passwordMinLength: number | "";
   324:     passwordRequireNumbers: boolean;
   325:     passwordRequireSpecial: boolean;
   326:     passwordRequireUppercase: boolean;
   327:     passwordHistory: number | "";
   328:     sessionTimeoutMins: number | "";
   329:     idleLockMins: number | "";
   330:     ipAllowlist: string;
   331:     enableCaptcha: boolean;
   332: };
   333: 
   334: // ===== Integrations =====
   335: export type Integration = {
   336:     id: "slack" | "teams" | "jira" | "servicenow" | "zendesk";
   337:     name: string;
   338:     connected: boolean;
   339: };
   340: 
   341: // ===== Subscription & Licensing =====
   342: export type SubscriptionInfo = {
   343:     plan: string;
   344:     seatsUsed: number;
   345:     seatsTotal: number;
   346:     renewalDate: string;
   347:     licenseKey: string;
   348: };
   349: 
   350: // ===== Client Portal =====
   351: export type ClientPortalSettings = {
   352:     enabledModules: ("dashboard" | "tickets" | "devices" | "invoices" | "reports")[];
   353:     showSla: boolean;
   354:     contactMethods: ("email" | "phone" | "portal")[];
   355: };
   356: 

----------------------------------------------------------------------------------------------------
File: remoteiq-frontend\app\administration\tabs\UsersTab.tsx
Size: 110,567 bytes    Modified: 11/7/2025 12:27:01 AM
----------------------------------------------------------------------------------------------------
     1: // app/administration/tabs/UsersTab.tsx
     2: "use client";
     3: 
     4: import * as React from "react";
     5: import {
     6:     Card,
     7:     CardHeader,
     8:     CardTitle,
     9:     CardDescription,
    10:     CardContent,
    11: } from "@/components/ui/card";
    12: import { Button } from "@/components/ui/button";
    13: import { Input } from "@/components/ui/input";
    14: import { TabsContent } from "@/components/ui/tabs";
    15: import { Checkbox } from "@/components/ui/checkbox";
    16: import {
    17:     Select,
    18:     SelectTrigger,
    19:     SelectContent,
    20:     SelectItem,
    21:     SelectValue,
    22: } from "@/components/ui/select";
    23: import {
    24:     DropdownMenu,
    25:     DropdownMenuTrigger,
    26:     DropdownMenuContent,
    27:     DropdownMenuItem,
    28:     DropdownMenuLabel,
    29:     DropdownMenuSeparator,
    30:     DropdownMenuShortcut,
    31: } from "@/components/ui/dropdown-menu";
    32: import { Badge } from "@/components/ui/badge";
    33: import {
    34:     UserPlus,
    35:     Trash2,
    36:     Search,
    37:     Lock,
    38:     Shield,
    39:     MoreVertical,
    40:     ArrowUpDown,
    41:     Download,
    42:     Filter,
    43:     Upload,
    44:     Link as LinkIcon,
    45:     Plus,
    46:     UserCog,
    47:     Power,
    48:     Copy as CopyIcon,
    49:     Settings as SettingsIcon,
    50:     RefreshCw,
    51:     Eye,       // ← added
    52:     EyeOff,    // ← added
    53: } from "lucide-react";
    54: import {
    55:     Dialog,
    56:     DialogContent,
    57:     DialogHeader,
    58:     DialogTitle,
    59:     DialogDescription,
    60:     DialogFooter,
    61: } from "@/components/ui/dialog";
    62: import { Textarea } from "@/components/ui/textarea";
    63: import type { Role, User } from "../types";
    64: import type { ToastFn } from "../types";
    65: 
    66: import {
    67:     inviteUsers,
    68:     updateUserRole as apiUpdateUserRole,
    69:     resetUser2FA as apiResetUser2FA,
    70:     removeUser as apiRemoveUser,
    71:     createAdminUser,
    72:     setUserPassword,
    73:     setUserSuspended,
    74:     updateUser as apiUpdateUser,
    75: } from "@/lib/api";
    76: 
    77: import { Workbook } from "exceljs";
    78: import { useVirtualizer } from "@tanstack/react-virtual";
    79: 
    80: const NO_ROLE = "__none__";
    81: const uuidRegex =
    82:     /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    83: function isUuid(v: unknown): v is string {
    84:     return typeof v === "string" && uuidRegex.test(v);
    85: }
    86: 
    87: const safeStr = (v: unknown) => (typeof v === "string" ? v : "");
    88: const safeBool = (v: unknown) => (typeof v === "boolean" ? v : false);
    89: 
    90: type RoleSummary = { id: string; name: string };
    91: 
    92: const normalizeRoleSummaries = (roles: unknown): RoleSummary[] => {
    93:     if (!Array.isArray(roles)) return [];
    94:     return roles
    95:         .map((r) => ({
    96:             id: typeof r?.id === "string" ? r.id : null,
    97:             name: typeof r?.name === "string" ? r.name.trim() : "",
    98:         }))
    99:         .filter((r): r is RoleSummary => Boolean(r.id) && Boolean(r.name));
   100: };
   101: 
   102: const getPrimaryRoleId = (u: Partial<User>): string | null => {
   103:     const direct = typeof (u as any)?.roleId === "string" ? ((u as any).roleId as string) : null;
   104:     if (direct && direct.length) return direct;
   105:     const roles = normalizeRoleSummaries((u as any)?.roles);
   106:     if (roles.length > 0) return roles[0].id;
   107:     return null;
   108: };
   109: 
   110: const getPrimaryRoleName = (u: Partial<User>): string => {
   111:     const direct = safeStr((u as any)?.role);
   112:     if (direct) return direct;
   113:     const roles = normalizeRoleSummaries((u as any)?.roles);
   114:     return roles.length > 0 ? roles[0].name : "";
   115: };
   116: 
   117: const userHasRoleFilter = (u: Partial<User>, filter: string): boolean => {
   118:     if (filter === NO_ROLE) {
   119:         return !getPrimaryRoleId(u) && !getPrimaryRoleName(u);
   120:     }
   121:     const directId = getPrimaryRoleId(u);
   122:     if (directId && directId === filter) return true;
   123:     const summaries = normalizeRoleSummaries((u as any)?.roles);
   124:     if (summaries.some((r) => r.id === filter || r.name === filter)) return true;
   125:     const directName = getPrimaryRoleName(u);
   126:     return Boolean(directName) && directName === filter;
   127: };
   128: 
   129: const updateUserRoleMetadata = (user: User, roleId: string | null, catalog: Role[]): User => {
   130:     if (!roleId) {
   131:         return {
   132:             ...user,
   133:             role: "",
   134:             roleId: null,
   135:             roles: [],
   136:         };
   137:     }
   138: 
   139:     const catalogMatch = catalog.find((r) => r.id === roleId);
   140:     const name = catalogMatch?.name ?? getPrimaryRoleName(user);
   141:     return {
   142:         ...user,
   143:         role: name,
   144:         roleId,
   145:         roles: catalogMatch ? [{ id: catalogMatch.id, name: catalogMatch.name }] : user.roles,
   146:     };
   147: };
   148: 
   149: const resolveRoleSelection = (
   150:     value: string | undefined,
   151:     catalog: Role[],
   152: ): { id: string | null; name: string } => {
   153:     if (!value || value === NO_ROLE) return { id: null, name: "" };
   154:     if (isUuid(value)) {
   155:         const match = catalog.find((r) => r.id === value);
   156:         return { id: value, name: match?.name ?? "" };
   157:     }
   158:     const match = catalog.find((r) => r.name === value);
   159:     return { id: match?.id ?? null, name: match?.name ?? value };
   160: };
   161: 
   162: type SortKey = "name" | "email" | "role" | "lastSeen";
   163: type SortDir = "asc" | "desc";
   164: 
   165: const PAGE_SIZES = [10, 25, 50, 100] as const;
   166: 
   167: /** Treat DB status=disabled as Suspended in the UI */
   168: function getStatus(u: Partial<User>) {
   169:     const st = (u as any).status as string | undefined;
   170:     if (st === "disabled" || st === "suspended" || (u as any).suspended) return "suspended";
   171:     if (st === "invited") return "invited";
   172:     return "active";
   173: }
   174: type StatusFilter = "all" | "active" | "suspended" | "invited";
   175: 
   176: // CSV helper date (kept for potential custom date fields)
   177: const formatIsoDate = (raw?: string) => {
   178:     if (!raw) return "";
   179:     const d = new Date(raw);
   180:     if (isNaN(d.getTime())) return "";
   181:     const y = d.getFullYear();
   182:     const m = String(d.getMonth() + 1).padStart(2, "0");
   183:     const day = String(d.getDate()).padStart(2, "0");
   184:     return `${y}-${m}-${day}`;
   185: };
   186: 
   187: interface UsersTabProps {
   188:     users: User[];
   189:     setUsers: React.Dispatch<React.SetStateAction<User[]>>;
   190:     roles: Role[];
   191:     push: ToastFn;
   192:     setRemoveUserId: (id: string | null) => void; // kept for compatibility, not used anymore
   193:     setReset2FAUserId: (id: string | null) => void; // legacy prop; no longer needed
   194:     setInviteOpen: (open: boolean) => void;
   195:     refetchUsers?: () => Promise<void>;
   196:     /** Optional localization from Localization tab */
   197:     localization?: {
   198:         language: string;
   199:         dateFormat: string;
   200:         timeZone: string;
   201:     };
   202: }
   203: 
   204: /** Format a date-only string using provided localization (fallbacks included) */
   205: function formatDateOnly(
   206:     iso: string,
   207:     loc?: { language: string; dateFormat: string; timeZone: string }
   208: ): string {
   209:     if (!iso) return "—";
   210:     const d = new Date(iso);
   211:     if (Number.isNaN(d.getTime())) return "—";
   212: 
   213:     const tz = loc?.timeZone;
   214:     const lang = loc?.language;
   215:     const fmt = (loc?.dateFormat || "").toUpperCase();
   216: 
   217:     const parts = new Intl.DateTimeFormat("en-US", {
   218:         timeZone: tz,
   219:         year: "numeric",
   220:         month: "2-digit",
   221:         day: "2-digit",
   222:     }).formatToParts(d);
   223:     const dict = Object.fromEntries(parts.map((p) => [p.type, p.value]));
   224:     const y = dict.year,
   225:         m = dict.month,
   226:         day = dict.day;
   227: 
   228:     switch (fmt) {
   229:         case "MM/DD/YYYY":
   230:             return `${m}/${day}/${y}`;
   231:         case "DD/MM/YYYY":
   232:             return `${day}/${m}/${y}`;
   233:         case "YYYY-MM-DD":
   234:             return `${y}-${m}-${day}`;
   235:         default:
   236:             return new Intl.DateTimeFormat(lang || undefined, {
   237:                 timeZone: tz,
   238:                 dateStyle: "medium",
   239:             }).format(d);
   240:     }
   241: }
   242: 
   243: /** Column config for export (and future column-pickers) */
   244: type ColumnKey =
   245:     | "id"
   246:     | "name"
   247:     | "email"
   248:     | "role"
   249:     | "twoFactorEnabled"
   250:     | "suspended"
   251:     | "status"
   252:     | "lastSeen"
   253:     | "phone"
   254:     | "address1"
   255:     | "address2"
   256:     | "city"
   257:     | "state"
   258:     | "postal"
   259:     | "country";
   260: 
   261: const ALL_COLUMNS: {
   262:     key: ColumnKey;
   263:     label: string;
   264:     getter: (u: User, loc?: UsersTabProps["localization"]) => string;
   265: }[] = [
   266:         { key: "id", label: "ID", getter: (u) => safeStr((u as any).id) },
   267:         { key: "name", label: "Name", getter: (u) => safeStr((u as any).name) },
   268:         { key: "email", label: "Email", getter: (u) => safeStr((u as any).email) },
   269:         { key: "role", label: "Role", getter: (u) => getPrimaryRoleName(u) },
   270:         {
   271:             key: "twoFactorEnabled",
   272:             label: "2FA Enabled",
   273:             getter: (u) => (safeBool((u as any).twoFactorEnabled) ? "true" : "false"),
   274:         },
   275:         {
   276:             key: "suspended",
   277:             label: "Suspended",
   278:             getter: (u) => (getStatus(u) === "suspended" ? "true" : "false"),
   279:         },
   280:         { key: "status", label: "Status", getter: (u) => safeStr((u as any).status ?? "") },
   281:         {
   282:             key: "lastSeen",
   283:             label: "Last Seen (Date)",
   284:             getter: (u, loc) => {
   285:                 const raw =
   286:                     safeStr((u as any).lastSeen) ||
   287:                     safeStr((u as any).updatedAt) ||
   288:                     safeStr((u as any).createdAt);
   289:                 return raw ? formatDateOnly(raw, loc) : "";
   290:             },
   291:         },
   292:         { key: "phone", label: "Phone", getter: (u) => safeStr((u as any).phone) },
   293:         { key: "address1", label: "Address 1", getter: (u) => safeStr((u as any).address1) },
   294:         { key: "address2", label: "Address 2", getter: (u) => safeStr((u as any).address2) },
   295:         { key: "city", label: "City", getter: (u) => safeStr((u as any).city) },
   296:         { key: "state", label: "State/Region", getter: (u) => safeStr((u as any).state) },
   297:         { key: "postal", label: "Postal", getter: (u) => safeStr((u as any).postal) },
   298:         { key: "country", label: "Country", getter: (u) => safeStr((u as any).country) },
   299:     ];
   300: 
   301: /** Sanitize to avoid Excel/CSV formula injection */
   302: const sanitizeCell = (v: unknown) => {
   303:     let s = v == null ? "" : String(v);
   304:     if (/^[=+\-@]/.test(s)) s = "'" + s;
   305:     return s;
   306: };
   307: 
   308: /** Excel export with auto-sized columns (exceljs) */
   309: async function exportXlsx(
   310:     rows: User[],
   311:     columns: ColumnKey[],
   312:     loc?: UsersTabProps["localization"]
   313: ) {
   314:     const cols = ALL_COLUMNS.filter((c) => columns.includes(c.key));
   315: 
   316:     const wb = new Workbook();
   317:     const ws = wb.addWorksheet("Users");
   318: 
   319:     // Set columns with headers
   320:     ws.columns = cols.map((c) => ({
   321:         header: c.label,
   322:         key: c.key,
   323:         width: Math.max(10, c.label.length + 2),
   324:     })) as any;
   325: 
   326:     // Add rows
   327:     rows.forEach((u) => {
   328:         const record: Record<string, string> = {};
   329:         cols.forEach((c) => {
   330:             record[c.key] = sanitizeCell(c.getter(u, loc));
   331:         });
   332:         ws.addRow(record);
   333:     });
   334: 
   335:     // Auto-size columns by content
   336:     (ws.columns || []).forEach((col: any) => {
   337:         let max = col.header ? String(col.header).length : 10;
   338:         col.eachCell({ includeEmpty: true }, (cell: any) => {
   339:             const v = cell.value == null ? "" : String(cell.value);
   340:             if (v.length > max) max = v.length;
   341:         });
   342:         col.width = Math.min(Math.max(max + 2, 8), 60);
   343:     });
   344: 
   345:     // Download
   346:     const buffer = await wb.xlsx.writeBuffer();
   347:     const blob = new Blob([buffer], {
   348:         type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
   349:     });
   350:     const url = URL.createObjectURL(blob);
   351:     const a = document.createElement("a");
   352:     a.href = url;
   353:     a.download = "users.xlsx";
   354:     a.click();
   355:     URL.revokeObjectURL(url);
   356: }
   357: 
   358: /** CSV export (custom columns + scope) */
   359: function exportCsv(
   360:     rows: User[],
   361:     columns: ColumnKey[],
   362:     loc?: UsersTabProps["localization"]
   363: ) {
   364:     const cols = ALL_COLUMNS.filter((c) => columns.includes(c.key));
   365:     const headers = cols.map((c) => c.label).join(",");
   366:     const lines = rows.map((u) =>
   367:         cols
   368:             .map((c) => {
   369:                 const v = sanitizeCell(c.getter(u, loc));
   370:                 const needsQuote = /[",\n]/.test(v);
   371:                 const escaped = v.replaceAll('"', '""');
   372:                 return needsQuote ? `"${escaped}"` : escaped;
   373:             })
   374:             .join(",")
   375:     );
   376:     const blob = new Blob([headers + "\n" + lines.join("\n")], {
   377:         type: "text/csv;charset=utf-8",
   378:     });
   379:     const url = URL.createObjectURL(blob);
   380:     const a = document.createElement("a");
   381:     a.href = url;
   382:     a.download = "users.csv";
   383:     a.click();
   384:     URL.revokeObjectURL(url);
   385: }
   386: 
   387: export default function UsersTab({
   388:     users,
   389:     setUsers,
   390:     roles,
   391:     push,
   392:     setRemoveUserId, // kept but unused (replaced by local confirm dialog)
   393:     setReset2FAUserId, // legacy prop; no longer used
   394:     setInviteOpen,
   395:     refetchUsers,
   396:     localization,
   397: }: UsersTabProps) {
   398:     /** Loading / sync state */
   399:     const [syncing, setSyncing] = React.useState(false);
   400:     const refreshFromServer = React.useCallback(
   401:         async (toastOnSuccess = false) => {
   402:             if (!refetchUsers) return;
   403:             setSyncing(true);
   404:             try {
   405:                 await refetchUsers();
   406:                 if (toastOnSuccess) push({ title: "Users synced", kind: "success" });
   407:             } catch (e: any) {
   408:                 push({
   409:                     title: "Refresh failed",
   410:                     desc: e?.message ?? "Request failed",
   411:                     kind: "destructive",
   412:                 });
   413:             } finally {
   414:                 setSyncing(false);
   415:             }
   416:         },
   417:         [refetchUsers, push]
   418:     );
   419: 
   420:     /** Filters/search/sort/pagination */
   421:     const [rawQuery, setRawQuery] = React.useState("");
   422:     const [query, setQuery] = React.useState("");
   423:     const [roleFilter, setRoleFilter] = React.useState<string>("all");
   424:     const [statusFilter, setStatusFilter] = React.useState<StatusFilter>("all");
   425:     const [sortKey, setSortKey] = React.useState<SortKey>("name");
   426:     const [sortDir, setSortDir] = React.useState<SortDir>("asc");
   427:     const [pageSize, setPageSize] = React.useState<(typeof PAGE_SIZES)[number]>(25);
   428:     const [page, setPage] = React.useState(1);
   429: 
   430:     /** Selection state for bulk actions */
   431:     const [selected, setSelected] = React.useState<Record<string, boolean>>({});
   432: 
   433:     /** Invite modals */
   434:     const [inviteOpen, setInviteOpenLocal] = React.useState(false);
   435:     const [bulkInviteOpen, setBulkInviteOpen] = React.useState(false);
   436: 
   437:     /** Create / Password / Edit modals */
   438:     const [createOpen, setCreateOpen] = React.useState(false);
   439:     const [pwdUserId, setPwdUserId] = React.useState<string | null>(null);
   440:     const [editUser, setEditUser] = React.useState<User | null>(null);
   441: 
   442:     /** Remove user confirmation (new) */
   443:     const [removeDialogUser, setRemoveDialogUser] = React.useState<User | null>(null);
   444:     const [removing, setRemoving] = React.useState(false);
   445: 
   446:     /** Export config dialog */
   447:     const [exportOpen, setExportOpen] = React.useState(false);
   448:     const [exportFormat, setExportFormat] = React.useState<"xlsx" | "csv">("xlsx");
   449:     const [exportScope, setExportScope] = React.useState<"selected" | "filtered" | "all">(
   450:         "filtered"
   451:     );
   452:     const [exportColumns, setExportColumns] = React.useState<ColumnKey[]>(
   453:         ALL_COLUMNS.map((c) => c.key)
   454:     );
   455: 
   456:     /** Virtualization */
   457:     const [virtualize, setVirtualize] = React.useState(false);
   458:     const tableParentRef = React.useRef<HTMLDivElement | null>(null);
   459: 
   460:     /** Per-row busy state for actions */
   461:     const [busyRow, setBusyRow] = React.useState<Record<string, boolean>>({});
   462: 
   463:     /** Debounce search input */
   464:     React.useEffect(() => {
   465:         const t = setTimeout(() => setQuery(rawQuery.trim().toLowerCase()), 180);
   466:         return () => clearTimeout(t);
   467:     }, [rawQuery]);
   468: 
   469:     React.useEffect(() => {
   470:         setSelected({});
   471:     }, [users]);
   472: 
   473:     const filtered = React.useMemo(() => {
   474:         let list = users.slice();
   475: 
   476:         if (query) {
   477:             list = list.filter(
   478:                 (u) =>
   479:                     safeStr(u.name).toLowerCase().includes(query) ||
   480:                     safeStr(u.email).toLowerCase().includes(query)
   481:             );
   482:         }
   483: 
   484:         if (roleFilter !== "all") {
   485:             list = list.filter((u) => userHasRoleFilter(u, roleFilter));
   486:         }
   487: 
   488:         if (statusFilter !== "all") {
   489:             list = list.filter((u) => getStatus(u) === statusFilter);
   490:         }
   491: 
   492:         list.sort((a, b) => {
   493:             const getStr = (x: any, key: SortKey) =>
   494:                 key === "name"
   495:                     ? safeStr(x.name)
   496:                     : key === "email"
   497:                         ? safeStr(x.email)
   498:                         : key === "role"
   499:                             ? getPrimaryRoleName(x)
   500:                             : safeStr(x.lastSeen ?? "");
   501: 
   502:             if (sortKey === "lastSeen") {
   503:                 const ta = Date.parse(
   504:                     (a as any).lastSeen || (a as any).updatedAt || (a as any).createdAt || 0
   505:                 );
   506:                 const tb = Date.parse(
   507:                     (b as any).lastSeen || (b as any).updatedAt || (b as any).createdAt || 0
   508:                 );
   509:                 return sortDir === "asc" ? ta - tb : tb - ta;
   510:             }
   511: 
   512:             const av = getStr(a, sortKey);
   513:             const bv = getStr(b, sortKey);
   514:             return sortDir === "asc"
   515:                 ? av.localeCompare(bv, undefined, { sensitivity: "base" })
   516:                 : bv.localeCompare(av, undefined, { sensitivity: "base" });
   517:         });
   518: 
   519:         return list;
   520:     }, [users, query, roleFilter, statusFilter, sortKey, sortDir]);
   521: 
   522:     const total = filtered.length;
   523:     const totalPages = Math.max(1, Math.ceil(total / pageSize));
   524:     const pageSafe = Math.min(page, totalPages);
   525:     const start = (pageSafe - 1) * pageSize;
   526:     const current = filtered.slice(start, start + pageSize);
   527: 
   528:     const toggleSort = (key: SortKey) => {
   529:         if (key === sortKey) setSortDir((d) => (d === "asc" ? "desc" : "asc"));
   530:         else {
   531:             setSortKey(key);
   532:             setSortDir("asc");
   533:         }
   534:     };
   535: 
   536:     const allOnPageSelected =
   537:         (virtualize ? filtered : current).length > 0 &&
   538:         (virtualize ? filtered : current).every((u) => selected[u.id ?? ""] === true);
   539: 
   540:     const toggleSelectAllPage = (on: boolean) => {
   541:         const next = { ...selected };
   542:         (virtualize ? filtered : current).forEach((u) => {
   543:             if (u.id) next[u.id] = on;
   544:         });
   545:         setSelected(next);
   546:     };
   547: 
   548:     const clearSelection = () => setSelected({});
   549: 
   550:     const selectedIds = React.useMemo(
   551:         () => Object.entries(selected).filter(([, v]) => v).map(([id]) => id),
   552:         [selected]
   553:     );
   554: 
   555:     const roleToSelectValue = (user: Partial<User>) => {
   556:         const primaryId = getPrimaryRoleId(user);
   557:         if (primaryId) return primaryId;
   558:         const name = getPrimaryRoleName(user);
   559:         return name && name.length > 0 ? name : NO_ROLE;
   560:     };
   561: 
   562:     const updateRole = async (userId: string, roleSelection: string) => {
   563:         if (!isUuid(userId)) {
   564:             push({
   565:                 title: "Invalid user id",
   566:                 desc: "Cannot update role for a user without a valid id.",
   567:                 kind: "destructive",
   568:             });
   569:             return;
   570:         }
   571:         const resolved = resolveRoleSelection(roleSelection, roles);
   572:         const roleToSend = roleSelection === NO_ROLE ? "" : resolved.id ?? roleSelection;
   573:         try {
   574:             await apiUpdateUserRole(userId, roleToSend);
   575:             setUsers((prev) =>
   576:                 prev.map((u) => {
   577:                     if (u.id !== userId) return u;
   578:                     if (roleSelection === NO_ROLE) {
   579:                         return updateUserRoleMetadata(u, null, roles);
   580:                     }
   581:                     if (resolved.id) {
   582:                         return updateUserRoleMetadata(u, resolved.id, roles);
   583:                     }
   584:                     return {
   585:                         ...u,
   586:                         role: resolved.name || roleToSend,
   587:                         roleId: null,
   588:                         roles: resolved.name
   589:                             ? [{ id: roleToSend, name: resolved.name }]
   590:                             : u.roles,
   591:                     };
   592:                 })
   593:             );
   594:             push({ title: "Role updated", kind: "success" });
   595:             await refreshFromServer(false);
   596:         } catch (e: any) {
   597:             push({
   598:                 title: "Failed to update role",
   599:                 desc: e?.message,
   600:                 kind: "destructive",
   601:             });
   602:         }
   603:     };
   604: 
   605:     const bulkRemove = async () => {
   606:         if (selectedIds.length === 0) return;
   607:         try {
   608:             await Promise.all(selectedIds.map((id) => apiRemoveUser(id)));
   609:             setUsers((prev) => prev.filter((u) => !selectedIds.includes(u.id)));
   610:             clearSelection();
   611:             push({
   612:                 title: `Removed ${selectedIds.length} user${selectedIds.length > 1 ? "s" : ""}`,
   613:                 kind: "success",
   614:             });
   615:             await refreshFromServer(false);
   616:         } catch (e: any) {
   617:             push({
   618:                 title: "Failed to remove some users",
   619:                 desc: e?.message,
   620:                 kind: "destructive",
   621:             });
   622:         }
   623:     };
   624: 
   625:     const bulkReset2FA = async () => {
   626:         if (selectedIds.length === 0) return;
   627:         try {
   628:             await Promise.all(selectedIds.map((id) => apiResetUser2FA(id)));
   629:             // Optimistically mark 2FA as disabled for selected
   630:             setUsers((prev) =>
   631:                 prev.map((u) =>
   632:                     u.id && selectedIds.includes(u.id)
   633:                         ? ({ ...u, twoFactorEnabled: false } as User)
   634:                         : u
   635:                 )
   636:             );
   637:         } catch (e: any) {
   638:             push({
   639:                 title: "Failed to reset 2FA for some users",
   640:                 desc: e?.message,
   641:                 kind: "destructive",
   642:             });
   643:         } finally {
   644:             clearSelection();
   645:             push({ title: `2FA reset for ${selectedIds.length}`, kind: "success" });
   646:             await refreshFromServer(false);
   647:         }
   648:     };
   649: 
   650:     /** ---- INVITE HELPERS ---- */
   651:     async function sendInvites(payload: {
   652:         invites: Array<{ name?: string; email: string; role?: string; message?: string }>;
   653:     }) {
   654:         try {
   655:             const res = await inviteUsers(
   656:                 payload.invites.map((i) => ({
   657:                     ...i,
   658:                     role: i.role === NO_ROLE ? undefined : i.role,
   659:                 }))
   660:             );
   661: 
   662:             const rawCreated = (res as any)?.created ?? [];
   663:             const invalidCount = rawCreated.filter((i: any) => !isUuid(i?.id)).length;
   664:             const created = rawCreated.filter((i: any) => isUuid(i?.id));
   665: 
   666:             if (invalidCount > 0) {
   667:                 push({
   668:                     title: "Some invites returned no id",
   669:                     desc: `${invalidCount} entr${invalidCount === 1 ? "y" : "ies"} skipped until the server returns real IDs.`,
   670:                     kind: "warning",
   671:                 });
   672:             }
   673: 
   674:             const createdUsers: User[] = created.map((i: any) => {
   675:                 const serverSummaries = normalizeRoleSummaries(i.roles);
   676:                 const primaryRoleId =
   677:                     typeof i.roleId === "string" && i.roleId.length
   678:                         ? i.roleId
   679:                         : serverSummaries[0]?.id ?? null;
   680:                 const primaryRoleName = safeStr(i.role) || serverSummaries[0]?.name || "";
   681:                 const fallback = resolveRoleSelection(primaryRoleId ?? i.role, roles);
   682:                 const summaries = serverSummaries.length
   683:                     ? serverSummaries
   684:                     : fallback.id && fallback.name
   685:                         ? [{ id: fallback.id, name: fallback.name }]
   686:                         : [];
   687: 
   688:                 return {
   689:                     id: i.id,
   690:                     name: i.name,
   691:                     email: i.email,
   692:                     role: primaryRoleName || fallback.name,
   693:                     roleId: primaryRoleId ?? fallback.id ?? null,
   694:                     roles: summaries,
   695:                     status: i.status ?? "invited",
   696:                     twoFactorEnabled: Boolean(i.twoFactorEnabled ?? false),
   697:                     lastSeen: i.lastSeen ?? "",
   698:                     createdAt: i.createdAt ?? new Date().toISOString(),
   699:                     updatedAt: i.updatedAt ?? new Date().toISOString(),
   700:                 };
   701:             });
   702: 
   703:             if (createdUsers.length > 0) {
   704:                 // optimistic add, then authoritative refresh
   705:                 setUsers((prev) => [...createdUsers, ...prev]);
   706:                 push({
   707:                     title: `Invitation${createdUsers.length > 1 ? "s" : ""} sent`,
   708:                     desc: `${createdUsers.length} recipient${createdUsers.length > 1 ? "s" : ""}`,
   709:                     kind: "success",
   710:                 });
   711:                 await refreshFromServer(false);
   712:             }
   713:         } catch (e: any) {
   714:             const newUsers: User[] = payload.invites.map((i) => {
   715:                 const meta = resolveRoleSelection(i.role, roles);
   716:                 return {
   717:                     id: crypto.randomUUID(),
   718:                     name: i.name || i.email.split("@")[0],
   719:                     email: i.email,
   720:                     role: meta.name,
   721:                     roleId: meta.id,
   722:                     roles: meta.id && meta.name ? [{ id: meta.id, name: meta.name }] : [],
   723:                     // @ts-ignore
   724:                     status: "invited",
   725:                     // @ts-ignore
   726:                     twoFactorEnabled: false,
   727:                     // @ts-ignore
   728:                     suspended: false,
   729:                     // @ts-ignore
   730:                     lastSeen: "",
   731:                 };
   732:             });
   733:             setUsers((prev) => [...newUsers, ...prev]);
   734:             push({
   735:                 title: `Invites queued (offline)`,
   736:                 desc: (e?.message as string) || "Backend not reachable—optimistic add only.",
   737:                 kind: "warning",
   738:             });
   739:         }
   740:     }
   741: 
   742:     const copyGenericInviteLink = async () => {
   743:         const link = `${location.origin}/invite/join`;
   744:         await navigator.clipboard.writeText(link);
   745:         push({ title: "Invite link copied", desc: link, kind: "success" });
   746:     };
   747: 
   748:     const handleSuspendToggle = async (u: User) => {
   749:         if (!isUuid(u.id)) {
   750:             push({
   751:                 title: "Invalid user id",
   752:                 desc: "Cannot update status without a valid id.",
   753:                 kind: "destructive",
   754:             });
   755:             return;
   756:         }
   757:         const suspending = getStatus(u) !== "suspended";
   758:         const id = u.id;
   759: 
   760:         // optimistic UI (we keep using "suspended" in the UI; backend stores "disabled")
   761:         // optimistic — write what the DB expects
   762:         setUsers((prev) =>
   763:             prev.map((x) =>
   764:                 x.id === id ? { ...x, status: suspending ? "disabled" : "active" } : x
   765:             )
   766:         );
   767: 
   768:         setBusyRow((b) => ({ ...b, [id]: true }));
   769:         try {
   770:             await setUserSuspended(id, suspending);
   771:             push({
   772:                 title: suspending ? "User suspended" : "User unsuspended",
   773:                 kind: "success",
   774:             });
   775:             await refreshFromServer(false);
   776:         } catch (e: any) {
   777:             // revert on failure
   778:             setUsers((prev) =>
   779:                 prev.map((x) =>
   780:                     x.id === id ? { ...x, status: suspending ? "active" : "disabled" } : x
   781:                 )
   782:             );
   783: 
   784:             push({
   785:                 title: "Failed to update status",
   786:                 desc: e?.message,
   787:                 kind: "destructive",
   788:             });
   789:         } finally {
   790:             setBusyRow((b) => ({ ...b, [id]: false }));
   791:         }
   792:     };
   793: 
   794:     /** ====== Export helpers ====== */
   795:     const datasetByScope = React.useCallback(
   796:         (scope: "selected" | "filtered" | "all") => {
   797:             if (scope === "selected" && selectedIds.length > 0) {
   798:                 const set = new Set(selectedIds);
   799:                 return users.filter((u) => u.id && set.has(u.id));
   800:             }
   801:             if (scope === "all") return users;
   802:             return filtered; // "filtered"
   803:         },
   804:         [users, filtered, selectedIds]
   805:     );
   806: 
   807:     const runExport = async () => {
   808:         const rows = datasetByScope(exportScope);
   809:         if (rows.length === 0) {
   810:             push({ title: "Nothing to export", kind: "warning" });
   811:             return;
   812:         }
   813:         if (exportFormat === "xlsx") {
   814:             await exportXlsx(rows, exportColumns, localization);
   815:         } else {
   816:             exportCsv(rows, exportColumns, localization);
   817:         }
   818:         setExportOpen(false);
   819:     };
   820: 
   821:     const copyEmails = async () => {
   822:         const rows =
   823:             selectedIds.length > 0
   824:                 ? datasetByScope("selected")
   825:                 : datasetByScope("filtered");
   826:         const emails = rows.map((u) => safeStr((u as any).email)).filter(Boolean);
   827:         if (emails.length === 0) {
   828:             push({ title: "No emails found", kind: "warning" });
   829:             return;
   830:         }
   831:         await navigator.clipboard.writeText(emails.join("\n"));
   832:         push({ title: `Copied ${emails.length} email${emails.length > 1 ? "s" : ""}`, kind: "success" });
   833:     };
   834: 
   835:     // Virtualizer (only when enabled; uses filtered rows, ignores pagination)
   836:     const rowVirtualizer = useVirtualizer({
   837:         count: virtualize ? filtered.length : 0,
   838:         getScrollElement: () => tableParentRef.current,
   839:         estimateSize: () => 48, // row height estimate
   840:         overscan: 12,
   841:     });
   842:     const virtualItems = virtualize ? rowVirtualizer.getVirtualItems() : [];
   843: 
   844:     /** ====== UI ====== */
   845:     return (
   846:         <TabsContent value="users" className="mt-0">
   847:             <Card>
   848:                 <CardHeader>
   849:                     <CardTitle>User Management</CardTitle>
   850:                     <CardDescription>
   851:                         Invite, create, search, filter, and manage members. Bulk actions make it easy to operate at scale.
   852:                     </CardDescription>
   853:                 </CardHeader>
   854: 
   855:                 <CardContent className="space-y-4">
   856:                     {/* Toolbar */}
   857:                     <div className="flex flex-wrap items-center justify-between gap-2">
   858:                         <div className="flex flex-wrap items-center gap-2">
   859:                             <div className="relative w-64">
   860:                                 <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" aria-hidden="true" />
   861:                                 <Input
   862:                                     aria-label="Search users"
   863:                                     value={rawQuery}
   864:                                     onChange={(e) => {
   865:                                         setRawQuery(e.target.value);
   866:                                         setPage(1);
   867:                                     }}
   868:                                     placeholder="Search name or email…"
   869:                                     className="pl-8"
   870:                                 />
   871:                             </div>
   872: 
   873:                             <Filter className="h-4 w-4 text-muted-foreground" />
   874: 
   875:                             {/* Role filter */}
   876:                             <Select
   877:                                 value={roleFilter}
   878:                                 onValueChange={(v) => {
   879:                                     setRoleFilter(v);
   880:                                     setPage(1);
   881:                                 }}
   882:                             >
   883:                                 <SelectTrigger className="w-44 h-9" aria-label="Filter by role">
   884:                                     <SelectValue placeholder="Role" />
   885:                                 </SelectTrigger>
   886:                                 <SelectContent>
   887:                                     <SelectItem value="all">All roles</SelectItem>
   888:                                     <SelectItem value={NO_ROLE}>(No role)</SelectItem>
   889:                                     {roles.map((r) => (
   890:                                         <SelectItem key={r.id} value={r.id}>
   891:                                             {r.name}
   892:                                         </SelectItem>
   893:                                     ))}
   894:                                 </SelectContent>
   895:                             </Select>
   896: 
   897:                             {/* Status filter */}
   898:                             <Select
   899:                                 value={statusFilter}
   900:                                 onValueChange={(v: StatusFilter) => {
   901:                                     setStatusFilter(v);
   902:                                     setPage(1);
   903:                                 }}
   904:                             >
   905:                                 <SelectTrigger className="w-44 h-9" aria-label="Filter by status">
   906:                                     <SelectValue placeholder="Status" />
   907:                                 </SelectTrigger>
   908:                                 <SelectContent>
   909:                                     <SelectItem value="all">All statuses</SelectItem>
   910:                                     <SelectItem value="active">Active</SelectItem>
   911:                                     <SelectItem value="invited">Invited</SelectItem>
   912:                                     <SelectItem value="suspended">Suspended</SelectItem>
   913:                                 </SelectContent>
   914:                             </Select>
   915:                         </div>
   916: 
   917:                         {/* Right side: export + copy + virtualize + sync + create/invite */}
   918:                         <div className="flex items-center gap-2">
   919:                             <Button
   920:                                 variant="outline"
   921:                                 onClick={() => setExportOpen(true)}
   922:                                 title="Export (configure scope & columns)"
   923:                             >
   924:                                 <SettingsIcon className="mr-2 h-4 w-4" aria-hidden="true" />
   925:                                 Export…
   926:                             </Button>
   927: 
   928:                             <Button variant="outline" onClick={copyEmails} title="Copy emails (selected if any, else filtered)">
   929:                                 <CopyIcon className="mr-2 h-4 w-4" aria-hidden="true" />
   930:                                 Copy emails
   931:                             </Button>
   932: 
   933:                             <div className="flex items-center gap-2 border rounded-md px-2 py-1">
   934:                                 <Checkbox
   935:                                     id="virtualize-toggle"
   936:                                     checked={virtualize}
   937:                                     onCheckedChange={(v) => setVirtualize(Boolean(v))}
   938:                                 />
   939:                                 <label htmlFor="virtualize-toggle" className="text-xs cursor-pointer">
   940:                                     Virtualize (ignore pagination)
   941:                                 </label>
   942:                             </div>
   943: 
   944:                             <Button
   945:                                 variant="outline"
   946:                                 onClick={() => refreshFromServer(true)}
   947:                                 disabled={syncing || !refetchUsers}
   948:                                 title="Sync with server"
   949:                             >
   950:                                 <RefreshCw className={`mr-2 h-4 w-4 ${syncing ? "animate-spin" : ""}`} />
   951:                                 Sync
   952:                             </Button>
   953: 
   954:                             <Button onClick={() => setCreateOpen(true)}>
   955:                                 <Plus className="mr-2 h-4 w-4" aria-hidden="true" />
   956:                                 New user
   957:                             </Button>
   958: 
   959:                             {/* Invite menu */}
   960:                             <DropdownMenu>
   961:                                 <DropdownMenuTrigger asChild>
   962:                                     <Button>
   963:                                         <UserPlus className="mr-2 h-4 w-4" aria-hidden="true" />
   964:                                         Invite
   965:                                     </Button>
   966:                                 </DropdownMenuTrigger>
   967:                                 <DropdownMenuContent align="end" className="w-60">
   968:                                     <DropdownMenuLabel>Invite users</DropdownMenuLabel>
   969:                                     <DropdownMenuItem onClick={() => setInviteOpenLocal(true)}>
   970:                                         <UserPlus className="mr-2 h-4 w-4" />
   971:                                         Invite single user
   972:                                         <DropdownMenuShortcut>Enter</DropdownMenuShortcut>
   973:                                     </DropdownMenuItem>
   974:                                     <DropdownMenuItem onClick={() => setBulkInviteOpen(true)}>
   975:                                         <Upload className="mr-2 h-4 w-4" />
   976:                                         Bulk invite (paste emails)
   977:                                     </DropdownMenuItem>
   978:                                     <DropdownMenuSeparator />
   979:                                     <DropdownMenuItem onClick={copyGenericInviteLink}>
   980:                                         <LinkIcon className="mr-2 h-4 w-4" />
   981:                                         Copy invite link
   982:                                     </DropdownMenuItem>
   983:                                 </DropdownMenuContent>
   984:                             </DropdownMenu>
   985:                         </div>
   986:                     </div>
   987: 
   988:                     {/* Bulk bar */}
   989:                     {selectedIds.length > 0 && (
   990:                         <div className="flex flex-wrap items-center justify-between gap-2 rounded-md border p-2">
   991:                             <div className="text-sm">
   992:                                 <strong>{selectedIds.length}</strong> selected
   993:                             </div>
   994:                             <div className="flex items-center gap-2">
   995:                                 <Button variant="outline" size="sm" onClick={bulkReset2FA}>
   996:                                     <Shield className="mr-2 h-4 w-4" aria-hidden="true" />
   997:                                     Reset 2FA
   998:                                 </Button>
   999:                                 <Button variant="destructive" size="sm" onClick={bulkRemove}>
  1000:                                     <Trash2 className="mr-2 h-4 w-4" aria-hidden="true" />
  1001:                                     Remove
  1002:                                 </Button>
  1003:                                 <Button variant="ghost" size="sm" onClick={clearSelection}>
  1004:                                     Clear selection
  1005:                                 </Button>
  1006:                             </div>
  1007:                         </div>
  1008:                     )}
  1009: 
  1010:                     {/* Table */}
  1011:                     <div className="rounded-md border overflow-hidden">
  1012:                         {/* Header */}
  1013:                         <div className="grid grid-cols-[40px_1.2fr_1.2fr_0.9fr_0.9fr_100px] bg-muted/30 p-2 text-xs font-medium text-muted-foreground">
  1014:                             <div className="px-2">
  1015:                                 <Checkbox
  1016:                                     checked={allOnPageSelected}
  1017:                                     onCheckedChange={(v) => toggleSelectAllPage(Boolean(v))}
  1018:                                     aria-label="Select all on page"
  1019:                                 />
  1020:                             </div>
  1021: 
  1022:                             <HeaderCell
  1023:                                 label="Name"
  1024:                                 active={sortKey === "name"}
  1025:                                 dir={sortDir}
  1026:                                 onClick={() => toggleSort("name")}
  1027:                             />
  1028:                             <HeaderCell
  1029:                                 label="Email"
  1030:                                 active={sortKey === "email"}
  1031:                                 dir={sortDir}
  1032:                                 onClick={() => toggleSort("email")}
  1033:                             />
  1034:                             <HeaderCell
  1035:                                 label="Role"
  1036:                                 active={sortKey === "role"}
  1037:                                 dir={sortDir}
  1038:                                 onClick={() => toggleSort("role")}
  1039:                             />
  1040:                             <HeaderCell
  1041:                                 label="Last seen"
  1042:                                 active={sortKey === "lastSeen"}
  1043:                                 dir={sortDir}
  1044:                                 onClick={() => toggleSort("lastSeen")}
  1045:                             />
  1046: 
  1047:                             <div className="px-2 text-right">Actions</div>
  1048:                         </div>
  1049: 
  1050:                         {/* Rows - virtualized OR paginated */}
  1051:                         {virtualize ? (
  1052:                             <div
  1053:                                 ref={tableParentRef}
  1054:                                 className="relative h-[600px] overflow-auto"
  1055:                             >
  1056:                                 <div
  1057:                                     style={{ height: rowVirtualizer.getTotalSize() }}
  1058:                                     className="relative"
  1059:                                 >
  1060:                                     {virtualItems.length === 0 && (
  1061:                                         <div className="p-8 text-center text-sm text-muted-foreground">
  1062:                                             {filtered.length === 0
  1063:                                                 ? "No users match your filters."
  1064:                                                 : "Loading…"}
  1065:                                         </div>
  1066:                                     )}
  1067:                                     {virtualItems.map((vi) => {
  1068:                                         const u = filtered[vi.index];
  1069:                                         const id = safeStr(u.id);
  1070:                                         const tf = safeBool((u as any).twoFactorEnabled);
  1071:                                         const status = getStatus(u);
  1072:                                         const suspended = status === "suspended";
  1073:                                         const lastSeenIso =
  1074:                                             safeStr((u as any).lastSeen) ||
  1075:                                             safeStr((u as any).updatedAt) ||
  1076:                                             safeStr((u as any).createdAt);
  1077:                                         const canEditRole = isUuid(id);
  1078: 
  1079:                                         const rowBusy = !!busyRow[id];
  1080: 
  1081:                                         return (
  1082:                                             <div
  1083:                                                 key={id || vi.index}
  1084:                                                 className="grid grid-cols-[40px_1.2fr_1.2fr_0.9fr_0.9fr_100px] items-center border-t p-2 gap-2"
  1085:                                                 style={{
  1086:                                                     position: "absolute",
  1087:                                                     top: 0,
  1088:                                                     left: 0,
  1089:                                                     width: "100%",
  1090:                                                     transform: `translateY(${vi.start}px)`,
  1091:                                                 }}
  1092:                                             >
  1093:                                                 <div className="px-2">
  1094:                                                     <Checkbox
  1095:                                                         checked={selected[id] ?? false}
  1096:                                                         onCheckedChange={(v) =>
  1097:                                                             setSelected((prev) => ({
  1098:                                                                 ...prev,
  1099:                                                                 [id]: Boolean(v),
  1100:                                                             }))
  1101:                                                         }
  1102:                                                         aria-label={`Select ${u.name}`}
  1103:                                                     />
  1104:                                                 </div>
  1105: 
  1106:                                                 {/* Name + badges */}
  1107:                                                 <div className="px-2 min-w-0">
  1108:                                                     <div className="flex items-center gap-2">
  1109:                                                         <div className="truncate" title={u.name}>
  1110:                                                             {u.name}
  1111:                                                         </div>
  1112:                                                         {tf && <Badge variant="outline">2FA</Badge>}
  1113:                                                         {status === "invited" && (
  1114:                                                             <Badge variant="secondary">Invited</Badge>
  1115:                                                         )}
  1116:                                                         {suspended && (
  1117:                                                             <Badge variant="destructive">Suspended</Badge>
  1118:                                                         )}
  1119:                                                     </div>
  1120:                                                 </div>
  1121: 
  1122:                                                 {/* Email */}
  1123:                                                 <div className="px-2 text-muted-foreground truncate" title={u.email}>
  1124:                                                     {u.email}
  1125:                                                 </div>
  1126: 
  1127:                                                 {/* Role */}
  1128:                                                 <div className="px-2 relative z-10">
  1129:                                                     <Select
  1130:                                                         value={roleToSelectValue(u)}
  1131:                                                         onValueChange={(v) => canEditRole && updateRole(id, v)}
  1132:                                                         disabled={!canEditRole || rowBusy}
  1133:                                                     >
  1134:                                                         <SelectTrigger className="h-8" aria-label="Change role">
  1135:                                                             <SelectValue placeholder={canEditRole ? "Role" : "No id"} />
  1136:                                                         </SelectTrigger>
  1137:                                                         <SelectContent>
  1138:                                                             <SelectItem value={NO_ROLE}>(No role)</SelectItem>
  1139:                                                             {roles.map((r) => (
  1140:                                                                 <SelectItem key={r.id} value={r.id}>
  1141:                                                                     {r.name}
  1142:                                                                 </SelectItem>
  1143:                                                             ))}
  1144:                                                         </SelectContent>
  1145:                                                     </Select>
  1146:                                                 </div>
  1147: 
  1148:                                                 {/* Last seen */}
  1149:                                                 <div className="px-2 text-muted-foreground truncate" title={lastSeenIso || "No data"}>
  1150:                                                     {lastSeenIso ? formatDateOnly(lastSeenIso, localization) : "—"}
  1151:                                                 </div>
  1152: 
  1153:                                                 {/* Actions */}
  1154:                                                 <div className="px-2 flex items-center justify-end gap-1">
  1155:                                                     <RowActions
  1156:                                                         disabled={rowBusy}
  1157:                                                         onEdit={() => setEditUser(u)}
  1158:                                                         onResetPassword={() => setPwdUserId(isUuid(id) ? id : null)}
  1159:                                                         onReset2FA={async () => {
  1160:                                                             if (!isUuid(id)) {
  1161:                                                                 push({ title: "Invalid user id", kind: "destructive" });
  1162:                                                                 return;
  1163:                                                             }
  1164:                                                             setBusyRow((b) => ({ ...b, [id]: true }));
  1165:                                                             try {
  1166:                                                                 push({ title: "Resetting 2FA…", kind: "default" });
  1167:                                                                 await apiResetUser2FA(id);
  1168:                                                                 push({ title: "2FA reset", kind: "success" });
  1169:                                                                 await refreshFromServer(false);
  1170:                                                             } catch (e: any) {
  1171:                                                                 push({ title: "Failed to reset 2FA", desc: e?.message, kind: "destructive" });
  1172:                                                             } finally {
  1173:                                                                 setBusyRow((b) => ({ ...b, [id]: false }));
  1174:                                                             }
  1175:                                                         }}
  1176:                                                         onSuspendToggle={() => handleSuspendToggle(u)}
  1177:                                                         suspended={suspended}
  1178:                                                         onRemove={() => setRemoveDialogUser(u)}
  1179:                                                     />
  1180:                                                 </div>
  1181:                                             </div>
  1182:                                         );
  1183:                                     })}
  1184:                                 </div>
  1185:                             </div>
  1186:                         ) : current.length === 0 ? (
  1187:                             <div className="p-8 text-center text-sm text-muted-foreground">
  1188:                                 {users.length === 0
  1189:                                     ? "No users yet. Create or invite your first teammate."
  1190:                                     : "No users match your filters."}
  1191:                             </div>
  1192:                         ) : (
  1193:                             current.map((u) => {
  1194:                                 const id = safeStr(u.id);
  1195:                                 const tf = safeBool((u as any).twoFactorEnabled);
  1196:                                 const status = getStatus(u);
  1197:                                 const suspended = status === "suspended";
  1198:                                 const lastSeenIso =
  1199:                                     safeStr((u as any).lastSeen) ||
  1200:                                     safeStr((u as any).updatedAt) ||
  1201:                                     safeStr((u as any).createdAt);
  1202:                                 const canEditRole = isUuid(id);
  1203:                                 const roleSummaries = normalizeRoleSummaries((u as any).roles);
  1204:                                 const primaryRoleId = getPrimaryRoleId(u);
  1205:                                 const extraRoles = roleSummaries.filter((r, idx) =>
  1206:                                     primaryRoleId ? r.id !== primaryRoleId : idx > 0,
  1207:                                 );
  1208:                                 const rowBusy = !!busyRow[id];
  1209: 
  1210:                                 return (
  1211:                                     <div
  1212:                                         key={id}
  1213:                                         className="grid grid-cols-[40px_1.2fr_1.2fr_0.9fr_0.9fr_100px] items-center border-t p-2 gap-2"
  1214:                                     >
  1215:                                         <div className="px-2">
  1216:                                             <Checkbox
  1217:                                                 checked={selected[id] ?? false}
  1218:                                                 onCheckedChange={(v) =>
  1219:                                                     setSelected((prev) => ({
  1220:                                                         ...prev,
  1221:                                                         [id]: Boolean(v),
  1222:                                                     }))
  1223:                                                 }
  1224:                                                 aria-label={`Select ${u.name}`}
  1225:                                             />
  1226:                                         </div>
  1227: 
  1228:                                         {/* Name + badges */}
  1229:                                         <div className="px-2 min-w-0">
  1230:                                             <div className="flex items-center gap-2">
  1231:                                                 <div className="truncate" title={u.name}>
  1232:                                                     {u.name}
  1233:                                                 </div>
  1234:                                                 {tf && <Badge variant="outline">2FA</Badge>}
  1235:                                                 {status === "invited" && (
  1236:                                                     <Badge variant="secondary">Invited</Badge>
  1237:                                                 )}
  1238:                                                 {suspended && (
  1239:                                                     <Badge variant="destructive">Suspended</Badge>
  1240:                                                 )}
  1241:                                             </div>
  1242:                                         </div>
  1243: 
  1244:                                         {/* Email */}
  1245:                                         <div className="px-2 text-muted-foreground truncate" title={u.email}>
  1246:                                             {u.email}
  1247:                                         </div>
  1248: 
  1249:                                         {/* Role */}
  1250:                                         <div className="px-2 relative z-10">
  1251:                                             <Select
  1252:                                                 value={roleToSelectValue(u)}
  1253:                                                 onValueChange={(v) => canEditRole && updateRole(id, v)}
  1254:                                                 disabled={!canEditRole || rowBusy}
  1255:                                             >
  1256:                                                 <SelectTrigger className="h-8" aria-label="Change role">
  1257:                                                     <SelectValue placeholder={canEditRole ? "Role" : "No id"} />
  1258:                                                 </SelectTrigger>
  1259:                                                 <SelectContent>
  1260:                                                     <SelectItem value={NO_ROLE}>(No role)</SelectItem>
  1261:                                                     {roles.map((r) => (
  1262:                                                         <SelectItem key={r.id} value={r.id}>
  1263:                                                             {r.name}
  1264:                                                         </SelectItem>
  1265:                                                     ))}
  1266:                                                 </SelectContent>
  1267:                                             </Select>
  1268:                                             {extraRoles.length > 0 && (
  1269:                                                 <div className="mt-1 flex flex-wrap gap-1 text-xs text-muted-foreground">
  1270:                                                     {extraRoles.map((r) => (
  1271:                                                         <Badge key={r.id} variant="outline">
  1272:                                                             {r.name}
  1273:                                                         </Badge>
  1274:                                                     ))}
  1275:                                                 </div>
  1276:                                             )}
  1277:                                         </div>
  1278: 
  1279:                                         {/* Last seen */}
  1280:                                         <div className="px-2 text-muted-foreground truncate" title={lastSeenIso || "No data"}>
  1281:                                             {lastSeenIso ? formatDateOnly(lastSeenIso, localization) : "—"}
  1282:                                         </div>
  1283: 
  1284:                                         {/* Actions */}
  1285:                                         <div className="px-2 flex items-center justify-end gap-1">
  1286:                                             <RowActions
  1287:                                                 disabled={rowBusy}
  1288:                                                 onEdit={() => setEditUser(u)}
  1289:                                                 onResetPassword={() => setPwdUserId(isUuid(id) ? id : null)}
  1290:                                                 onReset2FA={async () => {
  1291:                                                     if (!isUuid(id)) {
  1292:                                                         push({ title: "Invalid user id", kind: "destructive" });
  1293:                                                         return;
  1294:                                                     }
  1295:                                                     setBusyRow((b) => ({ ...b, [id]: true }));
  1296:                                                     try {
  1297:                                                         push({ title: "Resetting 2FA…", kind: "default" });
  1298:                                                         await apiResetUser2FA(id);
  1299:                                                         push({ title: "2FA reset", kind: "success" });
  1300:                                                         await refreshFromServer(false);
  1301:                                                     } catch (e: any) {
  1302:                                                         push({ title: "Failed to reset 2FA", desc: e?.message, kind: "destructive" });
  1303:                                                     } finally {
  1304:                                                         setBusyRow((b) => ({ ...b, [id]: false }));
  1305:                                                     }
  1306:                                                 }}
  1307:                                                 onSuspendToggle={() => handleSuspendToggle(u)}
  1308:                                                 suspended={suspended}
  1309:                                                 onRemove={() => setRemoveDialogUser(u)}
  1310:                                             />
  1311:                                         </div>
  1312:                                     </div>
  1313:                                 );
  1314:                             })
  1315:                         )}
  1316:                     </div>
  1317: 
  1318:                     {/* Footer: pagination (hidden when virtualized) */}
  1319:                     {!virtualize && (
  1320:                         <div className="flex flex-wrap items-center justify-between gap-2">
  1321:                             <div className="text-xs text-muted-foreground">
  1322:                                 Showing <strong>{current.length}</strong> of <strong>{total}</strong>
  1323:                             </div>
  1324: 
  1325:                             <div className="flex items-center gap-3">
  1326:                                 <div className="flex items-center gap-2">
  1327:                                     <span className="text-xs text-muted-foreground">Rows:</span>
  1328:                                     <Select
  1329:                                         value={String(pageSize)}
  1330:                                         onValueChange={(v) => {
  1331:                                             setPageSize(Number(v) as (typeof PAGE_SIZES)[number]);
  1332:                                             setPage(1);
  1333:                                         }}
  1334:                                     >
  1335:                                         <SelectTrigger className="w-[88px] h-8">
  1336:                                             <SelectValue />
  1337:                                         </SelectTrigger>
  1338:                                         <SelectContent>
  1339:                                             {PAGE_SIZES.map((n) => (
  1340:                                                 <SelectItem key={n} value={String(n)}>
  1341:                                                     {n}
  1342:                                                 </SelectItem>
  1343:                                             ))}
  1344:                                         </SelectContent>
  1345:                                     </Select>
  1346:                                 </div>
  1347: 
  1348:                                 <div className="flex items-center gap-1">
  1349:                                     <Button
  1350:                                         variant="outline"
  1351:                                         size="sm"
  1352:                                         onClick={() => setPage(1)}
  1353:                                         disabled={pageSafe === 1}
  1354:                                     >
  1355:                                         «
  1356:                                     </Button>
  1357:                                     <Button
  1358:                                         variant="outline"
  1359:                                         size="sm"
  1360:                                         onClick={() => setPage((p) => Math.max(1, p - 1))}
  1361:                                         disabled={pageSafe === 1}
  1362:                                     >
  1363:                                         ‹
  1364:                                     </Button>
  1365:                                     <div className="px-2 text-sm min-w-[80px] text-center">
  1366:                                         Page {pageSafe} / {totalPages}
  1367:                                     </div>
  1368:                                     <Button
  1369:                                         variant="outline"
  1370:                                         size="sm"
  1371:                                         onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
  1372:                                         disabled={pageSafe === totalPages}
  1373:                                     >
  1374:                                         ›
  1375:                                     </Button>
  1376:                                     <Button
  1377:                                         variant="outline"
  1378:                                         size="sm"
  1379:                                         onClick={() => setPage(totalPages)}
  1380:                                         disabled={pageSafe === totalPages}
  1381:                                     >
  1382:                                         »
  1383:                                     </Button>
  1384:                                 </div>
  1385:                             </div>
  1386:                         </div>
  1387:                     )}
  1388: 
  1389:                     {/* subtle syncing indicator */}
  1390:                     {syncing && (
  1391:                         <div className="text-xs text-muted-foreground flex items-center gap-2 pl-1">
  1392:                             <RefreshCw className="h-3.5 w-3.5 animate-spin" />
  1393:                             Syncing…
  1394:                         </div>
  1395:                     )}
  1396:                 </CardContent>
  1397:             </Card>
  1398: 
  1399:             {/* Create User Modal */}
  1400:             <CreateUserDialog
  1401:                 open={createOpen}
  1402:                 onOpenChange={setCreateOpen}
  1403:                 roles={roles}
  1404:                 onSubmit={async (form) => {
  1405:                     try {
  1406:                         const { id } = await createAdminUser({
  1407:                             name: form.name,
  1408:                             email: form.email,
  1409:                             role: form.role === NO_ROLE ? undefined : form.role,
  1410:                             password: form.password,
  1411:                             status: "active",
  1412:                         });
  1413: 
  1414:                         const roleMeta = resolveRoleSelection(form.role, roles);
  1415: 
  1416:                         // optimistic add
  1417:                         setUsers((prev) => [
  1418:                             {
  1419:                                 id,
  1420:                                 name: form.name,
  1421:                                 email: form.email,
  1422:                                 role: roleMeta.name,
  1423:                                 roleId: roleMeta.id,
  1424:                                 roles:
  1425:                                     roleMeta.id && roleMeta.name
  1426:                                         ? [{ id: roleMeta.id, name: roleMeta.name }]
  1427:                                         : [],
  1428:                                 // @ts-ignore
  1429:                                 status: "active",
  1430:                                 // @ts-ignore
  1431:                                 twoFactorEnabled: false,
  1432:                                 // @ts-ignore
  1433:                                 suspended: false,
  1434:                                 // @ts-ignore
  1435:                                 lastSeen: "",
  1436:                             } as unknown as User,
  1437:                             ...prev,
  1438:                         ]);
  1439: 
  1440:                         push({ title: "User created", kind: "success" });
  1441:                         setCreateOpen(false);
  1442:                         await refreshFromServer(false);
  1443:                     } catch (e: any) {
  1444:                         push({
  1445:                             title: "Failed to create user",
  1446:                             desc: e?.message,
  1447:                             kind: "destructive",
  1448:                         });
  1449:                     }
  1450:                 }}
  1451:             />
  1452: 
  1453:             {/* Set Password Modal */}
  1454:             <SetPasswordDialog
  1455:                 open={!!pwdUserId}
  1456:                 onOpenChange={(o) => {
  1457:                     if (!o) setPwdUserId(null);
  1458:                 }}
  1459:                 onSubmit={async (password) => {
  1460:                     const id = pwdUserId;
  1461:                     if (!id || !isUuid(id)) {
  1462:                         push({
  1463:                             title: "Invalid user id",
  1464:                             desc: "Cannot set password without a valid id.",
  1465:                             kind: "destructive",
  1466:                         });
  1467:                         return;
  1468:                     }
  1469:                     try {
  1470:                         await setUserPassword(id, password);
  1471:                         push({ title: "Password updated", kind: "success" });
  1472:                         setPwdUserId(null);
  1473:                     } catch (e: any) {
  1474:                         push({
  1475:                             title: "Failed to set password",
  1476:                             desc: e?.message,
  1477:                             kind: "destructive",
  1478:                         });
  1479:                     }
  1480:                 }}
  1481:             />
  1482: 
  1483:             {/* Edit User Modal */}
  1484:             <EditUserDialog
  1485:                 open={!!editUser}
  1486:                 onOpenChange={(o) => {
  1487:                     if (!o) setEditUser(null);
  1488:                 }}
  1489:                 user={editUser}
  1490:                 roles={roles}
  1491:                 onSubmit={async (form) => {
  1492:                     if (!editUser || !isUuid(editUser.id)) {
  1493:                         push({
  1494:                             title: "Invalid user id",
  1495:                             desc: "Cannot edit without a valid id.",
  1496:                             kind: "destructive",
  1497:                         });
  1498:                         return;
  1499:                     }
  1500:                     const userId = editUser.id;
  1501: 
  1502:                     // Build a raw patch, then strip undefined/empty-string
  1503:                     const rawPatch: Partial<User> = {
  1504:                         name: form.name,
  1505:                         email: form.email,
  1506:                         role: form.role === NO_ROLE ? undefined : form.role,
  1507:                         phone: form.phone,
  1508:                         address1: form.address1,
  1509:                         address2: form.address2,
  1510:                         city: form.city,
  1511:                         state: form.state,
  1512:                         postal: form.postal,
  1513:                         country: form.country,
  1514:                     };
  1515:                     const payload = Object.fromEntries(
  1516:                         Object.entries(rawPatch).filter(
  1517:                             ([, v]) => v !== undefined && String(v).trim() !== ""
  1518:                         )
  1519:                     ) as Partial<User>;
  1520: 
  1521:                     // optimistic
  1522:                     const resolvedRole = resolveRoleSelection(form.role, roles);
  1523:                     const removingRole = form.role === NO_ROLE;
  1524:                     setUsers((prev) =>
  1525:                         prev.map((u) => {
  1526:                             if (u.id !== userId) return u;
  1527:                             const next = { ...u, ...payload } as User;
  1528:                             if (removingRole) {
  1529:                                 return updateUserRoleMetadata(next, null, roles);
  1530:                             }
  1531:                             if (resolvedRole.id) {
  1532:                                 return updateUserRoleMetadata(next, resolvedRole.id, roles);
  1533:                             }
  1534:                             if (resolvedRole.name) {
  1535:                                 return {
  1536:                                     ...next,
  1537:                                     role: resolvedRole.name,
  1538:                                     roleId: null,
  1539:                                 };
  1540:                             }
  1541:                             return next;
  1542:                         })
  1543:                     );
  1544: 
  1545:                     try {
  1546:                         await apiUpdateUser(userId, payload as any);
  1547:                         push({ title: "User updated", kind: "success" });
  1548:                         setEditUser(null);
  1549:                         await refreshFromServer(false);
  1550:                     } catch (e: any) {
  1551:                         push({
  1552:                             title: "Failed to update user",
  1553:                             desc: e?.message,
  1554:                             kind: "destructive",
  1555:                         });
  1556:                         // Let server refresh fix UI if needed
  1557:                         await refreshFromServer(false);
  1558:                     }
  1559:                 }}
  1560:             />
  1561: 
  1562:             {/* Single Invite Modal */}
  1563:             <InviteSingleDialog
  1564:                 open={inviteOpen}
  1565:                 onOpenChange={setInviteOpenLocal}
  1566:                 roles={roles}
  1567:                 onSubmit={async (data) => {
  1568:                     await sendInvites({ invites: [data] });
  1569:                     setInviteOpenLocal(false);
  1570:                 }}
  1571:             />
  1572: 
  1573:             {/* Bulk Invite Modal */}
  1574:             <InviteBulkDialog
  1575:                 open={bulkInviteOpen}
  1576:                 onOpenChange={setBulkInviteOpen}
  1577:                 roles={roles}
  1578:                 onSubmit={async (list) => {
  1579:                     await sendInvites({ invites: list });
  1580:                     setBulkInviteOpen(false);
  1581:                 }}
  1582:             />
  1583: 
  1584:             {/* Export Config Dialog */}
  1585:             <Dialog open={exportOpen} onOpenChange={setExportOpen}>
  1586:                 <DialogContent className="sm:max-w-[720px]">
  1587:                     <DialogHeader>
  1588:                         <DialogTitle>Export users</DialogTitle>
  1589:                         <DialogDescription>
  1590:                             Choose scope, columns, and format.
  1591:                         </DialogDescription>
  1592:                     </DialogHeader>
  1593: 
  1594:                     <div className="grid sm:grid-cols-2 gap-4">
  1595:                         <div className="space-y-3">
  1596:                             <div className="text-sm font-medium">Scope</div>
  1597:                             <div className="space-y-2 text-sm">
  1598:                                 <label className="flex items-center gap-2">
  1599:                                     <input
  1600:                                         type="radio"
  1601:                                         name="export-scope"
  1602:                                         value="selected"
  1603:                                         checked={exportScope === "selected"}
  1604:                                         onChange={() => setExportScope("selected")}
  1605:                                     />
  1606:                                     Selected ({selectedIds.length})
  1607:                                 </label>
  1608:                                 <label className="flex items-center gap-2">
  1609:                                     <input
  1610:                                         type="radio"
  1611:                                         name="export-scope"
  1612:                                         value="filtered"
  1613:                                         checked={exportScope === "filtered"}
  1614:                                         onChange={() => setExportScope("filtered")}
  1615:                                     />
  1616:                                     Filtered ({filtered.length})
  1617:                                 </label>
  1618:                                 <label className="flex items-center gap-2">
  1619:                                     <input
  1620:                                         type="radio"
  1621:                                         name="export-scope"
  1622:                                         value="all"
  1623:                                         checked={exportScope === "all"}
  1624:                                         onChange={() => setExportScope("all")}
  1625:                                     />
  1626:                                     All users ({users.length})
  1627:                                 </label>
  1628:                             </div>
  1629: 
  1630:                             <div className="mt-4">
  1631:                                 <div className="text-sm font-medium mb-2">Format</div>
  1632:                                 <div className="space-y-2 text-sm">
  1633:                                     <label className="flex items-center gap-2">
  1634:                                         <input
  1635:                                             type="radio"
  1636:                                             name="export-format"
  1637:                                             value="xlsx"
  1638:                                             checked={exportFormat === "xlsx"}
  1639:                                             onChange={() => setExportFormat("xlsx")}
  1640:                                         />
  1641:                                         Excel (.xlsx)
  1642:                                     </label>
  1643:                                     <label className="flex items-center gap-2">
  1644:                                         <input
  1645:                                             type="radio"
  1646:                                             name="export-format"
  1647:                                             value="csv"
  1648:                                             checked={exportFormat === "csv"}
  1649:                                             onChange={() => setExportFormat("csv")}
  1650:                                         />
  1651:                                         CSV (.csv)
  1652:                                     </label>
  1653:                                 </div>
  1654:                             </div>
  1655:                         </div>
  1656: 
  1657:                         <div className="space-y-3">
  1658:                             <div className="flex items-center justify-between">
  1659:                                 <div className="text-sm font-medium">Columns</div>
  1660:                                 <Button
  1661:                                     variant="ghost"
  1662:                                     size="sm"
  1663:                                     onClick={() =>
  1664:                                         setExportColumns(
  1665:                                             exportColumns.length === ALL_COLUMNS.length
  1666:                                                 ? []
  1667:                                                 : ALL_COLUMNS.map((c) => c.key)
  1668:                                         )
  1669:                                     }
  1670:                                 >
  1671:                                     {exportColumns.length === ALL_COLUMNS.length ? "Clear all" : "Select all"}
  1672:                                 </Button>
  1673:                             </div>
  1674:                             <div className="grid grid-cols-2 gap-2 max-h-[260px] overflow-auto pr-2">
  1675:                                 {ALL_COLUMNS.map((c) => {
  1676:                                     const checked = exportColumns.includes(c.key);
  1677:                                     return (
  1678:                                         <label key={c.key} className="flex items-center gap-2 text-sm">
  1679:                                             <Checkbox
  1680:                                                 checked={checked}
  1681:                                                 onCheckedChange={(v) => {
  1682:                                                     if (v) setExportColumns((prev) => [...prev, c.key]);
  1683:                                                     else setExportColumns((prev) => prev.filter((k) => k !== c.key));
  1684:                                                 }}
  1685:                                             />
  1686:                                             {c.label}
  1687:                                         </label>
  1688:                                     );
  1689:                                 })}
  1690:                             </div>
  1691:                         </div>
  1692:                     </div>
  1693: 
  1694:                     <DialogFooter className="gap-2">
  1695:                         <Button variant="outline" onClick={() => setExportOpen(false)}>
  1696:                             Cancel
  1697:                         </Button>
  1698:                         <Button
  1699:                             onClick={runExport}
  1700:                             disabled={exportColumns.length === 0}
  1701:                         >
  1702:                             <Download className="mr-2 h-4 w-4" />
  1703:                             Export
  1704:                         </Button>
  1705:                     </DialogFooter>
  1706:                 </DialogContent>
  1707:             </Dialog>
  1708: 
  1709:             {/* Remove User Confirm Dialog (new) */}
  1710:             <Dialog
  1711:                 open={!!removeDialogUser}
  1712:                 onOpenChange={(open) => {
  1713:                     if (!open) setRemoveDialogUser(null);
  1714:                 }}
  1715:             >
  1716:                 <DialogContent>
  1717:                     <DialogHeader>
  1718:                         <DialogTitle>Remove user</DialogTitle>
  1719:                         <DialogDescription>
  1720:                             This will permanently remove the user from your workspace. This action cannot be undone.
  1721:                         </DialogDescription>
  1722:                     </DialogHeader>
  1723: 
  1724:                     <div className="text-sm">
  1725:                         {removeDialogUser && (
  1726:                             <>
  1727:                                 <div className="font-medium">{removeDialogUser.name || "Unnamed user"}</div>
  1728:                                 <div className="text-muted-foreground">{removeDialogUser.email}</div>
  1729:                             </>
  1730:                         )}
  1731:                     </div>
  1732: 
  1733:                     <DialogFooter className="gap-2">
  1734:                         <Button
  1735:                             variant="outline"
  1736:                             onClick={() => setRemoveDialogUser(null)}
  1737:                             disabled={removing}
  1738:                         >
  1739:                             Cancel
  1740:                         </Button>
  1741:                         <Button
  1742:                             variant="destructive"
  1743:                             onClick={async () => {
  1744:                                 if (!removeDialogUser) return;
  1745:                                 const id = removeDialogUser.id;
  1746:                                 if (!isUuid(id)) {
  1747:                                     push({
  1748:                                         title: "Invalid user id",
  1749:                                         desc: "Cannot remove a user without a valid id.",
  1750:                                         kind: "destructive",
  1751:                                     });
  1752:                                     return;
  1753:                                 }
  1754:                                 setRemoving(true);
  1755:                                 try {
  1756:                                     await apiRemoveUser(id);
  1757:                                     setUsers((prev) => prev.filter((u) => u.id !== id));
  1758:                                     push({ title: "User removed", kind: "success" });
  1759:                                     setRemoveDialogUser(null);
  1760:                                     await refreshFromServer(false);
  1761:                                 } catch (e: any) {
  1762:                                     push({
  1763:                                         title: "Failed to remove user",
  1764:                                         desc: e?.message,
  1765:                                         kind: "destructive",
  1766:                                     });
  1767:                                 } finally {
  1768:                                     setRemoving(false);
  1769:                                 }
  1770:                             }}
  1771:                             disabled={removing}
  1772:                         >
  1773:                             {removing ? "Removing…" : "Remove user"}
  1774:                         </Button>
  1775:                     </DialogFooter>
  1776:                 </DialogContent>
  1777:             </Dialog>
  1778:         </TabsContent>
  1779:     );
  1780: }
  1781: 
  1782: function HeaderCell({
  1783:     label,
  1784:     active,
  1785:     dir,
  1786:     onClick,
  1787: }: {
  1788:     label: string;
  1789:     active: boolean;
  1790:     dir: "asc" | "desc";
  1791:     onClick: () => void;
  1792: }) {
  1793:     return (
  1794:         <button
  1795:             type="button"
  1796:             className="px-2 inline-flex items-center gap-1 text-left"
  1797:             onClick={onClick}
  1798:             aria-pressed={active}
  1799:             aria-label={`Sort by ${label}`}
  1800:             title={`Sort by ${label}`}
  1801:         >
  1802:             <span>{label}</span>
  1803:             <ArrowUpDown
  1804:                 className={`h-3.5 w-3.5 ${active ? "opacity-100" : "opacity-40"}`}
  1805:                 aria-hidden="true"
  1806:             />
  1807:             <span className="sr-only">
  1808:                 {dir === "asc" ? "ascending" : "descending"}
  1809:             </span>
  1810:         </button>
  1811:     );
  1812: }
  1813: 
  1814: function RowActions({
  1815:     onEdit,
  1816:     onResetPassword,
  1817:     onReset2FA,
  1818:     onSuspendToggle,
  1819:     suspended,
  1820:     onRemove,
  1821:     disabled,
  1822: }: {
  1823:     onEdit: () => void;
  1824:     onResetPassword: () => void;
  1825:     onReset2FA: () => void;
  1826:     onSuspendToggle: () => void;
  1827:     suspended: boolean;
  1828:     onRemove: () => void;
  1829:     disabled?: boolean;
  1830: }) {
  1831:     return (
  1832:         <DropdownMenu>
  1833:             <DropdownMenuTrigger asChild>
  1834:                 <Button variant="ghost" size="icon" aria-label="Open actions" disabled={disabled}>
  1835:                     <MoreVertical className="h-4 w-4" aria-hidden="true" />
  1836:                 </Button>
  1837:             </DropdownMenuTrigger>
  1838:             <DropdownMenuContent align="end" className="w-56">
  1839:                 <DropdownMenuLabel>Actions</DropdownMenuLabel>
  1840: 
  1841:                 <DropdownMenuItem onClick={onEdit} disabled={disabled}>
  1842:                     <UserCog className="mr-2 h-4 w-4" />
  1843:                     Edit user
  1844:                 </DropdownMenuItem>
  1845: 
  1846:                 <DropdownMenuItem onClick={onResetPassword} disabled={disabled}>
  1847:                     <Lock className="mr-2 h-4 w-4" />
  1848:                     Set password
  1849:                 </DropdownMenuItem>
  1850:                 <DropdownMenuItem onClick={onReset2FA} disabled={disabled}>
  1851:                     <Shield className="mr-2 h-4 w-4" />
  1852:                     Reset 2FA
  1853:                 </DropdownMenuItem>
  1854: 
  1855:                 <DropdownMenuSeparator />
  1856:                 <DropdownMenuItem onClick={onSuspendToggle} disabled={disabled}>
  1857:                     <Power className="mr-2 h-4 w-4" />
  1858:                     {suspended ? "Unsuspend user" : "Suspend user"}
  1859:                 </DropdownMenuItem>
  1860: 
  1861:                 <DropdownMenuSeparator />
  1862:                 <DropdownMenuItem
  1863:                     onClick={onRemove}
  1864:                     className="text-destructive focus:text-destructive"
  1865:                     disabled={disabled}
  1866:                 >
  1867:                     <Trash2 className="mr-2 h-4 w-4" />
  1868:                     Remove user
  1869:                 </DropdownMenuItem>
  1870:             </DropdownMenuContent>
  1871:         </DropdownMenu>
  1872:     );
  1873: }
  1874: 
  1875: /* =========================
  1876:    Create User Dialog
  1877:    ========================= */
  1878: function CreateUserDialog({
  1879:     open,
  1880:     onOpenChange,
  1881:     roles,
  1882:     onSubmit,
  1883: }: {
  1884:     open: boolean;
  1885:     onOpenChange: (v: boolean) => void;
  1886:     roles: Role[];
  1887:     onSubmit: (data: { name: string; email: string; role?: string; password: string }) => Promise<void>;
  1888: }) {
  1889:     const [name, setName] = React.useState("");
  1890:     const [email, setEmail] = React.useState("");
  1891:     const [role, setRole] = React.useState<string>(NO_ROLE);
  1892:     const [password, setPassword] = React.useState("");
  1893:     const [showPwd, setShowPwd] = React.useState(false); // ← added
  1894:     const [submitting, setSubmitting] = React.useState(false);
  1895: 
  1896:     const validEmail = /\S+@\S+\.\S+/.test(email);
  1897:     const validPwd = password.length >= 8;
  1898: 
  1899:     const valid =
  1900:         name.trim().length > 0 &&
  1901:         validEmail &&
  1902:         validPwd &&
  1903:         (role === NO_ROLE ? true : roles.some((r) => r.id === role));
  1904: 
  1905:     const handleSubmit = async () => {
  1906:         if (!valid) return;
  1907:         setSubmitting(true);
  1908:         try {
  1909:             await onSubmit({
  1910:                 name: name.trim(),
  1911:                 email: email.trim(),
  1912:                 role: role === NO_ROLE ? undefined : role,
  1913:                 password,
  1914:             });
  1915:             setName("");
  1916:             setEmail("");
  1917:             setRole(NO_ROLE);
  1918:             setPassword("");
  1919:             setShowPwd(false);
  1920:         } finally {
  1921:             setSubmitting(false);
  1922:         }
  1923:     };
  1924: 
  1925:     return (
  1926:         <Dialog open={open} onOpenChange={onOpenChange}>
  1927:             <DialogContent>
  1928:                 <DialogHeader>
  1929:                     <DialogTitle>New user</DialogTitle>
  1930:                     <DialogDescription>
  1931:                         Create a user and set their initial password.
  1932:                     </DialogDescription>
  1933:                 </DialogHeader>
  1934: 
  1935:                 <div className="grid gap-3">
  1936:                     <div className="grid gap-1">
  1937:                         <label className="text-sm">Full name</label>
  1938:                         <Input value={name} onChange={(e) => setName(e.target.value)} />
  1939:                         {name.trim().length === 0 && (
  1940:                             <div className="text-xs text-red-600">Name is required</div>
  1941:                         )}
  1942:                     </div>
  1943: 
  1944:                     <div className="grid gap-1">
  1945:                         <label className="text-sm">Email</label>
  1946:                         <Input
  1947:                             value={email}
  1948:                             onChange={(e) => setEmail(e.target.value)}
  1949:                             placeholder="name@example.com"
  1950:                         />
  1951:                         {!validEmail && email && (
  1952:                             <div className="text-xs text-red-600">Enter a valid email</div>
  1953:                         )}
  1954:                     </div>
  1955: 
  1956:                     <div className="grid gap-1">
  1957:                         <label className="text-sm">Role</label>
  1958:                         <Select value={role} onValueChange={setRole}>
  1959:                             <SelectTrigger>
  1960:                                 <SelectValue placeholder="Role" />
  1961:                             </SelectTrigger>
  1962:                             <SelectContent>
  1963:                                 <SelectItem value={NO_ROLE}>(No role)</SelectItem>
  1964:                                 {roles.map((r) => (
  1965:                                     <SelectItem key={r.id} value={r.id}>
  1966:                                         {r.name}
  1967:                                     </SelectItem>
  1968:                                 ))}
  1969:                             </SelectContent>
  1970:                         </Select>
  1971:                     </div>
  1972: 
  1973:                     <div className="grid gap-1">
  1974:                         <label className="text-sm">Password</label>
  1975:                         <div className="relative">
  1976:                             <Input
  1977:                                 type={showPwd ? "text" : "password"}
  1978:                                 autoComplete="new-password"
  1979:                                 value={password}
  1980:                                 onChange={(e) => setPassword(e.target.value)}
  1981:                                 placeholder="At least 8 characters"
  1982:                                 className="pr-10"
  1983:                             />
  1984:                             <button
  1985:                                 type="button"
  1986:                                 aria-label={showPwd ? "Hide password" : "Show password"}
  1987:                                 onClick={() => setShowPwd((v) => !v)}
  1988:                                 className="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-muted"
  1989:                             >
  1990:                                 {showPwd ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
  1991:                             </button>
  1992:                         </div>
  1993:                         {!validPwd && password && (
  1994:                             <div className="text-xs text-red-600">Minimum 8 characters</div>
  1995:                         )}
  1996:                     </div>
  1997:                 </div>
  1998: 
  1999:                 <DialogFooter className="gap-2">
  2000:                     <Button variant="outline" onClick={() => onOpenChange(false)}>
  2001:                         Cancel
  2002:                     </Button>
  2003:                     <Button onClick={handleSubmit} disabled={!valid || submitting}>
  2004:                         {submitting ? "Creating…" : "Create user"}
  2005:                     </Button>
  2006:                 </DialogFooter>
  2007:             </DialogContent>
  2008:         </Dialog>
  2009:     );
  2010: }
  2011: 
  2012: /* =========================
  2013:    Set Password Dialog
  2014:    ========================= */
  2015: function SetPasswordDialog({
  2016:     open,
  2017:     onOpenChange,
  2018:     onSubmit,
  2019: }: {
  2020:     open: boolean;
  2021:     onOpenChange: (v: boolean) => void;
  2022:     onSubmit: (password: string) => Promise<void>;
  2023: }) {
  2024:     const [pwd, setPwd] = React.useState("");
  2025:     const [pwd2, setPwd2] = React.useState("");
  2026:     const [submitting, setSubmitting] = React.useState(false);
  2027: 
  2028:     const valid = pwd.length >= 8 && pwd === pwd2;
  2029: 
  2030:     const handleSubmit = async () => {
  2031:         if (!valid) return;
  2032:         setSubmitting(true);
  2033:         try {
  2034:             await onSubmit(pwd);
  2035:             setPwd("");
  2036:             setPwd2("");
  2037:             onOpenChange(false);
  2038:         } finally {
  2039:             setSubmitting(false);
  2040:         }
  2041:     };
  2042: 
  2043:     return (
  2044:         <Dialog open={open} onOpenChange={onOpenChange}>
  2045:             <DialogContent>
  2046:                 <DialogHeader>
  2047:                     <DialogTitle>Set password</DialogTitle>
  2048:                     <DialogDescription>
  2049:                         Replace the user’s password with a new one.
  2050:                     </DialogDescription>
  2051:                 </DialogHeader>
  2052: 
  2053:                 <div className="grid gap-3">
  2054:                     <div className="grid gap-1">
  2055:                         <label className="text-sm">New password</label>
  2056:                         <Input
  2057:                             type="password"
  2058:                             autoComplete="new-password"
  2059:                             value={pwd}
  2060:                             onChange={(e) => setPwd(e.target.value)}
  2061:                             placeholder="At least 8 characters"
  2062:                         />
  2063:                     </div>
  2064:                     <div className="grid gap-1">
  2065:                         <label className="text-sm">Confirm new password</label>
  2066:                         <Input
  2067:                             type="password"
  2068:                             autoComplete="new-password"
  2069:                             value={pwd2}
  2070:                             onChange={(e) => setPwd2(e.target.value)}
  2071:                             placeholder="Re-enter password"
  2072:                         />
  2073:                         {pwd && pwd2 && pwd !== pwd2 && (
  2074:                             <div className="text-xs text-red-600">Passwords do not match</div>
  2075:                         )}
  2076:                     </div>
  2077:                 </div>
  2078: 
  2079:                 <DialogFooter className="gap-2">
  2080:                     <Button variant="outline" onClick={() => onOpenChange(false)}>
  2081:                         Cancel
  2082:                     </Button>
  2083:                     <Button onClick={handleSubmit} disabled={!valid || submitting}>
  2084:                         {submitting ? "Saving…" : "Save password"}
  2085:                     </Button>
  2086:                 </DialogFooter>
  2087:             </DialogContent>
  2088:         </Dialog>
  2089:     );
  2090: }
  2091: 
  2092: /* =========================
  2093:    Edit User Dialog
  2094:    ========================= */
  2095: function EditUserDialog({
  2096:     open,
  2097:     onOpenChange,
  2098:     user,
  2099:     roles,
  2100:     onSubmit,
  2101: }: {
  2102:     open: boolean;
  2103:     onOpenChange: (v: boolean) => void;
  2104:     user: User | null;
  2105:     roles: Role[];
  2106:     onSubmit: (data: {
  2107:         name: string;
  2108:         email: string;
  2109:         role: string;
  2110:         phone?: string;
  2111:         address1?: string;
  2112:         address2?: string;
  2113:         city?: string;
  2114:         state?: string;
  2115:         postal?: string;
  2116:         country?: string;
  2117:     }) => Promise<void>;
  2118: }) {
  2119:     const [name, setName] = React.useState("");
  2120:     const [email, setEmail] = React.useState("");
  2121:     const [role, setRole] = React.useState<string>(NO_ROLE);
  2122:     const [phone, setPhone] = React.useState("");
  2123:     const [address1, setAddress1] = React.useState("");
  2124:     const [address2, setAddress2] = React.useState("");
  2125:     const [city, setCity] = React.useState("");
  2126:     const [state, setState] = React.useState("");
  2127:     const [postal, setPostal] = React.useState("");
  2128:     const [country, setCountry] = React.useState("");
  2129:     const [submitting, setSubmitting] = React.useState(false);
  2130: 
  2131:     React.useEffect(() => {
  2132:         if (!user) return;
  2133:         setName(user.name || "");
  2134:         setEmail(user.email || "");
  2135:         const primaryId = getPrimaryRoleId(user);
  2136:         if (primaryId) {
  2137:             setRole(primaryId);
  2138:         } else {
  2139:             const fallback = resolveRoleSelection(user.role, roles);
  2140:             setRole(fallback.id ?? NO_ROLE);
  2141:         }
  2142:         setPhone((user as any).phone || "");
  2143:         setAddress1((user as any).address1 || "");
  2144:         setAddress2((user as any).address2 || "");
  2145:         setCity((user as any).city || "");
  2146:         setState((user as any).state || "");
  2147:         setPostal((user as any).postal || "");
  2148:         setCountry((user as any).country || "");
  2149:     }, [user, roles]);
  2150: 
  2151:     const validEmail = /\S+@\S+\.\S+/.test(email);
  2152:     const valid =
  2153:         name.trim().length > 0 &&
  2154:         validEmail &&
  2155:         (role === NO_ROLE ? true : roles.some((r) => r.id === role));
  2156: 
  2157:     const handleSubmit = async () => {
  2158:         if (!valid || !user) return;
  2159:         setSubmitting(true);
  2160:         try {
  2161:             await onSubmit({
  2162:                 name: name.trim(),
  2163:                 email: email.trim(),
  2164:                 role,
  2165:                 phone: phone.trim() || undefined,
  2166:                 address1: address1.trim() || undefined,
  2167:                 address2: address2.trim() || undefined,
  2168:                 city: city.trim() || undefined,
  2169:                 state: state.trim() || undefined,
  2170:                 postal: postal.trim() || undefined,
  2171:                 country: country.trim() || undefined,
  2172:             });
  2173:         } finally {
  2174:             setSubmitting(false);
  2175:         }
  2176:     };
  2177: 
  2178:     return (
  2179:         <Dialog open={open} onOpenChange={onOpenChange}>
  2180:             <DialogContent className="sm:max-w-[700px]">
  2181:                 <DialogHeader>
  2182:                     <DialogTitle>Edit user</DialogTitle>
  2183:                     <DialogDescription>
  2184:                         Update basic profile details. Only provided fields are sent to the server.
  2185:                     </DialogDescription>
  2186:                 </DialogHeader>
  2187: 
  2188:                 <div className="grid sm:grid-cols-2 gap-3">
  2189:                     <div className="grid gap-1">
  2190:                         <label className="text-sm">Full name</label>
  2191:                         <Input value={name} onChange={(e) => setName(e.target.value)} />
  2192:                     </div>
  2193: 
  2194:                     <div className="grid gap-1">
  2195:                         <label className="text-sm">Email</label>
  2196:                         <Input
  2197:                             value={email}
  2198:                             onChange={(e) => setEmail(e.target.value)}
  2199:                             placeholder="name@example.com"
  2200:                         />
  2201:                         {!validEmail && email && (
  2202:                             <div className="text-xs text-red-600">Enter a valid email</div>
  2203:                         )}
  2204:                     </div>
  2205: 
  2206:                     <div className="grid gap-1">
  2207:                         <label className="text-sm">Role</label>
  2208:                         <Select value={role} onValueChange={setRole}>
  2209:                             <SelectTrigger>
  2210:                                 <SelectValue placeholder="Role" />
  2211:                             </SelectTrigger>
  2212:                             <SelectContent>
  2213:                                 <SelectItem value={NO_ROLE}>(No role)</SelectItem>
  2214:                                 {roles.map((r) => (
  2215:                                     <SelectItem key={r.id} value={r.id}>
  2216:                                         {r.name}
  2217:                                     </SelectItem>
  2218:                                 ))}
  2219:                             </SelectContent>
  2220:                         </Select>
  2221:                     </div>
  2222: 
  2223:                     <div className="grid gap-1">
  2224:                         <label className="text-sm">Phone</label>
  2225:                         <Input value={phone} onChange={(e) => setPhone(e.target.value)} />
  2226:                     </div>
  2227: 
  2228:                     <div className="grid gap-1">
  2229:                         <label className="text-sm">Address 1</label>
  2230:                         <Input value={address1} onChange={(e) => setAddress1(e.target.value)} />
  2231:                     </div>
  2232: 
  2233:                     <div className="grid gap-1">
  2234:                         <label className="text-sm">Address 2</label>
  2235:                         <Input value={address2} onChange={(e) => setAddress2(e.target.value)} />
  2236:                     </div>
  2237: 
  2238:                     <div className="grid gap-1">
  2239:                         <label className="text-sm">City</label>
  2240:                         <Input value={city} onChange={(e) => setCity(e.target.value)} />
  2241:                     </div>
  2242: 
  2243:                     <div className="grid gap-1">
  2244:                         <label className="text-sm">State / Region</label>
  2245:                         <Input value={state} onChange={(e) => setState(e.target.value)} />
  2246:                     </div>
  2247: 
  2248:                     <div className="grid gap-1">
  2249:                         <label className="text-sm">Postal code</label>
  2250:                         <Input value={postal} onChange={(e) => setPostal(e.target.value)} />
  2251:                     </div>
  2252: 
  2253:                     <div className="grid gap-1">
  2254:                         <label className="text-sm">Country</label>
  2255:                         <Input value={country} onChange={(e) => setCountry(e.target.value)} />
  2256:                     </div>
  2257:                 </div>
  2258: 
  2259:                 <DialogFooter className="gap-2">
  2260:                     <Button variant="outline" onClick={() => onOpenChange(false)}>
  2261:                         Cancel
  2262:                     </Button>
  2263:                     <Button onClick={handleSubmit} disabled={!valid || submitting}>
  2264:                         {submitting ? "Saving…" : "Save changes"}
  2265:                     </Button>
  2266:                 </DialogFooter>
  2267:             </DialogContent>
  2268:         </Dialog>
  2269:     );
  2270: }
  2271: 
  2272: /* =========================
  2273:    Invite Single Dialog
  2274:    ========================= */
  2275: function InviteSingleDialog({
  2276:     open,
  2277:     onOpenChange,
  2278:     roles,
  2279:     onSubmit,
  2280: }: {
  2281:     open: boolean;
  2282:     onOpenChange: (v: boolean) => void;
  2283:     roles: Role[];
  2284:     onSubmit: (data: { name?: string; email: string; role?: string; message?: string }) => Promise<void>;
  2285: }) {
  2286:     const [name, setName] = React.useState("");
  2287:     const [email, setEmail] = React.useState("");
  2288:     const [role, setRole] = React.useState<string>(NO_ROLE);
  2289:     const [message, setMessage] = React.useState("");
  2290:     const [submitting, setSubmitting] = React.useState(false);
  2291: 
  2292:     const valid =
  2293:         /\S+@\S+\.\S+/.test(email) &&
  2294:         (role === NO_ROLE ? true : roles.some((r) => r.id === role));
  2295: 
  2296:     const handleSubmit = async () => {
  2297:         if (!valid) return;
  2298:         setSubmitting(true);
  2299:         try {
  2300:             await onSubmit({
  2301:                 name: name.trim() || undefined,
  2302:                 email: email.trim(),
  2303:                 role: role === NO_ROLE ? undefined : role,
  2304:                 message: message.trim() || undefined,
  2305:             });
  2306:             setName("");
  2307:             setEmail("");
  2308:             setRole(NO_ROLE);
  2309:             setMessage("");
  2310:         } finally {
  2311:             setSubmitting(false);
  2312:         }
  2313:     };
  2314: 
  2315:     return (
  2316:         <Dialog open={open} onOpenChange={onOpenChange}>
  2317:             <DialogContent>
  2318:                 <DialogHeader>
  2319:                     <DialogTitle>Invite user</DialogTitle>
  2320:                     <DialogDescription>
  2321:                         Send a one-time invite email with a sign-up link.
  2322:                     </DialogDescription>
  2323:                 </DialogHeader>
  2324: 
  2325:                 <div className="grid gap-3">
  2326:                     <div className="grid gap-1">
  2327:                         <label className="text-sm">Full name (optional)</label>
  2328:                         <Input value={name} onChange={(e) => setName(e.target.value)} />
  2329:                     </div>
  2330: 
  2331:                     <div className="grid gap-1">
  2332:                         <label className="text-sm">Email</label>
  2333:                         <Input
  2334:                             value={email}
  2335:                             onChange={(e) => setEmail(e.target.value)}
  2336:                             placeholder="name@example.com"
  2337:                         />
  2338:                         {!/\S+@\S+\.\S+/.test(email) && email && (
  2339:                             <div className="text-xs text-red-600">Enter a valid email</div>
  2340:                         )}
  2341:                     </div>
  2342: 
  2343:                     <div className="grid gap-1">
  2344:                         <label className="text-sm">Role</label>
  2345:                         <Select value={role} onValueChange={setRole}>
  2346:                             <SelectTrigger>
  2347:                                 <SelectValue placeholder="Role" />
  2348:                             </SelectTrigger>
  2349:                             <SelectContent>
  2350:                                 <SelectItem value={NO_ROLE}>(No role)</SelectItem>
  2351:                                 {roles.map((r) => (
  2352:                                     <SelectItem key={r.id} value={r.id}>
  2353:                                         {r.name}
  2354:                                     </SelectItem>
  2355:                                 ))}
  2356:                             </SelectContent>
  2357:                         </Select>
  2358:                     </div>
  2359: 
  2360:                     <div className="grid gap-1">
  2361:                         <label className="text-sm">Message (optional)</label>
  2362:                         <Textarea
  2363:                             rows={4}
  2364:                             value={message}
  2365:                             onChange={(e) => setMessage(e.target.value)}
  2366:                             placeholder="Welcome aboard! Here’s your invite…"
  2367:                         />
  2368:                     </div>
  2369:                 </div>
  2370: 
  2371:                 <DialogFooter className="gap-2">
  2372:                     <Button variant="outline" onClick={() => onOpenChange(false)}>
  2373:                         Cancel
  2374:                     </Button>
  2375:                     <Button onClick={handleSubmit} disabled={!valid || submitting}>
  2376:                         {submitting ? "Sending…" : "Send invite"}
  2377:                     </Button>
  2378:                 </DialogFooter>
  2379:             </DialogContent>
  2380:         </Dialog>
  2381:     );
  2382: }
  2383: 
  2384: /* =========================
  2385:    Invite Bulk Dialog
  2386:    ========================= */
  2387: function InviteBulkDialog({
  2388:     open,
  2389:     onOpenChange,
  2390:     roles,
  2391:     onSubmit,
  2392: }: {
  2393:     open: boolean;
  2394:     onOpenChange: (v: boolean) => void;
  2395:     roles: Role[];
  2396:     onSubmit: (
  2397:         list: Array<{ name?: string; email: string; role?: string }>
  2398:     ) => Promise<void>;
  2399: }) {
  2400:     const [emailsBlock, setEmailsBlock] = React.useState("");
  2401:     const [defaultRole, setDefaultRole] = React.useState<string>(NO_ROLE);
  2402:     const [submitting, setSubmitting] = React.useState(false);
  2403: 
  2404:     const parsed = React.useMemo(() => {
  2405:         const out: Array<{ name?: string; email: string; role?: string }> = [];
  2406:         emailsBlock
  2407:             .split(/\r?\n|,|;/g)
  2408:             .map((s) => s.trim())
  2409:             .filter(Boolean)
  2410:             .forEach((token) => {
  2411:                 const m = token.match(/^(.*)<(.+@.+\..+)>$/);
  2412:                 if (m) {
  2413:                     const name = m[1].trim().replace(/^"|"$/g, "");
  2414:                     const email = m[2].trim();
  2415:                     if (/\S+@\S+\.\S+/.test(email))
  2416:                         out.push({
  2417:                             name: name || undefined,
  2418:                             email,
  2419:                             role: defaultRole === NO_ROLE ? undefined : defaultRole,
  2420:                         });
  2421:                 } else if (/\S+@\S+\.\S+/.test(token)) {
  2422:                     out.push({
  2423:                         email: token,
  2424:                         role: defaultRole === NO_ROLE ? undefined : defaultRole,
  2425:                     });
  2426:                 }
  2427:             });
  2428:         return out;
  2429:     }, [emailsBlock, defaultRole]);
  2430: 
  2431:     const handleSubmit = async () => {
  2432:         if (parsed.length === 0) return;
  2433:         setSubmitting(true);
  2434:         try {
  2435:             await onSubmit(parsed);
  2436:             setEmailsBlock("");
  2437:             setDefaultRole(NO_ROLE);
  2438:         } finally {
  2439:             setSubmitting(false);
  2440:         }
  2441:     };
  2442: 
  2443:     return (
  2444:         <Dialog open={open} onOpenChange={onOpenChange}>
  2445:             <DialogContent className="sm:max-w-[640px]">
  2446:                 <DialogHeader>
  2447:                     <DialogTitle>Bulk invite</DialogTitle>
  2448:                     <DialogDescription>
  2449:                         Paste one or more emails (comma/semicolon/newline separated). You can also use{" "}
  2450:                         <code>Name &lt;email@domain&gt;</code> format.
  2451:                     </DialogDescription>
  2452:                 </DialogHeader>
  2453: 
  2454:                 <div className="grid gap-3">
  2455:                     <div className="grid gap-1">
  2456:                         <label className="text-sm">Default role</label>
  2457:                         <Select value={defaultRole} onValueChange={setDefaultRole}>
  2458:                             <SelectTrigger>
  2459:                                 <SelectValue placeholder="Role" />
  2460:                             </SelectTrigger>
  2461:                             <SelectContent>
  2462:                                 <SelectItem value={NO_ROLE}>(No role)</SelectItem>
  2463:                                 {roles.map((r) => (
  2464:                                     <SelectItem key={r.id} value={r.id}>
  2465:                                         {r.name}
  2466:                                     </SelectItem>
  2467:                                 ))}
  2468:                             </SelectContent>
  2469:                         </Select>
  2470:                     </div>
  2471: 
  2472:                     <div className="grid gap-1">
  2473:                         <label className="text-sm">Emails / CSV</label>
  2474:                         <Textarea
  2475:                             rows={8}
  2476:                             value={emailsBlock}
  2477:                             onChange={(e) => setEmailsBlock(e.target.value)}
  2478:                             placeholder={`jane@example.com
  2479: John Smith <john@acme.io>, mia@acme.io; "Alex Q." <alex@acme.io>`}
  2480:                         />
  2481:                         <div className="text-xs text-muted-foreground">
  2482:                             Parsed: <strong>{parsed.length}</strong>{" "}
  2483:                             {parsed.length === 1 ? "recipient" : "recipients"}
  2484:                         </div>
  2485:                     </div>
  2486:                 </div>
  2487: 
  2488:                 <DialogFooter className="gap-2">
  2489:                     <Button variant="outline" onClick={() => onOpenChange(false)}>
  2490:                         Cancel
  2491:                     </Button>
  2492:                     <Button onClick={handleSubmit} disabled={parsed.length === 0 || submitting}>
  2493:                         {submitting
  2494:                             ? "Sending…"
  2495:                             : `Send ${parsed.length} invite${parsed.length === 1 ? "" : "s"}`}
  2496:                     </Button>
  2497:                 </DialogFooter>
  2498:             </DialogContent>
  2499:         </Dialog>
  2500:     );
  2501: }

----------------------------------------------------------------------------------------------------
File: remoteiq-frontend\lib\auth.ts
Size: 445 bytes    Modified: 10/18/2025 8:21:51 PM
----------------------------------------------------------------------------------------------------
     1: // app/lib/auth.ts
     2: export async function getMe() {
     3:     const res = await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/api/auth/me`, {
     4:         credentials: 'include',
     5:     });
     6:     return res.json() as Promise<{ user: null | { id: string; email: string; name: string; role: string } }>;
     7: }
     8: export async function logout() {
     9:     await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/api/auth/logout`, { method: 'POST', credentials: 'include' });
    10: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\auth\policy.ts
Size: 4,415 bytes    Modified: 11/7/2025 11:38:24 AM
----------------------------------------------------------------------------------------------------
     1: // remoteiq-minimal-e2e/backend/src/auth/policy.ts
     2: 
     3: export type PermissionGroup = {
     4:     key: string;
     5:     label: string;
     6:     items: readonly {
     7:         key: string;
     8:         label: string;
     9:         description?: string;
    10:     }[];
    11: };
    12: 
    13: export const PERMISSION_GROUPS = [
    14:     // ── Administration
    15:     {
    16:         key: "administration",
    17:         label: "Administration",
    18:         items: [
    19:             { key: "admin.access", label: "Access admin dashboard", description: "View and access the Administration area." },
    20:         ] as const,
    21:     },
    22: 
    23:     // ── Users
    24:     {
    25:         key: "users",
    26:         label: "Users",
    27:         items: [
    28:             { key: "users.read", label: "View users" },
    29:             { key: "users.write", label: "Create/edit users" },
    30:             { key: "users.delete", label: "Remove users" },
    31:             { key: "users.2fa.reset", label: "Reset 2FA" },
    32:         ] as const,
    33:     },
    34: 
    35:     // ── Roles
    36:     {
    37:         key: "roles",
    38:         label: "Roles",
    39:         items: [
    40:             { key: "roles.read", label: "View roles" },
    41:             { key: "roles.write", label: "Create/edit roles" },
    42:             { key: "roles.delete", label: "Delete roles" },
    43:         ] as const,
    44:     },
    45: 
    46:     // ── Teams
    47:     {
    48:         key: "teams",
    49:         label: "Teams",
    50:         items: [
    51:             { key: "teams.read", label: "View teams" },
    52:             { key: "teams.write", label: "Create/edit teams" },
    53:             { key: "teams.delete", label: "Delete teams" },
    54:         ] as const,
    55:     },
    56: 
    57:     // ── Billing
    58:     {
    59:         key: "billing",
    60:         label: "Billing",
    61:         items: [
    62:             { key: "billing.read", label: "View billing" },
    63:             { key: "billing.write", label: "Manage billing" },
    64:         ] as const,
    65:     },
    66: 
    67:     // ── Settings
    68:     {
    69:         key: "settings",
    70:         label: "Settings",
    71:         items: [
    72:             { key: "settings.read", label: "View settings" },
    73:             { key: "settings.write", label: "Manage settings" },
    74:         ] as const,
    75:     },
    76: 
    77:     // ── Backups
    78:     {
    79:         key: "backups",
    80:         label: "Backups",
    81:         items: [
    82:             { key: "backups.read", label: "View config and history" },
    83:             { key: "backups.run", label: "Start, retry or cancel backups" },
    84:             { key: "backups.prune", label: "Prune artifacts" },
    85:             { key: "backups.manage", label: "Configure/test destinations" },
    86:             { key: "backups.restore", label: "Initiate restores" },
    87:             { key: "backups.download", label: "Download artifacts" },
    88:         ] as const,
    89:     },
    90: ] as const satisfies readonly PermissionGroup[];
    91: 
    92: type PermissionItem = (typeof PERMISSION_GROUPS)[number]["items"][number];
    93: 
    94: export type Permission = PermissionItem["key"];
    95: 
    96: export type PermissionDefinition = PermissionItem & {
    97:     groupKey: string;
    98:     groupLabel: string;
    99: };
   100: 
   101: export const PERMISSION_DEFINITIONS: PermissionDefinition[] =
   102:     PERMISSION_GROUPS.flatMap((group) =>
   103:         group.items.map((item) => ({
   104:             ...item,
   105:             groupKey: group.key,
   106:             groupLabel: group.label,
   107:         })),
   108:     );
   109: 
   110: export const ALL_PERMISSIONS: Permission[] = PERMISSION_DEFINITIONS.map((d) => d.key);
   111: 
   112: // Optional role names if you still use a role -> default-permissions map somewhere
   113: export type Role = "owner" | "admin" | "operator" | "viewer";
   114: 
   115: // Advisory defaults for built-in roles (guards still check req.user permissions).
   116: export const rolePermissions: Record<Role, Permission[]> = {
   117:     owner: [...ALL_PERMISSIONS],
   118:     admin: [...ALL_PERMISSIONS],
   119:     operator: [
   120:         "users.read",
   121:         "roles.read",
   122:         "teams.read",
   123:         "billing.read",
   124:         "settings.read",
   125:         "backups.read",
   126:         "backups.run",
   127:         "backups.download",
   128:     ],
   129:     viewer: [
   130:         "users.read",
   131:         "roles.read",
   132:         "teams.read",
   133:         "billing.read",
   134:         "settings.read",
   135:         "backups.read",
   136:     ],
   137: };
   138: 
   139: // ---- Helpers (optional, used by some older code paths) ----
   140: export function permsForRoles(roles: string[] | undefined | null): Set<Permission> {
   141:     const out = new Set<Permission>();
   142:     if (!roles) return out;
   143:     for (const r of roles) {
   144:         const key = r as Role;
   145:         const list = rolePermissions[key];
   146:         if (list) list.forEach((p) => out.add(p));
   147:     }
   148:     return out;
   149: }
   150: 
   151: export function hasPerm(roles: string[] | undefined | null, perm: Permission): boolean {
   152:     return permsForRoles(roles).has(perm);
   153: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\auth\permissions.guard.ts
Size: 3,691 bytes    Modified: 11/6/2025 5:36:57 PM
----------------------------------------------------------------------------------------------------
     1: import {
     2:     CanActivate,
     3:     ExecutionContext,
     4:     ForbiddenException,
     5:     Injectable,
     6: } from "@nestjs/common";
     7: import { Reflector } from "@nestjs/core";
     8: import { REQUIRE_PERM_KEY, RequirePermMetadata } from "./require-perm.decorator";
     9: import { PgPoolService } from "../storage/pg-pool.service";
    10: import { permsForRoles } from "./policy";
    11: 
    12: @Injectable()
    13: export class PermissionsGuard implements CanActivate {
    14:     constructor(
    15:         private readonly reflector: Reflector,
    16:         private readonly db: PgPoolService
    17:     ) { }
    18: 
    19:     async canActivate(ctx: ExecutionContext): Promise<boolean> {
    20:         const req = ctx.switchToHttp().getRequest<any>();
    21: 
    22:         const required: RequirePermMetadata | undefined =
    23:             this.reflector.getAllAndOverride<RequirePermMetadata>(REQUIRE_PERM_KEY, [
    24:                 ctx.getHandler(),
    25:                 ctx.getClass(),
    26:             ]);
    27: 
    28:         const apiKey = req.header?.("x-admin-api-key") ?? req.headers?.["x-admin-api-key"];
    29:         if (apiKey && process.env.ADMIN_API_KEY && apiKey === process.env.ADMIN_API_KEY) {
    30:             return true;
    31:         }
    32: 
    33:         const user = req.user;
    34:         if (!user) throw new ForbiddenException("Not authenticated");
    35: 
    36:         if (!required || required.length === 0) return true;
    37: 
    38:         let userPerms = this.normalizePerms(user.permissions);
    39: 
    40:         if (userPerms.length === 0) {
    41:             const roleHints = this.extractRoleNames(user);
    42:             if (roleHints.length) {
    43:                 const defaults = permsForRoles(roleHints);
    44:                 if (defaults.size) {
    45:                     userPerms = Array.from(defaults);
    46:                 }
    47:             }
    48:         }
    49: 
    50:         if (userPerms.length === 0 && user.id) {
    51:             userPerms = await this.loadPermsFromRoles(user.id);
    52:         }
    53: 
    54:         const userSet = new Set(userPerms.map((p) => p.toLowerCase()));
    55: 
    56:         for (const r of required) {
    57:             const key = String(r).toLowerCase();
    58:             if (!userSet.has(key)) {
    59:                 throw new ForbiddenException("Insufficient permissions");
    60:             }
    61:         }
    62: 
    63:         return true;
    64:     }
    65: 
    66:     private normalizePerms(val: any): string[] {
    67:         if (!val) return [];
    68:         if (Array.isArray(val)) return val.map((x) => String(x).toLowerCase());
    69:         if (typeof val === "object") return Object.keys(val).map((k) => k.toLowerCase());
    70:         const s = String(val);
    71:         if (s.includes(",")) {
    72:             return s.split(",").map((x) => x.trim().toLowerCase()).filter(Boolean);
    73:         }
    74:         return [s.toLowerCase()];
    75:     }
    76: 
    77:     private async loadPermsFromRoles(userId: string): Promise<string[]> {
    78:         try {
    79:             const { rows } = await this.db.query<{ permission_key: string }>(
    80:                 `SELECT DISTINCT rp.permission_key
    81:            FROM public.user_roles ur
    82:            JOIN public.role_permissions rp ON rp.role_id = ur.role_id
    83:           WHERE ur.user_id = $1`,
    84:                 [userId],
    85:             );
    86:             return rows.map((r) => r.permission_key.toLowerCase());
    87:         } catch {
    88:             return [];
    89:         }
    90:     }
    91: 
    92:     private extractRoleNames(user: any): string[] {
    93:         const out = new Set<string>();
    94:         const push = (val: unknown) => {
    95:             if (!val) return;
    96:             const name = String(val).trim();
    97:             if (name) out.add(name.toLowerCase());
    98:         };
    99: 
   100:         if (Array.isArray(user?.roles)) user.roles.forEach(push);
   101:         push(user?.role);
   102:         push(user?.roleName);
   103:         push(user?.role_name);
   104:         if (user?.role?.name) push(user.role.name);
   105: 
   106:         return Array.from(out);
   107:     }
   108: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\roles\roles.controller.ts
Size: 1,206 bytes    Modified: 11/6/2025 12:02:11 PM
----------------------------------------------------------------------------------------------------
     1: import {
     2:     Body,
     3:     Controller,
     4:     Delete,
     5:     Get,
     6:     Param,
     7:     ParseUUIDPipe,
     8:     Patch,
     9:     Post,
    10:     UseGuards,
    11: } from '@nestjs/common';
    12: import { RolesService } from './roles.service';
    13: import { CreateRoleDto, UpdateRoleDto } from './dto';
    14: import { PermissionsGuard } from '../auth/permissions.guard';
    15: import { RequirePerm } from '../auth/require-perm.decorator';
    16: 
    17: @UseGuards(PermissionsGuard)
    18: @Controller('api/roles')
    19: export class RolesController {
    20:     constructor(private readonly svc: RolesService) { }
    21: 
    22:     @Get()
    23:     @RequirePerm('roles.read')
    24:     list() {
    25:         return this.svc.list();
    26:     }
    27: 
    28:     @Post()
    29:     @RequirePerm('roles.write')
    30:     create(@Body() body: CreateRoleDto) {
    31:         return this.svc.create(body);
    32:     }
    33: 
    34:     @Patch(':id')
    35:     @RequirePerm('roles.write')
    36:     async update(
    37:         @Param('id', new ParseUUIDPipe({ version: '4' })) id: string,
    38:         @Body() body: UpdateRoleDto,
    39:     ) {
    40:         await this.svc.update(id, body);
    41:         return { ok: true };
    42:     }
    43: 
    44:     @Delete(':id')
    45:     @RequirePerm('roles.delete')
    46:     async remove(@Param('id', new ParseUUIDPipe({ version: '4' })) id: string) {
    47:         await this.svc.remove(id);
    48:         return { ok: true };
    49:     }
    50: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\roles\permissions.controller.ts
Size: 1,034 bytes    Modified: 11/7/2025 11:33:06 AM
----------------------------------------------------------------------------------------------------
     1: //remoteiq-minimal-e2e\backend\src\roles\permissions.controller.ts
     2: 
     3: import { Controller, Get, UseGuards } from "@nestjs/common";
     4: import { PermissionGroupDto, PermissionsIntrospectService } from "./permissions-introspect.service";
     5: import { PermissionsGuard } from "../auth/permissions.guard";
     6: import { RequirePerm } from "../auth/require-perm.decorator";
     7: 
     8: /**
     9:  * Standalone controller to expose a canonical list of permission keys.
    10:  * Path: /api/roles/permission-keys
    11:  */
    12: @UseGuards(PermissionsGuard)
    13: @Controller("/api/roles")
    14: export class RolesPermissionsController {
    15:     constructor(private readonly introspect: PermissionsIntrospectService) { }
    16: 
    17:     @Get("permission-keys")
    18:     @RequirePerm("roles.read")
    19:     async listPermissionKeys(): Promise<{ permissions: string[]; groups: PermissionGroupDto[] }> {
    20:         const [permissions, groups] = await Promise.all([
    21:             this.introspect.listDistinctPermissionKeys(),
    22:             this.introspect.listPermissionGroups(),
    23:         ]);
    24:         return { permissions, groups };
    25:     }
    26: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\branding\branding.controller.ts
Size: 5,052 bytes    Modified: 10/29/2025 1:12:12 PM
----------------------------------------------------------------------------------------------------
     1: // backend/src/branding/branding.controller.ts
     2: import {
     3:     Controller,
     4:     Get,
     5:     Post,
     6:     Body,
     7:     UploadedFile,
     8:     UseInterceptors,
     9:     BadRequestException,
    10:     Req,
    11: } from '@nestjs/common';
    12: import { ApiConsumes, ApiOkResponse, ApiTags } from '@nestjs/swagger';
    13: import { FileInterceptor } from '@nestjs/platform-express';
    14: import { diskStorage } from 'multer';
    15: import { existsSync, mkdirSync } from 'fs';
    16: import { join, extname } from 'path';
    17: import type { Request } from 'express';
    18: 
    19: import { BrandingService } from "./branding.service";
    20: import { UpdateBrandingDto } from './dto/update-branding.dto';
    21: 
    22: 
    23: @ApiTags('branding')
    24: @Controller('api/branding')
    25: export class BrandingController {
    26:     constructor(private readonly service: BrandingService) { }
    27: 
    28:     /* ------------------------------------------------------------------ */
    29:     /* Read / Write settings                                               */
    30:     /* ------------------------------------------------------------------ */
    31: 
    32:     @Get()
    33:     @ApiOkResponse({ description: 'Current branding settings' })
    34:     getBranding() {
    35:         return this.service.getBranding();
    36:     }
    37: 
    38:     @Post()
    39:     @ApiOkResponse({ description: 'Updated branding settings' })
    40:     updateBranding(@Body() dto: UpdateBrandingDto) {
    41:         return this.service.updateBranding(dto);
    42:     }
    43: 
    44:     /* ------------------------------------------------------------------ */
    45:     /* Uploads                                                             */
    46:     /* - General images (logos, backgrounds) -> /api/branding/upload       */
    47:     /* - Favicon (.ico only)             -> /api/branding/upload-favicon   */
    48:     /* Files are written to ./public/uploads and served at /static/uploads */
    49:     /* ------------------------------------------------------------------ */
    50: 
    51:     /** Upload general image (logos, login backgrounds). Field name: `file` */
    52:     @Post('upload')
    53:     @ApiConsumes('multipart/form-data')
    54:     @UseInterceptors(
    55:         FileInterceptor('file', {
    56:             storage: diskStorage({
    57:                 destination: (_req, _file, cb) => {
    58:                     const dest = join(process.cwd(), 'public', 'uploads');
    59:                     if (!existsSync(dest)) mkdirSync(dest, { recursive: true });
    60:                     cb(null, dest);
    61:                 },
    62:                 filename: (_req, file, cb) => {
    63:                     const ts = Date.now();
    64:                     const safe = file.originalname.replace(/[^a-zA-Z0-9._-]/g, '_');
    65:                     cb(null, `${ts}_${safe}`);
    66:                 },
    67:             }),
    68:             fileFilter: (_req, file, cb) => {
    69:                 if (!/^image\//.test(file.mimetype)) {
    70:                     return cb(new BadRequestException('Only image files are allowed'), false);
    71:                 }
    72:                 cb(null, true);
    73:             },
    74:             limits: { fileSize: 5 * 1024 * 1024 }, // 5MB
    75:         }),
    76:     )
    77:     uploadImage(@UploadedFile() file: Express.Multer.File, @Req() req: Request) {
    78:         if (!file) throw new BadRequestException('No file uploaded');
    79: 
    80:         const base =
    81:             process.env.PUBLIC_BASE_URL ||
    82:             `${req.protocol}://${req.get('host')}`;
    83: 
    84:         // NOTE: main.ts must call app.useStaticAssets(..., { prefix: '/static/' })
    85:         return { url: `${base}/static/uploads/${file.filename}` };
    86:     }
    87: 
    88:     /** Upload favicon (.ico only). Field name: `file` */
    89:     @Post('upload-favicon')
    90:     @ApiConsumes('multipart/form-data')
    91:     @UseInterceptors(
    92:         FileInterceptor('file', {
    93:             storage: diskStorage({
    94:                 destination: (_req, _file, cb) => {
    95:                     const dest = join(process.cwd(), 'public', 'uploads');
    96:                     if (!existsSync(dest)) mkdirSync(dest, { recursive: true });
    97:                     cb(null, dest);
    98:                 },
    99:                 filename: (_req, file, cb) => {
   100:                     const ts = Date.now();
   101:                     const safe = file.originalname.replace(/[^a-zA-Z0-9._-]/g, '_');
   102:                     cb(null, `${ts}_${safe}`);
   103:                 },
   104:             }),
   105:             fileFilter: (_req, file, cb) => {
   106:                 const isIco =
   107:                     file.mimetype === 'image/x-icon' ||
   108:                     file.mimetype === 'image/vnd.microsoft.icon' ||
   109:                     extname(file.originalname).toLowerCase() === '.ico';
   110:                 if (!isIco) {
   111:                     return cb(new BadRequestException('Only .ico files are allowed'), false);
   112:                 }
   113:                 cb(null, true);
   114:             },
   115:             limits: { fileSize: 512 * 1024 }, // 512KB
   116:         }),
   117:     )
   118:     uploadFavicon(@UploadedFile() file: Express.Multer.File, @Req() req: Request) {
   119:         if (!file) throw new BadRequestException('No file uploaded');
   120: 
   121:         const base =
   122:             process.env.PUBLIC_BASE_URL ||
   123:             `${req.protocol}://${req.get('host')}`;
   124: 
   125:         return { url: `${base}/static/uploads/${file.filename}` };
   126:     }
   127: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\backups\backups.controller.ts
Size: 4,083 bytes    Modified: 11/6/2025 12:31:52 AM
----------------------------------------------------------------------------------------------------
     1: import {
     2:     Body,
     3:     Controller,
     4:     Get,
     5:     Post,
     6:     Put,
     7:     Param,
     8:     Query,
     9:     Res,
    10:     HttpException,
    11:     HttpStatus,
    12:     UseGuards,
    13: } from "@nestjs/common";
    14: import { Response } from "express";
    15: import { BackupsService } from "./backups.service";
    16: import { HistoryQueryDto, BackupConfigDto } from "./dto";
    17: import { PermissionsGuard } from "../auth/permissions.guard";
    18: import { RequirePerm } from "../auth/require-perm.decorator";
    19: import { WorkerService } from "./worker.service";
    20: 
    21: @Controller("/api/admin/backups")
    22: @UseGuards(PermissionsGuard)
    23: export class BackupsController {
    24:     constructor(
    25:         private readonly svc: BackupsService,
    26:         private readonly worker: WorkerService
    27:     ) { }
    28: 
    29:     /* ---------------- Config / Permissions ---------------- */
    30: 
    31:     @Get("config")
    32:     @RequirePerm("backups.read")
    33:     async getConfig() {
    34:         return this.svc.getConfig();
    35:     }
    36: 
    37:     @Put("config")
    38:     @RequirePerm("backups.manage")
    39:     async putConfig(@Body() body: BackupConfigDto) {
    40:         this.svc.validateDestination((body as any).destination);
    41:         return this.svc.saveConfig(body);
    42:     }
    43: 
    44:     // Capability booleans for UI
    45:     @Get("permissions")
    46:     @RequirePerm("backups.read")
    47:     async getPerms() {
    48:         return this.svc.getPermissions();
    49:     }
    50: 
    51:     /* ---------------- History ---------------- */
    52: 
    53:     @Get("history")
    54:     @RequirePerm("backups.read")
    55:     async history(@Query() q: HistoryQueryDto) {
    56:         return this.svc.listHistory(q);
    57:     }
    58: 
    59:     /* ---------------- Actions ---------------- */
    60: 
    61:     @Post("run")
    62:     @RequirePerm("backups.run")
    63:     async runNow() {
    64:         const res = await this.svc.startBackupNow();
    65:         // kick the worker (fire-and-forget)
    66:         this.worker.runOneIfAny().catch(() => { });
    67:         return res;
    68:     }
    69: 
    70:     @Post("prune")
    71:     @RequirePerm("backups.prune")
    72:     async prune() {
    73:         return this.svc.pruneOld();
    74:     }
    75: 
    76:     @Post("test-destination")
    77:     @RequirePerm("backups.manage")
    78:     async testDest(@Body() body: any) {
    79:         return this.svc.testDestination((body ?? {}).destination);
    80:     }
    81: 
    82:     @Post(":id/retry")
    83:     @RequirePerm("backups.run")
    84:     async retry(@Param("id") id: string) {
    85:         return this.svc.retryJob(id);
    86:     }
    87: 
    88:     @Post(":id/cancel")
    89:     @RequirePerm("backups.run")
    90:     async cancel(@Param("id") id: string) {
    91:         return this.svc.cancelJob(id);
    92:     }
    93: 
    94:     @Post(":id/restore")
    95:     @RequirePerm("backups.restore")
    96:     async restore(@Param("id") id: string) {
    97:         return this.svc.startRestore(id);
    98:     }
    99: 
   100:     /* ---------------- Artifacts ---------------- */
   101: 
   102:     @Get(":id/log")
   103:     @RequirePerm("backups.read")
   104:     async log(@Param("id") id: string, @Res() res: Response) {
   105:         const stream = await this.svc.openLogStream(id);
   106:         if (!stream) throw new HttpException("Not found", HttpStatus.NOT_FOUND);
   107:         res.setHeader("Content-Type", "text/plain; charset=utf-8");
   108:         stream.pipe(res);
   109:     }
   110: 
   111:     @Get(":id/manifest")
   112:     @RequirePerm("backups.read")
   113:     async manifest(@Param("id") id: string) {
   114:         const m = await this.svc.getManifest(id);
   115:         if (!m) throw new HttpException("Not found", HttpStatus.NOT_FOUND);
   116:         return m;
   117:     }
   118: 
   119:     @Get(":id/download")
   120:     @RequirePerm("backups.download")
   121:     async download(@Param("id") id: string, @Res() res: Response) {
   122:         const out = await this.svc.getDownload(id);
   123:         if (!out) throw new HttpException("Not found", HttpStatus.NOT_FOUND);
   124: 
   125:         if (out.stream) {
   126:             res.setHeader(
   127:                 "Content-Disposition",
   128:                 `attachment; filename="${out.filename.replace(/"/g, "")}"`
   129:             );
   130:             res.setHeader("Content-Type", "application/octet-stream");
   131:             out.stream.pipe(res);
   132:             return;
   133:         }
   134:         if (out.presignedUrl) {
   135:             res.redirect(out.presignedUrl);
   136:             return;
   137:         }
   138:         throw new HttpException("Not found", HttpStatus.NOT_FOUND);
   139:     }
   140: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\smtp\smtp.controller.ts
Size: 6,821 bytes    Modified: 10/20/2025 7:14:59 PM
----------------------------------------------------------------------------------------------------
     1: // backend/src/smtp/smtp.controller.ts
     2: 
     3: import {
     4:     BadRequestException,
     5:     Body,
     6:     Controller,
     7:     Get,
     8:     Post,
     9:     Query,
    10:     Req,
    11: } from "@nestjs/common";
    12: import { Request } from "express";
    13: import { SmtpService } from "./smtp.service";
    14: import {
    15:     SaveEmailConfigDto,
    16:     SendTestEmailDto,
    17:     TestImapDto,
    18:     TestPopDto,
    19:     TestSmtpDto,
    20: } from "./dto/smtp.dto";
    21: import { DkimRepository } from "./dkim.repository";
    22: import { EmailPurpose } from "./smtp.repository";
    23: 
    24: /**
    25:  * Admin Email endpoints used by the Settings UI.
    26:  */
    27: @Controller("api/admin/email")
    28: export class SmtpController {
    29:     constructor(private svc: SmtpService, private dkimRepo: DkimRepository) { }
    30: 
    31:     // Rate limit for /send-test:
    32:     // Prefer SEND_TEST_LIMIT, else SMTP_RATE_TOKENS, else 10
    33:     private readonly LIMIT =
    34:         Number(process.env.SEND_TEST_LIMIT) ||
    35:         Number(process.env.SMTP_RATE_TOKENS) ||
    36:         10;
    37:     private sendTestLimiter = new Map<string, { count: number; reset: number }>();
    38:     private readonly WINDOW_MS = 60_000;
    39: 
    40:     private checkRate(req: Request) {
    41:         const key =
    42:             (req.headers["x-real-ip"] as string) ||
    43:             (req.headers["x-forwarded-for"] as string) ||
    44:             (req.ip as string) ||
    45:             "global";
    46:         const now = Date.now();
    47:         const entry =
    48:             this.sendTestLimiter.get(key) ?? {
    49:                 count: 0,
    50:                 reset: now + this.WINDOW_MS,
    51:             };
    52:         if (now > entry.reset) {
    53:             entry.count = 0;
    54:             entry.reset = now + this.WINDOW_MS;
    55:         }
    56:         entry.count += 1;
    57:         this.sendTestLimiter.set(key, entry);
    58:         if (entry.count > this.LIMIT) {
    59:             throw new BadRequestException(
    60:                 "Rate limit exceeded for send-test. Try again shortly."
    61:             );
    62:         }
    63:     }
    64: 
    65:     private audit(
    66:         req: Request,
    67:         action: string,
    68:         details?: Record<string, unknown>
    69:     ) {
    70:         const adminUser = (req.headers["x-admin-user"] as string) || "unknown-admin";
    71:         const ip =
    72:             (req.headers["x-real-ip"] as string) ||
    73:             (req.headers["x-forwarded-for"] as string) ||
    74:             (req.ip as string) ||
    75:             "unknown-ip";
    76:         console.log(
    77:             JSON.stringify({
    78:                 at: new Date().toISOString(),
    79:                 category: "email",
    80:                 action,
    81:                 actor: adminUser,
    82:                 ip,
    83:                 details: details ?? {},
    84:             })
    85:         );
    86:     }
    87: 
    88:     // ---------- Config ----------
    89: 
    90:     @Get()
    91:     async getConfig(@Req() req: Request) {
    92:         this.audit(req, "email_config_get");
    93:         return this.svc.getConfig();
    94:     }
    95: 
    96:     @Post("save")
    97:     async save(@Req() req: Request, @Body() dto: SaveEmailConfigDto) {
    98:         await this.svc.saveConfig({
    99:             profiles: dto.profiles,
   100:             lastUpdated: new Date().toISOString(),
   101:         });
   102:         this.audit(req, "email_config_save");
   103:         return { ok: true };
   104:     }
   105: 
   106:     // ---------- Connectivity tests ----------
   107: 
   108:     @Post("test-smtp")
   109:     async testSmtp(@Req() req: Request, @Body() dto: TestSmtpDto) {
   110:         const res = await this.svc.testSmtp(dto.profile);
   111:         this.audit(req, "email_test_smtp", { profile: dto.profile, ok: res.ok });
   112:         return res;
   113:     }
   114: 
   115:     @Post("test-imap")
   116:     async testImap(@Req() req: Request, @Body() dto: TestImapDto) {
   117:         const res = await this.svc.testImap(dto.profile);
   118:         this.audit(req, "email_test_imap", { profile: dto.profile, ok: res.ok });
   119:         return res;
   120:     }
   121: 
   122:     @Post("test-pop")
   123:     async testPop(@Req() req: Request, @Body() dto: TestPopDto) {
   124:         const res = await this.svc.testPop(dto.profile);
   125:         this.audit(req, "email_test_pop", { profile: dto.profile, ok: res.ok });
   126:         return res;
   127:     }
   128: 
   129:     // ---------- Send test message ----------
   130: 
   131:     @Post("send-test")
   132:     async sendTest(@Req() req: Request, @Body() dto: SendTestEmailDto) {
   133:         this.checkRate(req);
   134:         const res = await this.svc.sendTest(
   135:             dto.profile,
   136:             dto.to,
   137:             dto.subject,
   138:             dto.body
   139:         );
   140:         this.audit(req, "email_send_test", {
   141:             profile: dto.profile,
   142:             to: dto.to,
   143:             ok: res.ok,
   144:         });
   145:         return res;
   146:     }
   147: 
   148:     // ---------- DKIM endpoints (GET never returns private key) ----------
   149: 
   150:     @Get("dkim")
   151:     async getDkim(@Req() req: Request) {
   152:         this.audit(req, "dkim_get");
   153:         const row = await this.dkimRepo.get();
   154:         return {
   155:             domain: row.domain,
   156:             selector: row.selector,
   157:             hasPrivateKey: !!row.private_key,
   158:             updatedAt: row.updated_at,
   159:         };
   160:     }
   161: 
   162:     @Post("dkim")
   163:     async saveDkim(
   164:         @Req() req: Request,
   165:         @Body() body: { domain: string; selector: string; privateKey?: string }
   166:     ) {
   167:         if (!body?.domain || !body?.selector) {
   168:             throw new BadRequestException("domain and selector are required");
   169:         }
   170:         await this.dkimRepo.save({
   171:             domain: body.domain,
   172:             selector: body.selector,
   173:             privateKey: body.privateKey, // omit to keep existing
   174:         });
   175:         this.audit(req, "dkim_save", {
   176:             domain: body.domain,
   177:             selector: body.selector,
   178:             withKey: !!body.privateKey,
   179:         });
   180:         return { ok: true };
   181:     }
   182: 
   183:     // Optional: DNS check helper for DKIM TXT (debug/UX)
   184:     @Get("dkim/dns-check")
   185:     async dkimDnsCheck(
   186:         @Req() req: Request,
   187:         @Query("domain") domain?: string,
   188:         @Query("selector") selector?: string
   189:     ) {
   190:         if (!domain || !selector) {
   191:             throw new BadRequestException("domain and selector are required");
   192:         }
   193:         const res = await this.svc.verifyDkimDns(domain, selector);
   194:         this.audit(req, "dkim_dns_check", {
   195:             domain,
   196:             selector,
   197:             ok: (res as any).ok,
   198:         });
   199:         return res;
   200:     }
   201: 
   202:     // Optional: consolidated health snapshot for a profile
   203:     @Get("health")
   204:     async health(@Req() req: Request, @Query("profile") profile?: EmailPurpose) {
   205:         const p = (profile || "alerts") as EmailPurpose;
   206:         const [smtp, imap, pop] = await Promise.all([
   207:             this.svc.smtpHealth(p),
   208:             this.svc.imapHealth(p),
   209:             this.svc.testPop(p),
   210:         ]);
   211:         this.audit(req, "email_health", { profile: p, smtp: smtp.ok, imap: imap.ok, pop: pop.ok });
   212:         return {
   213:             profile: p,
   214:             smtp,
   215:             imap,
   216:             pop,
   217:             timestamp: new Date().toISOString(),
   218:         };
   219:     }
   220: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\storage\storage.controller.ts
Size: 1,651 bytes    Modified: 11/6/2025 5:36:57 PM
----------------------------------------------------------------------------------------------------
     1: import {
     2:     Body,
     3:     Controller,
     4:     Delete,
     5:     Get,
     6:     Param,
     7:     Post,
     8:     Put,
     9:     UseGuards,
    10: } from "@nestjs/common";
    11: import { StorageConnectionsService } from "./storage-connections.service";
    12: import { PermissionsGuard } from "../auth/permissions.guard";
    13: import { RequirePerm } from "../auth/require-perm.decorator";
    14: 
    15: @Controller("/api/admin/storage")
    16: @UseGuards(PermissionsGuard)
    17: export class StorageController {
    18:     constructor(private readonly svc: StorageConnectionsService) { }
    19: 
    20:     @Get("connections")
    21:     @RequirePerm("backups.manage")
    22:     async list() {
    23:         return this.svc.list();
    24:     }
    25: 
    26:     @Post("connections")
    27:     @RequirePerm("backups.manage")
    28:     async create(@Body() body: any) {
    29:         return this.svc.create(body);
    30:     }
    31: 
    32:     @Put("connections/:id")
    33:     @RequirePerm("backups.manage")
    34:     async update(@Param("id") id: string, @Body() body: any) {
    35:         await this.svc.update(id, body);
    36:         return { ok: true };
    37:     }
    38: 
    39:     @Delete("connections/:id")
    40:     @RequirePerm("backups.manage")
    41:     async remove(@Param("id") id: string) {
    42:         await this.svc.delete(id);
    43:         return { ok: true };
    44:     }
    45: 
    46:     @Get("connections/:id/dependents")
    47:     @RequirePerm("backups.manage")
    48:     async dependents(@Param("id") id: string) {
    49:         return this.svc.getDependents(id);
    50:     }
    51: 
    52:     @Post("test")
    53:     @RequirePerm("backups.manage")
    54:     async test(@Body() body: any) {
    55:         return this.svc.test(body);
    56:     }
    57: 
    58:     @Post("browse")
    59:     @RequirePerm("backups.manage")
    60:     async browse(@Body() body: any) {
    61:         return this.svc.browseNextcloud(body);
    62:     }
    63: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\company\company.controller.ts
Size: 903 bytes    Modified: 10/19/2025 12:39:08 AM
----------------------------------------------------------------------------------------------------
     1: // backend/src/company/company.controller.ts
     2: import { Body, Controller, Get, HttpCode, Post, UsePipes, ValidationPipe } from "@nestjs/common";
     3: import { CompanyService } from "./company.service";
     4: import { CompanyProfile, CompanyProfileDto } from "./company.dto";
     5: 
     6: @UsePipes(new ValidationPipe({ whitelist: true, transform: true }))
     7: @Controller("/api/admin/company") // keep paths used by the frontend
     8: export class CompanyController {
     9:     constructor(private readonly svc: CompanyService) { }
    10: 
    11:     @Get()
    12:     async get(): Promise<CompanyProfile | { exists: false }> {
    13:         const row = await this.svc.get();
    14:         return row ?? { exists: false };
    15:     }
    16: 
    17:     @Post("save")
    18:     @HttpCode(204)
    19:     async save(@Body() body: CompanyProfileDto): Promise<void> {
    20:         // ValidationPipe(whitelist:true) will drop unknown props (e.g., id)
    21:         await this.svc.upsert(body);
    22:     }
    23: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\support-legal\support-legal.controller.ts
Size: 855 bytes    Modified: 10/19/2025 1:39:24 AM
----------------------------------------------------------------------------------------------------
     1: import { Body, Controller, Get, HttpCode, Post, UsePipes, ValidationPipe } from "@nestjs/common";
     2: import { SupportLegalService } from "./support-legal.service";
     3: import { SupportLegal, SupportLegalDto } from "./support-legal.dto";
     4: 
     5: @Controller("/api/admin/support-legal")
     6: export class SupportLegalController {
     7:     constructor(private readonly svc: SupportLegalService) { }
     8: 
     9:     @Get()
    10:     async get(): Promise<SupportLegal | { exists: false }> {
    11:         // Return a predictable object instead of blowing up if there is no row.
    12:         const row = await this.svc.get();
    13:         return row ?? { exists: false };
    14:     }
    15: 
    16:     @Post("save")
    17:     @HttpCode(204)
    18:     @UsePipes(new ValidationPipe({ whitelist: true, transform: true }))
    19:     async save(@Body() body: SupportLegalDto): Promise<void> {
    20:         await this.svc.upsert(body);
    21:     }
    22: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\localization\localization.controller.ts
Size: 854 bytes    Modified: 10/19/2025 12:54:46 AM
----------------------------------------------------------------------------------------------------
     1: import { Body, Controller, Get, HttpCode, Post, UsePipes, ValidationPipe } from "@nestjs/common";
     2: import { LocalizationService } from "./localization.service";
     3: import { LocalizationDto, LocalizationRow } from "./localization.dto";
     4: 
     5: @UsePipes(new ValidationPipe({ whitelist: true, transform: true }))
     6: @Controller("/api/admin/localization")
     7: export class LocalizationController {
     8:     constructor(private readonly svc: LocalizationService) { }
     9: 
    10:     @Get()
    11:     async get(): Promise<LocalizationRow | { exists: false }> {
    12:         const row = await this.svc.get();
    13:         return row ?? { exists: false };
    14:     }
    15: 
    16:     @Post("save")
    17:     @HttpCode(204)
    18:     async save(@Body() body: LocalizationDto): Promise<void> {
    19:         // Note: DTO is whitelisted; any unexpected props (like id) are dropped.
    20:         await this.svc.upsert(body);
    21:     }
    22: }

----------------------------------------------------------------------------------------------------
File: remoteiq-minimal-e2e\backend\src\admin\database.controller.ts
Size: 1,595 bytes    Modified: 10/18/2025 1:56:21 PM
----------------------------------------------------------------------------------------------------
     1: // backend/src/admin/database.controller.ts
     2: import { Body, Controller, Get, HttpCode, Post, UsePipes, ValidationPipe } from "@nestjs/common";
     3: import { DatabaseConfigDto, TestResultDto } from "./database.dto";
     4: import { DatabaseService } from "./database.service";
     5: 
     6: @UsePipes(new ValidationPipe({ whitelist: true, transform: true }))
     7: @Controller("/api/admin/database")
     8: export class DatabaseController {
     9:     constructor(private readonly svc: DatabaseService) { }
    10: 
    11:     @Get()
    12:     async getConfig(): Promise<DatabaseConfigDto | { enabled: false }> {
    13:         const cfg = this.svc.getConfig() ?? (await this.svc.loadConfig());
    14:         return cfg ?? { enabled: false } as any;
    15:     }
    16: 
    17:     @Post("test")
    18:     @HttpCode(200)
    19:     async test(@Body() body: DatabaseConfigDto): Promise<TestResultDto> {
    20:         return this.svc.testConnection(body);
    21:     }
    22: 
    23:     @Post("save")
    24:     @HttpCode(204)
    25:     async save(@Body() body: DatabaseConfigDto): Promise<void> {
    26:         // Optional: you could also re-test here and reject on failure
    27:         await this.svc.saveConfig(body);
    28:     }
    29: 
    30:     // Stub endpoint your UI can call for the "Dry-run migration" button
    31:     @Post("migrate/dry-run")
    32:     async dryRun(): Promise<{ ok: true; destructive: false; steps: string[] }> {
    33:         return {
    34:             ok: true,
    35:             destructive: false,
    36:             steps: [
    37:                 "Verify connectivity to primary",
    38:                 "Check presence of required tables/collections",
    39:                 "Plan non-destructive CREATEs/INDEXes if missing",
    40:             ],
    41:         };
    42:     }
    43: }

====================================================================================================
=  Missing Files Summary
====================================================================================================

All expected files were found and exported.

End of report.

