========================================================================================
RemoteIQ — Tickets Integration Frontend Snapshot
Generated: 2025-11-02 22:31:40 -05:00
Frontend root: C:\Users\Last Stop\Documents\Programming Projects\RemoteIQ V7 - Ticketing\remoteiq-frontend
========================================================================================

This file contains the exact source of the requested frontend files, with
metadata and SHA256 hashes. Sections are numbered and separated for quick navigation.

========================================================================================
[1] FILE
Path       : app/layout.tsx
Size       : 1,262 bytes
Last Write : 2025-10-29 13:12:12
SHA256     : EA5F1740F275A4482E48562C260CBA564715C1868EE19972A091C92724EBB15A
========================================================================================

// remoteiq-frontend/app/layout.tsx
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import { ThemeProvider } from "@/components/theme-provider";
import "@/styles/globals.css";
import { cn } from "@/lib/utils";
import Providers from "@/app/providers";
import { BrandingProvider } from "./providers/BrandingProvider";
import { ToastProvider } from "@/lib/toast";
import Toaster from "@/components/ui/toaster";

export const runtime = "nodejs";
const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "RemoteIQ",
  description: "Next-generation Remote Monitoring & Management",
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={cn("min-h-screen bg-background font-sans antialiased", inter.className)}>
        <ToastProvider>
          <ThemeProvider attribute="class" defaultTheme="dark" enableSystem disableTransitionOnChange>
            <BrandingProvider>
              <Providers>{children}</Providers>
            </BrandingProvider>
          </ThemeProvider>
          <Toaster />
        </ToastProvider>
      </body>
    </html>
  );
}



----------------------------------------------------------------------------------------



========================================================================================
[2] FILE
Path       : app/providers.tsx
Size       : 899 bytes
Last Write : 2025-10-26 17:34:07
SHA256     : 7180E084410E4961360277AE0D3A16D822985F52524BC5EBBAB4F4FFD95AF2AB
========================================================================================

// app/providers.tsx
"use client";

import * as React from "react";
import { ToastProvider } from "@/lib/toast";            // ✅ add this
import { TooltipProvider } from "@/components/ui/tooltip";
import AmbientTooltips from "@/components/ambient-tooltips";
import { DashboardProvider } from "@/app/(dashboard)/dashboard-context";

export default function Providers({ children }: { children: React.ReactNode }) {
    return (
        <ToastProvider>                                      {/* ✅ now useToast() is safe */}
            <TooltipProvider delayDuration={200}>
                <DashboardProvider>
                    {children}
                    {/* Global, zero-config tooltips for elements with data-tooltip="..." */}
                    <AmbientTooltips />
                </DashboardProvider>
            </TooltipProvider>
        </ToastProvider>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[3] FILE
Path       : middleware.ts
Size       : 1,677 bytes
Last Write : 2025-10-18 21:30:54
SHA256     : 89DE17FAA12903C4937D732684C57AC753F94902FCE54FCC173650A4820D7150
========================================================================================

import type { NextRequest } from "next/server";
import { NextResponse } from "next/server";

const PUBLIC_PATHS = new Set<string>([
    "/login",
    "/favicon.ico",
    "/robots.txt",
    "/sitemap.xml",
]);

export function middleware(req: NextRequest) {
    const { pathname } = req.nextUrl;

    // Normalize legacy route to the new one
    if (pathname === "/auth/login") {
        const url = req.nextUrl.clone();
        url.pathname = "/login";
        // default to home after login
        url.searchParams.set("next", "/");
        return NextResponse.redirect(url);
    }

    // Never run on /login or static assets (avoid loops)
    if (
        pathname === "/login" ||
        pathname.startsWith("/_next/") ||
        pathname.startsWith("/static/") ||
        pathname.startsWith("/images/") ||
        pathname.startsWith("/fonts/")
    ) {
        return NextResponse.next();
    }

    // Allow any frontend /api if you have them
    if (pathname.startsWith("/api/")) {
        return NextResponse.next();
    }

    if (PUBLIC_PATHS.has(pathname)) {
        return NextResponse.next();
    }

    const token = req.cookies.get("auth_token")?.value;

    if (!token) {
        const url = req.nextUrl.clone();
        url.pathname = "/login";
        // set next to the requested path; it’s sanitized on the login page
        url.searchParams.set("next", pathname || "/");
        return NextResponse.redirect(url);
    }

    return NextResponse.next();
}

export const config = {
    matcher: [
        "/((?!_next/static|_next/image|favicon.ico|robots.txt|sitemap.xml|login).*)",
    ],
};



----------------------------------------------------------------------------------------



========================================================================================
[4] FILE
Path       : app/(auth)/login/page.tsx
Size       : 16,432 bytes
Last Write : 2025-10-21 15:13:38
SHA256     : BFE0D31155EF05F252D2583F1BAA8DFA2A28CDB8DB12EC2DD30497F32A9ADDDE
========================================================================================

// app/(auth)/login/page.tsx
"use client";

import * as React from "react";
import {
    Card,
    CardContent,
    CardDescription,
    CardFooter,
    CardHeader,
    CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Shield, Eye, EyeOff } from "lucide-react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { useBranding } from "@/app/providers/BrandingProvider";

/** Only allow same-origin paths; never /login or legacy /auth/login */
function safeNext(raw: string | null): string {
    if (!raw) return "/";
    try {
        if (raw.startsWith("http://") || raw.startsWith("https://") || raw.startsWith("//")) return "/";
        if (!raw.startsWith("/")) return "/";
        if (raw === "/login" || raw.startsWith("/auth/login")) return "/";
        return raw;
    } catch {
        return "/";
    }
}

const API_BASE = (process.env.NEXT_PUBLIC_API_BASE || "http://localhost:3001").replace(/\/+$/, "");

type LoginOk =
    | { user: any; ok?: true }
    | { status: "2fa_required"; challengeToken: string; jti?: string };

export default function LoginPage() {
    const router = useRouter();
    const params = useSearchParams();
    const nextPath = safeNext(params.get("next"));

    const { branding } = useBranding();

    // Normalize nullable strings -> undefined for JSX props
    const loginBg = branding?.loginBackgroundUrl ?? undefined;
    const logoLight = branding?.logoLightUrl ?? undefined;
    const logoDark = branding?.logoDarkUrl ?? undefined;
    const effectiveLogo = logoLight ?? logoDark ?? "/logo.png"; // always a string

    // Form state
    const [email, setEmail] = React.useState(() => {
        if (typeof window !== "undefined") {
            return localStorage.getItem("riq_last_email") ?? "";
        }
        return "";
    });
    const [password, setPassword] = React.useState("");
    const [remember, setRemember] = React.useState(
        () => (typeof window !== "undefined" ? localStorage.getItem("riq_remember") === "1" : false),
    );
    const [isLoading, setIsLoading] = React.useState(false);
    const [error, setError] = React.useState<string | null>(null);
    const [showPw, setShowPw] = React.useState(false);
    const [capsLock, setCapsLock] = React.useState(false);

    // 2FA step
    const [challengeToken, setChallengeToken] = React.useState<string | null>(null);
    const [otp, setOtp] = React.useState("");
    const [useRecovery, setUseRecovery] = React.useState(false);
    const otpRef = React.useRef<HTMLInputElement | null>(null);

    // Keep localStorage aligned with the remember choice
    React.useEffect(() => {
        if (typeof window === "undefined") return;
        if (remember) {
            localStorage.setItem("riq_remember", "1");
            if (email) localStorage.setItem("riq_last_email", email);
        } else {
            localStorage.removeItem("riq_remember");
            // Optional: keep last email for convenience
        }
    }, [remember, email]);

    const canSubmit = email.trim().length > 0 && password.length > 0 && !isLoading;
    const canSubmitOtp =
        !!challengeToken &&
        !isLoading &&
        (useRecovery ? otp.trim().length >= 8 : otp.trim().length === 6);

    const handleLogin = async (e: React.FormEvent) => {
        e.preventDefault();
        setError(null);
        setIsLoading(true);

        const payload: Record<string, any> = { email: email.trim(), password };
        // If you later add a device fingerprint, pass it here as deviceFingerprint
        try {
            const res = await fetch(`${API_BASE}/api/auth/login`, {
                method: "POST",
                credentials: "include", // set httpOnly cookie
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            // Try to parse JSON even on errors to read structured messages or 2FA status
            let body: LoginOk | any = null;
            try {
                body = await res.json();
            } catch {
                // ignore non-JSON body
            }

            if (!res.ok) {
                let msg = `Login failed (${res.status})`;
                if (body?.message) {
                    if (Array.isArray(body.message)) msg = body.message.join(", ");
                    else msg = String(body.message);
                }
                throw new Error(msg);
            }

            // 2FA branch
            if (body && typeof body === "object" && body.status === "2fa_required" && body.challengeToken) {
                setChallengeToken(body.challengeToken);
                setTimeout(() => otpRef.current?.focus(), 30);
                if (remember) localStorage.setItem("riq_last_email", payload.email);
                return; // stay on the page and render OTP form
            }

            // Regular login success
            if (remember) localStorage.setItem("riq_last_email", payload.email);
            router.replace(nextPath);
        } catch (err: any) {
            setError(String(err?.message ?? err) || "Login failed");
        } finally {
            setIsLoading(false);
        }
    };

    const handleOtpVerify = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!challengeToken) return;
        setError(null);
        setIsLoading(true);

        try {
            const body: any = { challengeToken, rememberDevice: remember };
            if (useRecovery) body.recoveryCode = otp.trim();
            else body.code = otp.trim();

            const res = await fetch(`${API_BASE}/api/auth/2fa/verify`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                let msg = `Verification failed (${res.status})`;
                try {
                    const j = await res.json();
                    if (j?.message) {
                        if (Array.isArray(j.message)) msg = j.message.join(", ");
                        else msg = String(j.message);
                    }
                } catch { /* ignore */ }
                throw new Error(msg);
            }

            // On success, API sets cookie; proceed
            router.replace(nextPath);
        } catch (err: any) {
            setError(String(err?.message ?? err) || "Invalid code");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div
            className="relative flex min-h-screen items-center justify-center bg-background p-4 bg-cover bg-center"
            style={loginBg ? { backgroundImage: `url(${loginBg})` } : undefined}
        >
            {/* Subtle overlay for readability (only when bg is present) */}
            {loginBg && <div className="pointer-events-none absolute inset-0 bg-black/10" />}

            <Card className="relative z-10 w-full max-w-sm backdrop-blur supports-[backdrop-filter]:bg-background/80">
                <CardHeader className="text-center">
                    <div className="mb-3 flex items-center justify-center gap-2">
                        {/* Prefer brand logos; fall back to icon */}
                        {logoLight || logoDark ? (
                            <picture>
                                {logoDark ? <source srcSet={logoDark} media="(prefers-color-scheme: dark)" /> : null}
                                <img src={effectiveLogo} alt="RemoteIQ" className="h-7 w-auto rounded-sm" />
                            </picture>
                        ) : (
                            <Shield className="h-6 w-6" />
                        )}
                        <CardTitle className="text-2xl">RemoteIQ</CardTitle>
                    </div>
                    <CardDescription>
                        {challengeToken ? "Two-factor authentication required" : "Sign in to your account to continue"}
                    </CardDescription>
                </CardHeader>

                {/* Step 1: Email + Password */}
                {!challengeToken && (
                    <form onSubmit={handleLogin} noValidate>
                        <CardContent className="space-y-4">
                            <div className="space-y-2">
                                <Label htmlFor="email">Email</Label>
                                <Input
                                    id="email"
                                    type="email"
                                    placeholder="admin@example.com"
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    disabled={isLoading}
                                    autoComplete="username"
                                    inputMode="email"
                                />
                            </div>

                            <div className="space-y-2">
                                <div className="flex items-center justify-between">
                                    <Label htmlFor="password">Password</Label>
                                    <Link href="/forgot-password" className="text-sm font-medium text-primary hover:underline">
                                        Forgot password?
                                    </Link>
                                </div>

                                <div className="relative">
                                    <Input
                                        id="password"
                                        type={showPw ? "text" : "password"}
                                        required
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyUp={(e) => setCapsLock((e as any).getModifierState?.("CapsLock") === true)}
                                        disabled={isLoading}
                                        autoComplete="current-password"
                                    />
                                    <button
                                        type="button"
                                        className="absolute right-2 top-1/2 -translate-y-1/2 rounded-md p-1 text-muted-foreground hover:text-foreground"
                                        onClick={() => setShowPw((s) => !s)}
                                        aria-label={showPw ? "Hide password" : "Show password"}
                                    >
                                        {showPw ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                                    </button>
                                </div>

                                {capsLock && <p className="text-xs text-amber-600 dark:text-amber-400">Caps Lock is ON</p>}
                            </div>

                            <div className="flex items-center justify-between">
                                <label className="flex items-center gap-2 text-sm">
                                    <input
                                        type="checkbox"
                                        className="accent-primary h-4 w-4"
                                        checked={remember}
                                        onChange={(e) => setRemember(e.target.checked)}
                                        disabled={isLoading}
                                    />
                                    Remember me
                                </label>
                            </div>

                            {error && <p className="text-sm text-destructive">{error}</p>}
                        </CardContent>

                        <CardFooter className="flex flex-col gap-3">
                            <Button type="submit" className="w-full" disabled={!canSubmit}>
                                {isLoading ? "Signing In..." : "Sign In"}
                            </Button>
                        </CardFooter>
                    </form>
                )}

                {/* Step 2: OTP / Recovery Code */}
                {challengeToken && (
                    <form onSubmit={handleOtpVerify} noValidate>
                        <CardContent className="space-y-4">
                            <div className="space-y-2">
                                <Label htmlFor="otp">{useRecovery ? "Recovery code" : "Authenticator code"}</Label>
                                <Input
                                    id="otp"
                                    ref={otpRef}
                                    inputMode={useRecovery ? "text" : "numeric"}
                                    placeholder={useRecovery ? "enter a backup code" : "123456"}
                                    value={otp}
                                    onChange={(e) => setOtp(e.target.value)}
                                    disabled={isLoading}
                                />
                                <div className="text-xs text-muted-foreground">
                                    {useRecovery
                                        ? "Enter one of your single-use recovery codes."
                                        : "Open your authenticator app and enter the 6-digit code."}
                                </div>
                            </div>

                            <div className="flex items-center justify-between">
                                <label className="flex items-center gap-2 text-sm">
                                    <input
                                        type="checkbox"
                                        className="accent-primary h-4 w-4"
                                        checked={remember}
                                        onChange={(e) => setRemember(e.target.checked)}
                                        disabled={isLoading}
                                    />
                                    Remember this device
                                </label>

                                <button
                                    type="button"
                                    className="text-sm font-medium text-primary hover:underline"
                                    onClick={() => setUseRecovery((s) => !s)}
                                >
                                    {useRecovery ? "Use 6-digit code" : "Use a recovery code"}
                                </button>
                            </div>

                            {error && <p className="text-sm text-destructive">{error}</p>}
                        </CardContent>

                        <CardFooter className="flex flex-col gap-3">
                            <Button type="submit" className="w-full" disabled={!canSubmitOtp}>
                                {isLoading ? "Verifying..." : "Verify & Sign In"}
                            </Button>
                            <button
                                type="button"
                                className="text-sm text-muted-foreground underline hover:no-underline"
                                onClick={() => {
                                    // allow retrying email+password
                                    setChallengeToken(null);
                                    setOtp("");
                                    setUseRecovery(false);
                                    setError(null);
                                }}
                            >
                                Go back
                            </button>
                        </CardFooter>
                    </form>
                )}
            </Card>
        </div>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[5] FILE
Path       : app/(dashboard)/layout.tsx
Size       : 1,648 bytes
Last Write : 2025-10-17 20:40:58
SHA256     : 2655828F5E938DB77C7759966A996A3F79EEC42160D07F8E1AB953F0A84DF79F
========================================================================================

// app/(dashboard)/layout.tsx
"use client";

import * as React from "react";
import { usePathname } from "next/navigation";
import TopBar from "@/components/top-bar";
import Sidebar from "@/components/sidebar";

/**
 * Dashboard area shell
 * - Global TopBar (fixed 56px).
 * - Optional left Sidebar (only on /devices…; the /customers area renders its own sidebar).
 * - Main content scrolls independently.
 *
 * NOTE: DashboardProvider is already mounted at the app root (via app/providers.tsx),
 * so we intentionally do NOT wrap another provider here to avoid double contexts.
 */
export default function DashboardLayout({ children }: { children: React.ReactNode }) {
    return (
        <div className="min-h-screen">
            <TopBar />
            <SidebarVisibility>{children}</SidebarVisibility>
        </div>
    );
}

/**
 * Shows the global Sidebar only on Devices pages.
 * - Dashboard ("/"): hide sidebar
 * - Customers ("/customers…"): hide (Customers has its own sidebar/layout)
 * - Devices ("/devices…"): show sidebar
 */
function SidebarVisibility({ children }: { children: React.ReactNode }) {
    const pathname = usePathname();
    const showSidebar = pathname?.startsWith("/devices");

    return (
        <div className="flex w-full" style={{ paddingTop: 56 /* TopBar height */ }}>
            {showSidebar && (
                <aside className="hidden md:block w-64 shrink-0 border-r bg-background">
                    <Sidebar />
                </aside>
            )}
            <section className="flex-1 min-w-0">{children}</section>
        </div>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[6] FILE
Path       : app/(dashboard)/dashboard-context.tsx
Size       : 27,762 bytes
Last Write : 2025-10-18 15:51:54
SHA256     : 5C67B55A02CECF874E0FFF995827D40E8AE1D107125C20B63BC7A991791B4BD6
========================================================================================

// app/(dashboard)/dashboard-context.tsx
"use client";

import * as React from "react";
import type {
    ColumnFiltersState,
    SortingState,
    VisibilityState,
} from "@tanstack/react-table";

import { useDevices, type UiFilters as UiDeviceFilters } from "@/lib/use-devices";
import type { Device as ApiDevice } from "@/lib/api";

/** Accept both TitleCase and lowercase (preserving your existing type) */
export type DeviceStatus =
    | "Healthy" | "Warning" | "Critical" | "Offline"
    | "healthy" | "warning" | "critical" | "offline";

export type Device = {
    id: string;
    hostname: string;
    alias?: string | null;
    status: DeviceStatus;
    client: string; // organization
    site: string;
    os: "Windows" | "Linux" | "macOS";
    user?: string | string[] | null;
    lastResponse: string;
};

export type ActiveFilters = {
    status: DeviceStatus[];
    os: Array<Device["os"]>;
};

// Lightweight RGL types (no runtime dep on react-grid-layout here)
export type RglLayout = {
    i: string;
    x: number;
    y: number;
    w: number;
    h: number;
    minW?: number;
    maxW?: number;
    minH?: number;
    maxH?: number;
    static?: boolean;
    moved?: boolean;
    isDraggable?: boolean;
    isResizable?: boolean;
};
export type RglLayouts = {
    lg?: RglLayout[];
    md?: RglLayout[];
    sm?: RglLayout[];
    xs?: RglLayout[];
    xxs?: RglLayout[];
};

export type SavedView = {
    id: string;
    name: string;

    // Table state
    columnVisibility: VisibilityState;
    sorting?: SortingState;
    columnFilters?: ColumnFiltersState;

    // (Customers bits supplied by CustomersProvider via snapshot)
    customersGroupOpen?: boolean;
    expandedOrganizations?: string[];
    expandedSites?: string[];
    activeFilters?: ActiveFilters;

    // Dashboard
    dashboardOrder?: string[];
    dashboardLayouts?: RglLayouts | null;
    dashboardHidden?: string[];
};

/* ----------------------- DEFAULTs ------------------------ */
/** Match the keys used on app/(dashboard)/page.tsx */
export const DEFAULT_DASHBOARD_ORDER: string[] = [
    "kpi-healthy",
    "kpi-critical",
    "kpi-warning",
    "kpi-total",
    "donut-os",
    "heat-status-os",
    "stack-client-sites",
    "donut-client",
    "table-offline",
    "donut-status",
];

/* ----------------------- localStorage helpers ------------------------ */
const LS_SAVED_VIEWS_KEY = "remoteiq.savedViews.v2";
const LS_LAST_VIEW_ID_KEY = "remoteiq.lastSavedViewId.v2";
const LS_ALIASES_KEY = "remoteiq.deviceAliases.v1";
const LS_SIDEBAR_COLLAPSED = "remoteiq.sidebarCollapsed.v1";

function safeReadJSON<T>(key: string, fallback: T): T {
    if (typeof window === "undefined") return fallback;
    try {
        const raw = window.localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
    } catch {
        return fallback;
    }
}
function safeWriteJSON<T>(key: string, value: T) {
    if (typeof window === "undefined") return;
    try {
        window.localStorage.setItem(key, JSON.stringify(value));
    } catch { }
}
const readSavedViews = () => safeReadJSON<SavedView[]>(LS_SAVED_VIEWS_KEY, []);
const writeSavedViews = (v: SavedView[]) => safeWriteJSON(LS_SAVED_VIEWS_KEY, v);
const readLastViewId = () =>
    typeof window !== "undefined" ? window.localStorage.getItem(LS_LAST_VIEW_ID_KEY) : null;
const writeLastViewId = (id: string | null) => {
    if (typeof window === "undefined") return;
    try {
        id
            ? window.localStorage.setItem(LS_LAST_VIEW_ID_KEY, id)
            : window.localStorage.removeItem(LS_LAST_VIEW_ID_KEY);
    } catch { }
};
const readAliases = () => safeReadJSON<Record<string, string>>(LS_ALIASES_KEY, {});
const writeAliases = (map: Record<string, string>) => safeWriteJSON(LS_ALIASES_KEY, map);

/* ----------------------- URL payload ------------------------ */
export type EncodedViewPayload = {
    version: 3;
    columnVisibility: VisibilityState;
    sorting?: SortingState;
    columnFilters?: ColumnFiltersState;

    // From CustomersProvider if present
    customersGroupOpen?: boolean;
    expandedOrganizations?: string[];
    expandedSites?: string[];
    activeFilters?: ActiveFilters;

    // Dashboard
    dashboardOrder?: string[];
    dashboardLayouts?: RglLayouts | null;
    dashboardHidden?: string[];
};

const toBase64Url = (json: string) => {
    const b64 =
        typeof window !== "undefined"
            ? window.btoa(unescape(encodeURIComponent(json)))
            : Buffer.from(json, "utf-8").toString("base64");
    return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
};
const fromBase64Url = (s: string) => {
    const pad = "===".slice((s.length + 3) % 4);
    const norm = s.replace(/-/g, "+").replace(/_/g, "/") + pad;
    const json =
        typeof window !== "undefined"
            ? decodeURIComponent(escape(window.atob(norm)))
            : Buffer.from(norm, "base64").toString("utf-8");
    return json;
};
const encodePayloadToQuery = (p: EncodedViewPayload) => {
    try {
        return toBase64Url(JSON.stringify(p));
    } catch {
        return "";
    }
};
const decodePayloadFromQuery = (s: string | null): EncodedViewPayload | null => {
    if (!s) return null;
    try {
        const parsed = JSON.parse(fromBase64Url(s));
        return parsed?.version >= 2 ? (parsed as EncodedViewPayload) : null;
    } catch {
        return null;
    }
};

/* ----------------------- Snapshot getter ------------------------ */
type Snapshot = {
    columnVisibility: VisibilityState;
    sorting: SortingState;
    columnFilters: ColumnFiltersState;

    // Optional page-specific add-ons (supplied by page providers)
    customersGroupOpen?: boolean;
    expandedOrganizations?: string[];
    expandedSites?: string[];
    activeFilters?: ActiveFilters;

    dashboardOrder?: string[];
    dashboardLayouts?: RglLayouts | null;
    dashboardHidden?: string[];
};
type SnapshotGetter = () => Snapshot;

/* ----------------------- Context ------------------------ */
type DashboardContextType = {
    // data
    masterDevices: Device[];
    filteredDevices: Device[]; // equals masterDevices here; server-side filters applied via useDevices

    // table
    columnVisibility: VisibilityState;
    setColumnVisibility: React.Dispatch<React.SetStateAction<VisibilityState>>;
    sorting: SortingState;
    setSorting: React.Dispatch<React.SetStateAction<SortingState>>;
    columnFilters: ColumnFiltersState;
    setColumnFilters: React.Dispatch<React.SetStateAction<ColumnFiltersState>>;

    // saved views
    savedViews: SavedView[];
    saveCurrentView: (name: string) => void;
    loadView: (id: string) => boolean;
    deleteView: (id: string) => void;
    overwriteViewFromCurrent: (id: string) => boolean;
    renameView: (id: string, newName: string) => boolean;

    // misc filters
    operatingSystems: Array<Device["os"]>;
    activeFilters: ActiveFilters;
    setActiveFilters: React.Dispatch<React.SetStateAction<ActiveFilters>>;

    // dashboard-only state
    dashboardOrder: string[];
    setDashboardOrder: React.Dispatch<React.SetStateAction<string[]>>;
    dashboardLayouts: RglLayouts | null;
    setDashboardLayouts: React.Dispatch<React.SetStateAction<RglLayouts | null>>;
    dashboardHidden: string[];
    setDashboardHidden: React.Dispatch<React.SetStateAction<string[]>>;

    // sidebar UI state
    isSidebarCollapsed: boolean;
    setIsSidebarCollapsed: React.Dispatch<React.SetStateAction<boolean>>;

    // alias editing
    updateDeviceAlias: (id: string, alias: string | null | undefined) => void;

    // Saved Views + page integration
    registerSnapshotGetter: (getter: SnapshotGetter | null) => void;

    // HYDRATION GATE
    ready: boolean;

    // encode current view to URL payload (optionally include dashboard layouts)
    getEncodedCurrentView: (opts?: { includeLayouts?: boolean }) => string;

    // expose decoded payload & subscribe for page providers
    getDecodedViewPayload: () => EncodedViewPayload | null;
    onViewPayload: (cb: (p: EncodedViewPayload) => void) => () => void;
};

const DashboardContext = React.createContext<DashboardContextType | null>(null);
export const useDashboard = () => {
    const ctx = React.useContext(DashboardContext);
    if (!ctx) throw new Error("useDashboard must be used within DashboardProvider");
    return ctx;
};

/* ----------------------- API → UI mapping ------------------------ */
function mapApiToUi(dev: ApiDevice): Device {
    // Map API status "online"/"offline" → UI "Healthy"/"Offline"
    const status: DeviceStatus = dev.status === "online" ? "Healthy" : "Offline";

    // Pass through client/site/user (API types may not declare them yet → optional chain / fallback)
    const anyDev = dev as unknown as {
        client?: string | null;
        site?: string | null;
        user?: string | string[] | null;
    };

    return {
        id: dev.id,
        hostname: dev.hostname || "",
        alias: null,
        status,
        client: anyDev.client ?? "—",
        site: anyDev.site ?? "—",
        user: anyDev.user ?? null,
        os:
            (dev.os?.toLowerCase() === "linux"
                ? "Linux"
                : dev.os?.toLowerCase() === "macos"
                    ? "macOS"
                    : "Windows") as Device["os"],
        lastResponse: dev.lastSeen ?? "—",
    };
}

/* ----------------------- Provider ------------------------ */
export function DashboardProvider({ children }: { children: React.ReactNode }) {
    const [ready, setReady] = React.useState(false);

    // devices from backend (server-side filtered via UiDeviceFilters)
    const {
        items,
        uiFilters,
        setUiFilters,
    } = useDevices(25);

    // Build masterDevices from API items
    const [masterDevices, setMasterDevices] = React.useState<Device[]>([]);
    React.useEffect(() => {
        setMasterDevices((items ?? []).map(mapApiToUi));
    }, [items]);

    // table
    const [columnVisibility, setColumnVisibility] = React.useState<VisibilityState>({});
    const [sorting, setSorting] = React.useState<SortingState>([]);
    const [columnFilters, setColumnFilters] = React.useState<ColumnFiltersState>([]);

    // views
    const [savedViews, setSavedViews] = React.useState<SavedView[]>([]);

    // misc
    const operatingSystems = React.useMemo<Array<Device["os"]>>(
        () => ["Windows", "Linux", "macOS"],
        []
    );
    const [activeFilters, setActiveFilters] = React.useState<ActiveFilters>({
        status: [],
        os: [],
    });

    /* ---------- Dashboard-only ---------- */
    const [dashboardOrder, setDashboardOrder] = React.useState<string[]>(
        DEFAULT_DASHBOARD_ORDER
    );
    const [dashboardLayouts, setDashboardLayouts] = React.useState<RglLayouts | null>(null);
    const [dashboardHidden, setDashboardHidden] = React.useState<string[]>([]);

    /* ---------- Sidebar collapsed UI state ---------- */
    const [isSidebarCollapsed, setIsSidebarCollapsed] = React.useState<boolean>(() => {
        if (typeof window === "undefined") return false;
        try {
            const v = window.localStorage.getItem(LS_SIDEBAR_COLLAPSED);
            return v ? JSON.parse(v) === true : false;
        } catch {
            return false;
        }
    });
    React.useEffect(() => {
        if (typeof window !== "undefined") {
            try {
                window.localStorage.setItem(LS_SIDEBAR_COLLAPSED, JSON.stringify(isSidebarCollapsed));
            } catch { }
        }
    }, [isSidebarCollapsed]);

    /* ---------- Saved Views: persistence ---------- */
    React.useEffect(() => {
        setSavedViews(readSavedViews());
    }, []);
    React.useEffect(() => {
        writeSavedViews(savedViews);
    }, [savedViews]);

    /* ---------- Snapshot getter (page contributes) ---------- */
    const snapshotGetterRef = React.useRef<SnapshotGetter | null>(null);
    const registerSnapshotGetter = React.useCallback((g: SnapshotGetter | null) => {
        snapshotGetterRef.current = g;
    }, []);

    const captureCurrentViewState = React.useCallback(
        (): Omit<SavedView, "id" | "name"> => {
            const snap = snapshotGetterRef.current?.();
            return {
                columnVisibility: snap?.columnVisibility ?? columnVisibility,
                sorting: snap?.sorting ?? sorting,
                columnFilters: snap?.columnFilters ?? columnFilters,

                // Customers bits (if current page provides them)
                customersGroupOpen: snap?.customersGroupOpen,
                expandedOrganizations: snap?.expandedOrganizations,
                expandedSites: snap?.expandedSites,
                activeFilters: snap?.activeFilters ?? activeFilters,

                dashboardOrder: snap?.dashboardOrder ?? dashboardOrder,
                dashboardLayouts: snap?.dashboardLayouts ?? dashboardLayouts ?? null,
                dashboardHidden: snap?.dashboardHidden ?? dashboardHidden ?? [],
            };
        },
        [
            columnVisibility,
            sorting,
            columnFilters,
            dashboardOrder,
            dashboardLayouts,
            dashboardHidden,
            activeFilters,
        ]
    );

    /* ---------- Decoded payload sharing to page providers ---------- */
    const lastDecodedPayloadRef = React.useRef<EncodedViewPayload | null>(null);
    const listenersRef = React.useRef(new Set<(p: EncodedViewPayload) => void>());

    const getDecodedViewPayload = React.useCallback(() => lastDecodedPayloadRef.current, []);
    const onViewPayload = React.useCallback((cb: (p: EncodedViewPayload) => void) => {
        listenersRef.current.add(cb);
        return () => listenersRef.current.delete(cb);
    }, []);
    const emitViewPayload = React.useCallback((p: EncodedViewPayload) => {
        lastDecodedPayloadRef.current = p;
        for (const fn of Array.from(listenersRef.current)) {
            try {
                fn(p);
            } catch { }
        }
    }, []);

    /* ---------- HYDRATE FROM URL / LAST VIEW, THEN RENDER ---------- */
    React.useEffect(() => {
        // aliases (optional)
        const aliases = readAliases();
        if (aliases && Object.keys(aliases).length) {
            setMasterDevices((prev) =>
                prev.map((d) => (aliases[d.id] ? { ...d, alias: aliases[d.id] } : d))
            );
        }

        const url = new URL(window.location.href);
        const encoded = url.searchParams.get("v");
        const payload = decodePayloadFromQuery(encoded);

        if (payload) {
            // apply base/table/dashboard here
            setColumnVisibility(payload.columnVisibility ?? {});
            setSorting(payload.sorting ?? []);
            setColumnFilters(payload.columnFilters ?? []);
            if (Array.isArray(payload.dashboardOrder) && payload.dashboardOrder.length) {
                setDashboardOrder(payload.dashboardOrder);
            }
            if (payload.dashboardLayouts) setDashboardLayouts(payload.dashboardLayouts);
            if (payload.dashboardHidden) setDashboardHidden(payload.dashboardHidden);

            // ✅ restore filters if present
            if (payload.activeFilters) setActiveFilters(payload.activeFilters);

            // let page providers (e.g., Customers) apply their own bits
            emitViewPayload(payload);

            setReady(true);
            return;
        }

        // No ?v= — fall back to last saved view
        const lastId = readLastViewId();
        const views = readSavedViews();
        if (lastId && views.some((v) => v.id === lastId)) {
            const v = views.find((x) => x.id === lastId)!;

            setColumnVisibility(v.columnVisibility ?? {});
            setSorting(v.sorting ?? []);
            setColumnFilters(v.columnFilters ?? []);

            if (Array.isArray(v.dashboardOrder) && v.dashboardOrder.length) {
                setDashboardOrder(v.dashboardOrder);
            }
            setDashboardLayouts(v.dashboardLayouts ?? null);
            setDashboardHidden(v.dashboardHidden ?? []);

            // ✅ also restore filters from the view if present
            if (v.activeFilters) setActiveFilters(v.activeFilters);

            // also emit to page providers so they can adopt customers bits
            emitViewPayload({
                version: 3,
                columnVisibility: v.columnVisibility ?? {},
                sorting: v.sorting ?? [],
                columnFilters: v.columnFilters ?? [],
                customersGroupOpen: v.customersGroupOpen,
                expandedOrganizations: v.expandedOrganizations,
                expandedSites: v.expandedSites,
                activeFilters: v.activeFilters,
                dashboardOrder: v.dashboardOrder,
                dashboardLayouts: v.dashboardLayouts ?? null,
                dashboardHidden: v.dashboardHidden ?? [],
            });
        }

        setReady(true);
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    /* ---------- Bridge ActiveFilters → backend UiFilters ---------- */
    React.useEffect(() => {
        // Map your UI ActiveFilters to the server-side UiDeviceFilters
        const ui: UiDeviceFilters = {
            status: (() => {
                const s = activeFilters.status ?? [];
                const hasOffline = s.some((x) => String(x).toLowerCase() === "offline");
                const hasAnyOnline = s.some((x) => {
                    const v = String(x).toLowerCase();
                    return v === "healthy" || v === "warning" || v === "critical";
                });
                // use-devices consumes lowercase enums
                if (hasOffline && !hasAnyOnline) return ["offline"];
                if (!hasOffline && hasAnyOnline) return ["healthy", "warning", "critical"];
                if (hasOffline && hasAnyOnline) return ["healthy", "warning", "critical", "offline"];
                return undefined;
            })(),
            os: (activeFilters.os ?? []).length
                ? (activeFilters.os as ("Windows" | "Linux" | "macOS")[])
                : undefined,
        };
        setUiFilters(ui);
    }, [activeFilters, setUiFilters]);

    // Encode current view (optionally include layouts/hidden)
    const getEncodedCurrentView = React.useCallback(
        (opts?: { includeLayouts?: boolean }) => {
            const snap = captureCurrentViewState();
            const includeLayouts = !!opts?.includeLayouts;
            return encodePayloadToQuery({
                version: 3,
                columnVisibility: snap.columnVisibility,
                sorting: snap.sorting,
                columnFilters: snap.columnFilters,

                customersGroupOpen: snap.customersGroupOpen,
                expandedOrganizations: snap.expandedOrganizations,
                expandedSites: snap.expandedSites,
                activeFilters: snap.activeFilters,

                dashboardOrder: snap.dashboardOrder,
                ...(includeLayouts
                    ? {
                        dashboardLayouts: snap.dashboardLayouts ?? null,
                        dashboardHidden: snap.dashboardHidden ?? [],
                    }
                    : {}),
            });
        },
        [captureCurrentViewState]
    );

    // alias editing
    const updateDeviceAlias = React.useCallback((id: string, alias?: string | null) => {
        const trimmed = alias?.trim() || "";
        setMasterDevices((prev) => {
            const next = prev.map((d) => (d.id === id ? { ...d, alias: trimmed || null } : d));
            const map: Record<string, string> = {};
            for (const dev of next) if (dev.alias && dev.alias.trim()) map[dev.id] = dev.alias.trim();
            writeAliases(map);
            return next;
        });
    }, []);

    const value: DashboardContextType = {
        // data
        masterDevices,
        filteredDevices: masterDevices, // server-side filtering handled via useDevices + effect above

        // table
        columnVisibility,
        setColumnVisibility,
        sorting,
        setSorting,
        columnFilters,
        setColumnFilters,

        // saved views
        savedViews,
        saveCurrentView: (name: string) => {
            const trimmed = name.trim();
            if (!trimmed) return;

            setSavedViews((prev) => {
                if (prev.some((v) => v.name.toLowerCase() === trimmed.toLowerCase())) return prev;
                const snapshot = captureCurrentViewState();
                const view: SavedView = {
                    id: Math.random().toString(36).slice(2),
                    name: trimmed,
                    ...snapshot,
                };
                const next = [view, ...prev].slice(0, 100);

                const url = new URL(window.location.href);
                url.searchParams.set(
                    "v",
                    encodePayloadToQuery({
                        version: 3,
                        columnVisibility: snapshot.columnVisibility,
                        sorting: snapshot.sorting,
                        columnFilters: snapshot.columnFilters,

                        customersGroupOpen: snapshot.customersGroupOpen,
                        expandedOrganizations: snapshot.expandedOrganizations,
                        expandedSites: snapshot.expandedSites,
                        activeFilters: snapshot.activeFilters,

                        dashboardOrder: snapshot.dashboardOrder,
                    })
                );
                history.replaceState(null, "", url.toString());
                writeLastViewId(view.id);

                return next;
            });
        },
        loadView: (id: string) => {
            let found: SavedView | undefined;
            setSavedViews((prev) => {
                found = prev.find((v) => v.id === id);
                return prev;
            });
            if (!found) return false;

            setColumnVisibility(found.columnVisibility ?? {});
            setSorting(found.sorting ?? []);
            setColumnFilters(found.columnFilters ?? []);
            if (Array.isArray(found.dashboardOrder) && found.dashboardOrder.length) {
                setDashboardOrder(found.dashboardOrder);
            }
            setDashboardLayouts(found.dashboardLayouts ?? null);
            setDashboardHidden(found.dashboardHidden ?? []);

            if (found.activeFilters) setActiveFilters(found.activeFilters);

            const payload: EncodedViewPayload = {
                version: 3,
                columnVisibility: found!.columnVisibility ?? {},
                sorting: found!.sorting ?? [],
                columnFilters: found!.columnFilters ?? [],
                customersGroupOpen: found!.customersGroupOpen,
                expandedOrganizations: found!.expandedOrganizations,
                expandedSites: found!.expandedSites,
                activeFilters: found!.activeFilters,
                dashboardOrder: found!.dashboardOrder ?? DEFAULT_DASHBOARD_ORDER,
                dashboardLayouts: found!.dashboardLayouts ?? null,
                dashboardHidden: found!.dashboardHidden ?? [],
            };

            const url = new URL(window.location.href);
            url.searchParams.set("v", encodePayloadToQuery(payload));
            history.replaceState(null, "", url.toString());
            writeLastViewId(found!.id);

            emitViewPayload(payload);
            return true;
        },
        deleteView: (id: string) => {
            setSavedViews((prev) => {
                const next = prev.filter((v) => v.id !== id);
                const lastId = readLastViewId();
                if (lastId && lastId === id) writeLastViewId(null);
                return next;
            });
        },
        overwriteViewFromCurrent: (id: string) => {
            const snapshot = captureCurrentViewState();
            let ok = false;
            setSavedViews((prev) => {
                const idx = prev.findIndex((v) => v.id === id);
                if (idx === -1) return prev;
                const next = [...prev];
                next[idx] = { ...next[idx], ...snapshot };
                ok = true;

                const payload: EncodedViewPayload = {
                    version: 3,
                    columnVisibility: snapshot.columnVisibility,
                    sorting: snapshot.sorting,
                    columnFilters: snapshot.columnFilters,
                    customersGroupOpen: snapshot.customersGroupOpen,
                    expandedOrganizations: snapshot.expandedOrganizations,
                    expandedSites: snapshot.expandedSites,
                    activeFilters: snapshot.activeFilters,
                    dashboardOrder: snapshot.dashboardOrder,
                    dashboardLayouts: snapshot.dashboardLayouts ?? null,
                    dashboardHidden: snapshot.dashboardHidden ?? [],
                };

                const url = new URL(window.location.href);
                url.searchParams.set("v", encodePayloadToQuery(payload));
                history.replaceState(null, "", url.toString());
                writeLastViewId(next[idx].id);

                emitViewPayload(payload);
                return next;
            });
            return ok;
        },
        renameView: (id: string, newName: string) => {
            const trimmed = newName.trim();
            if (!trimmed) return false;
            let ok = false;
            setSavedViews((prev) => {
                if (prev.some((v) => v.name.toLowerCase() === trimmed.toLowerCase() && v.id !== id)) {
                    return prev;
                }
                const idx = prev.findIndex((v) => v.id === id);
                if (idx === -1) return prev;
                const next = [...prev];
                next[idx] = { ...next[idx], name: trimmed };
                ok = true;
                return next;
            });
            return ok;
        },

        // misc
        operatingSystems,
        activeFilters,
        setActiveFilters,

        // dashboard-only
        dashboardOrder,
        setDashboardOrder,
        dashboardLayouts,
        setDashboardLayouts,
        dashboardHidden,
        setDashboardHidden,

        // sidebar state
        isSidebarCollapsed,
        setIsSidebarCollapsed,

        // alias
        updateDeviceAlias,

        // page integration
        registerSnapshotGetter,

        // hydration
        ready,

        // share link
        getEncodedCurrentView,

        // decoded view payload sharing
        getDecodedViewPayload,
        onViewPayload,
    };

    // Gate children until URL/last-view hydration is done (prevents flicker)
    if (!ready) return null;

    return <DashboardContext.Provider value={value}>{children}</DashboardContext.Provider>;
}



----------------------------------------------------------------------------------------



========================================================================================
[7] FILE
Path       : app/(dashboard)/page.tsx
Size       : 21,262 bytes
Last Write : 2025-10-17 20:40:06
SHA256     : D577004C6A98BF31584293B139CA0D4D2BEAB0B65EDDE67B3AF465C86ED99162
========================================================================================

// app/(dashboard)/page.tsx
"use client";

import * as React from "react";
import { useDashboard } from "@/app/(dashboard)/dashboard-context";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { GripVertical, SlidersHorizontal } from "lucide-react";

import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuCheckboxItem,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

import {
  Responsive as ResponsiveGrid,
  WidthProvider,
  type Layouts,
  type Layout,
} from "react-grid-layout";
import "react-grid-layout/css/styles.css";
import "react-resizable/css/styles.css";

import {
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend,
  Tooltip as RTooltip,
  BarChart,
  Bar,
  CartesianGrid,
  XAxis,
  YAxis,
} from "recharts";

/* ----------------------------- helpers / colors ---------------------------- */
type DonutDatum = { name: string; value: number };
type ClientDatum = { name: string; value: number };
type HeatRow = { os: string; Healthy: number; Warning: number; Critical: number; Offline: number };

const STATUS_KEYS = ["Healthy", "Warning", "Critical", "Offline"] as const;
const OS_KEYS = ["Windows", "Linux", "macOS"] as const;

const HUES = {
  Healthy: "hsl(151 55% 41%)",
  Warning: "hsl(37 92% 50%)",
  Critical: "hsl(0 84% 60%)",
  Offline: "hsl(215 20% 65%)",
  Windows: "hsl(226 70% 55%)",
  Linux: "hsl(173 80% 40%)",
  macOS: "hsl(258 90% 66%)",
} as const;

function norm(s: string | unknown) {
  const t = String(s || "").toLowerCase();
  if (t === "healthy") return "Healthy";
  if (t === "warning") return "Warning";
  if (t === "critical") return "Critical";
  return "Offline";
}
function countBy<T, K extends string>(arr: T[], keyFn: (x: T) => K): Record<K, number> {
  return arr.reduce((acc, item) => {
    const k = keyFn(item);
    acc[k] = (acc[k] ?? 0) + 1;
    return acc;
  }, {} as Record<K, number>);
}
function pickPalette(i: number) {
  const palette = [
    "hsl(210 80% 60%)",
    "hsl(275 80% 70%)",
    "hsl(160 75% 45%)",
    "hsl(20 85% 60%)",
    "hsl(335 75% 60%)",
    "hsl(45 90% 55%)",
    "hsl(190 80% 55%)",
    "hsl(125 60% 40%)",
  ];
  return palette[i % palette.length];
}
function buildClientSiteMatrix(devices: { client: string; site: string }[]) {
  const byClient: Record<string, Record<string, number>> = {};
  for (const d of devices) {
    byClient[d.client] ??= {};
    byClient[d.client][d.site] = (byClient[d.client][d.site] ?? 0) + 1;
  }
  return Object.entries(byClient).map(([client, sites]) => ({ client, ...sites }));
}
function uniqueSites(devices: { site: string }[]) {
  return Array.from(new Set(devices.map((d) => d.site)));
}

/* --------------------------------- cards ---------------------------------- */
function KpiCard({ title, value }: { title: string; value: number | string }) {
  return (
    <Card className="relative h-full">
      <CardHeader className="pb-2">
        <div className="flex items-start justify-between">
          <CardTitle className="text-sm text-muted-foreground">{title}</CardTitle>
          <Button
            variant="ghost"
            size="icon"
            title="Move"
            className="move-handle h-6 w-6 cursor-grab active:cursor-grabbing"
          >
            <GripVertical className="h-4 w-4" />
          </Button>
        </div>
      </CardHeader>
      <CardContent className="pt-0 pb-4">
        <div className="text-2xl font-semibold leading-none">{value}</div>
      </CardContent>
    </Card>
  );
}

function ChartCard({ title, children }: { title: string; children: React.ReactNode }) {
  return (
    <Card className="relative h-full flex flex-col">
      <CardHeader className="pb-2 shrink-0">
        <div className="flex items-start justify-between">
          <CardTitle className="text-sm text-muted-foreground">{title}</CardTitle>
          <Button
            variant="ghost"
            size="icon"
            title="Move"
            className="move-handle h-6 w-6 cursor-grab active:cursor-grabbing"
          >
            <GripVertical className="h-4 w-4" />
          </Button>
        </div>
      </CardHeader>
      <CardContent className="pt-0 grow min-h-0">
        <div className="h-full">{children}</div>
      </CardContent>
    </Card>
  );
}

/* --------------------------------- page ----------------------------------- */
const RGL = WidthProvider(ResponsiveGrid);

// Grid rhythm: SMALL = 1 unit; LARGE = 3 units.
const rowHeight = 12;
const SMALL = 8; // 1 small unit
const LARGE = SMALL * 3; // 3 small units

// Card catalog (for Customize menu + layout filtering)
const CARD_CATALOG: { key: string; label: string }[] = [
  { key: "kpi-healthy", label: "KPI: Healthy" },
  { key: "kpi-critical", label: "KPI: Critical" },
  { key: "kpi-warning", label: "KPI: Warning" },
  { key: "kpi-total", label: "KPI: Total Endpoints" },
  { key: "donut-os", label: "OS Distribution" },
  { key: "heat-status-os", label: "Status × OS Heatmap" },
  { key: "stack-client-sites", label: "Clients → Sites (Stacked)" },
  { key: "donut-client", label: "Endpoints by Client" },
  { key: "table-offline", label: "Offline > 24h" },
  { key: "donut-status", label: "Status Distribution" },
];

export default function DashboardPage() {
  const {
    masterDevices,

    // dashboard state in context (persisted by Saved Views / URL)
    dashboardHidden,
    setDashboardHidden,
    dashboardLayouts,
    setDashboardLayouts,
    setDashboardOrder, // we'll derive an order and keep it in context
    registerSnapshotGetter, // so Saved Views capture layouts/hidden/order
  } = useDashboard();

  // KPIs
  const totals = React.useMemo(() => {
    const total = masterDevices.length;
    const byStatus = countBy(masterDevices, (d: any) => norm(d.status));
    return {
      total,
      healthy: byStatus.Healthy ?? 0,
      critical: byStatus.Critical ?? 0,
      warning: byStatus.Warning ?? 0,
    };
  }, [masterDevices]);

  // Chart data
  const statusData: DonutDatum[] = React.useMemo(() => {
    const byStatus = countBy(masterDevices, (d: any) => norm(d.status));
    return STATUS_KEYS.map((k) => ({ name: k, value: byStatus[k] ?? 0 }));
  }, [masterDevices]);

  const osData: DonutDatum[] = React.useMemo(() => {
    const byOs = countBy(masterDevices, (d: any) => d.os);
    return OS_KEYS.map((k) => ({ name: k, value: byOs[k] ?? 0 }));
  }, [masterDevices]);

  const clientsDonut: ClientDatum[] = React.useMemo(() => {
    const byClient = countBy(masterDevices, (d: any) => d.client);
    return Object.entries(byClient).map(([name, value]) => ({ name, value }));
  }, [masterDevices]);

  const heatRows: HeatRow[] = React.useMemo(() => {
    return OS_KEYS.map((os) => {
      const subset = masterDevices.filter((d: any) => d.os === os);
      const byStatus = countBy(subset, (d: any) => norm(d.status));
      return {
        os,
        Healthy: byStatus.Healthy ?? 0,
        Warning: byStatus.Warning ?? 0,
        Critical: byStatus.Critical ?? 0,
        Offline: byStatus.Offline ?? 0,
      };
    });
  }, [masterDevices]);

  const offlineOver24 = React.useMemo(() => {
    return masterDevices
      .filter((d: any) => norm(d.status) === "Offline")
      .map((d: any) => ({
        id: d.id,
        hostname: d.alias || d.hostname,
        client: d.client,
        site: d.site,
        lastResponse: d.lastResponse,
      }));
  }, [masterDevices]);

  /* -------------------------- react-grid-layout setup ----------------------- */
  // All breakpoints, derived from a local base LG, computed once (no dangling deps)
  const initialLayouts: Layouts = React.useMemo(() => {
    const baseLg: Layout[] = [
      // Row 1 (all SMALL)
      { i: "kpi-healthy", x: 0, y: 0, w: 3, h: SMALL },
      { i: "kpi-critical", x: 3, y: 0, w: 3, h: SMALL },
      { i: "kpi-warning", x: 6, y: 0, w: 3, h: SMALL },
      { i: "kpi-total", x: 9, y: 0, w: 3, h: SMALL },

      // Row 2 (all LARGE, start at y = SMALL)
      { i: "donut-os", x: 0, y: SMALL, w: 6, h: LARGE },
      { i: "heat-status-os", x: 6, y: SMALL, w: 6, h: LARGE },

      // Row 3 (all LARGE, start at y = SMALL + LARGE = 4*SMALL)
      { i: "stack-client-sites", x: 0, y: SMALL + LARGE, w: 6, h: LARGE },
      { i: "donut-client", x: 6, y: SMALL + LARGE, w: 6, h: LARGE },

      // Row 4 (all LARGE)
      { i: "table-offline", x: 0, y: SMALL + LARGE * 2, w: 6, h: LARGE },
      { i: "donut-status", x: 6, y: SMALL + LARGE * 2, w: 6, h: LARGE },
    ];

    return {
      lg: baseLg,
      md: baseLg.map((l) => ({
        ...l,
        w: Math.min(10, l.w),
        x: Math.min(l.x, 10 - Math.min(10, l.w)),
      })),
      sm: baseLg.map((l) => ({ ...l, w: Math.min(8, l.w), x: 0 })),
      xs: baseLg.map((l) => ({ ...l, w: Math.min(6, l.w), x: 0 })),
      xxs: baseLg.map((l) => ({ ...l, w: Math.min(4, l.w), x: 0 })),
    };
  }, []);

  // Local state mirrors context.dashboardLayouts (for RGL controlled mode)
  const [allLayouts, setAllLayouts] = React.useState<Layouts>(initialLayouts);

  // On mount / when payload loads a view: sync local state from context
  React.useEffect(() => {
    if (dashboardLayouts && Object.keys(dashboardLayouts).length) {
      setAllLayouts(dashboardLayouts);
    } else {
      // if nothing saved yet, ensure context has our initial layout
      setDashboardLayouts(initialLayouts);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [dashboardLayouts]);

  // Visible keys / hidden handling
  const isHidden = React.useCallback(
    (key: string) => dashboardHidden.includes(key),
    [dashboardHidden]
  );
  const visibleKeys = React.useMemo(
    () => new Set(CARD_CATALOG.map((c) => c.key).filter((k) => !isHidden(k))),
    [isHidden]
  );

  // Filter layouts to only visible items (so RGL doesn’t render holes)
  const visibleLayouts = React.useMemo<Layouts>(() => {
    const out: Layouts = {};
    (["lg", "md", "sm", "xs", "xxs"] as const).forEach((bp) => {
      out[bp] = (allLayouts[bp] ?? []).filter((l) => visibleKeys.has(l.i));
    });
    return out;
  }, [allLayouts, visibleKeys]);

  // Helper: derive a stable order from the LG layout (sort by y then x)
  const deriveOrder = React.useCallback((lg: Layout[]) => {
    return [...lg].sort((a, b) => a.y - b.y || a.x - b.x).map((l) => l.i);
  }, []);

  // Merge updates from RGL (visible items) back into the full layout (keeps hidden positions)
  const onLayoutChange = (_: Layout[], updatedVisible: Layouts) => {
    const merged: Layouts = {};
    (["lg", "md", "sm", "xs", "xxs"] as const).forEach((bp) => {
      const old = allLayouts[bp] ?? [];
      const vis = updatedVisible[bp] ?? [];
      const hidden = old.filter((l) => !visibleKeys.has(l.i));
      merged[bp] = [...vis, ...hidden];
    });
    setAllLayouts(merged);
    setDashboardLayouts(merged);
    // keep a readable order in context too (from LG)
    setDashboardOrder(deriveOrder(merged.lg ?? []));
  };

  // Customize menu helpers
  const setHidden = React.useCallback(
    (key: string, hidden: boolean) => {
      setDashboardHidden((prev) =>
        hidden ? (prev.includes(key) ? prev : [...prev, key]) : prev.filter((k) => k !== key)
      );
    },
    [setDashboardHidden]
  );

  const visibleCount = CARD_CATALOG.length - dashboardHidden.length;
  const allVisible = visibleCount === CARD_CATALOG.length;
  const noneVisible = visibleCount === 0;

  const selectAll = React.useCallback(() => setDashboardHidden([]), [setDashboardHidden]);
  const clearAll = React.useCallback(
    () => setDashboardHidden(CARD_CATALOG.map((c) => c.key)),
    [setDashboardHidden]
  );

  // ✅ Register a snapshot getter so Saved Views capture layouts + hidden + order
  React.useEffect(() => {
    registerSnapshotGetter?.(() => ({
      // table state not on this page; only dashboard bits matter
      columnVisibility: {},
      sorting: [],
      columnFilters: [],

      dashboardOrder: deriveOrder((dashboardLayouts?.lg ?? allLayouts.lg) ?? []),
      dashboardLayouts: dashboardLayouts ?? allLayouts,
      dashboardHidden,
    }));

    return () => registerSnapshotGetter?.(null);
  }, [registerSnapshotGetter, dashboardHidden, dashboardLayouts, allLayouts, deriveOrder]);

  // helpers
  const KPI = (title: string, value: number | string) => <KpiCard title={title} value={value} />;

  const Donut = (title: string, data: DonutDatum[]) => (
    <ChartCard title={title}>
      <ResponsiveContainer width="100%" height="100%">
        <PieChart>
          <Pie
            data={data}
            dataKey="value"
            nameKey="name"
            innerRadius="60%"
            outerRadius="80%"
            stroke="hsl(var(--card))"
            strokeWidth={2}
            isAnimationActive={false}
          >
            {data.map((d, i) => (
              <Cell key={d.name} fill={(HUES as any)[d.name] ?? pickPalette(i)} />
            ))}
          </Pie>
          <Legend verticalAlign="bottom" height={24} />
          <RTooltip />
        </PieChart>
      </ResponsiveContainer>
    </ChartCard>
  );

  const Heat = () => (
    <ChartCard title="Status × OS Heatmap">
      <ResponsiveContainer width="100%" height="100%">
        <BarChart data={heatRows} margin={{ left: 16, right: 16 }}>
          <CartesianGrid strokeDasharray="3 3" opacity={0.2} />
          <XAxis dataKey="os" />
          <YAxis allowDecimals={false} />
          <Legend />
          <RTooltip />
          <Bar dataKey="Critical" stackId="s" fill={HUES.Critical} />
          <Bar dataKey="Warning" stackId="s" fill={HUES.Warning} />
          <Bar dataKey="Healthy" stackId="s" fill={HUES.Healthy} />
          <Bar dataKey="Offline" stackId="s" fill={HUES.Offline} />
        </BarChart>
      </ResponsiveContainer>
    </ChartCard>
  );

  const Stacked = () => (
    <ChartCard title="Clients → Sites (Stacked)">
      <ResponsiveContainer width="100%" height="100%">
        <BarChart
          data={buildClientSiteMatrix(masterDevices as any)}
          stackOffset="expand"
          margin={{ left: 16, right: 16 }}
        >
          <CartesianGrid strokeDasharray="3 3" opacity={0.2} />
          <XAxis dataKey="client" />
          <YAxis tickFormatter={(v) => `${Math.round((v as number) * 100)}%`} />
          <Legend />
          <RTooltip />
          {uniqueSites(masterDevices as any).map((site, i) => (
            <Bar key={site} dataKey={site} stackId="a" fill={pickPalette(i)} />
          ))}
        </BarChart>
      </ResponsiveContainer>
    </ChartCard>
  );

  const OfflineTable = () => (
    <ChartCard title="Offline > 24h">
      <div className="h-full overflow-auto">
        <table className="w-full text-sm">
          <thead className="text-muted-foreground">
            <tr className="border-b">
              <th className="py-2 text-left font-medium">Hostname</th>
              <th className="py-2 text-left font-medium">Client</th>
              <th className="py-2 text-left font-medium">Site</th>
              <th className="py-2 text-left font-medium">Last Response</th>
            </tr>
          </thead>
          <tbody>
            {offlineOver24.length === 0 ? (
              <tr>
                <td className="py-6 text-center text-muted-foreground" colSpan={4}>
                  No offline endpoints over 24h 🎉
                </td>
              </tr>
            ) : (
              offlineOver24.map((r) => (
                <tr key={r.id} className="border-b last:border-0">
                  <td className="py-2">{r.hostname}</td>
                  <td className="py-2">{r.client}</td>
                  <td className="py-2">{r.site}</td>
                  <td className="py-2">{r.lastResponse}</td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </ChartCard>
  );

  /* --------------------------------- render --------------------------------- */
  return (
    <main className="p-4 sm:p-6">
      {/* Quick filters + Customize */}
      <div className="mb-3 flex items-center justify-between gap-2">
        <div className="flex flex-wrap items-center gap-2 text-xs text-muted-foreground">
          <span className="font-medium text-foreground">Quick Filters</span>
          <span className="rounded-full bg-secondary px-2 py-1">Healthy</span>
          <span className="rounded-full bg-secondary px-2 py-1">Warning</span>
          <span className="rounded-full bg-secondary px-2 py-1">Critical</span>
          <span className="rounded-full bg-secondary px-2 py-1">Offline</span>
          <span className="rounded-full bg-secondary px-2 py-1">Windows</span>
          <span className="rounded-full bg-secondary px-2 py-1">Linux</span>
          <span className="rounded-full bg-secondary px-2 py-1">macOS</span>
        </div>

        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="outline" size="sm" className="gap-2" title="Show or hide dashboard cards">
              <SlidersHorizontal className="h-4 w-4" />
              Customize
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end" className="w-64">
            <DropdownMenuLabel>
              Cards ({CARD_CATALOG.length - dashboardHidden.length}/{CARD_CATALOG.length})
            </DropdownMenuLabel>
            <DropdownMenuSeparator />
            {CARD_CATALOG.map(({ key, label }) => (
              <DropdownMenuCheckboxItem
                key={key}
                checked={!isHidden(key)}
                onCheckedChange={(checked) => setHidden(key, !checked)}
                className="truncate"
              >
                {label}
              </DropdownMenuCheckboxItem>
            ))}
            <DropdownMenuSeparator />
            <DropdownMenuItem
              onSelect={(e) => {
                e.preventDefault();
                selectAll();
              }}
              disabled={allVisible}
            >
              Show all
            </DropdownMenuItem>
            <DropdownMenuItem
              onSelect={(e) => {
                e.preventDefault();
                clearAll();
              }}
              disabled={noneVisible}
            >
              Hide all
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>

      <RGL
        className="layout"
        layouts={visibleLayouts}
        breakpoints={{ lg: 1200, md: 996, sm: 768, xs: 560, xxs: 0 }}
        cols={{ lg: 12, md: 10, sm: 8, xs: 6, xxs: 4 }}
        rowHeight={rowHeight}
        margin={[12, 12]}
        containerPadding={[0, 0]}
        draggableHandle=".move-handle"
        onLayoutChange={onLayoutChange}
        compactType="vertical"
      >
        {/* Row 1: SMALL */}
        {!isHidden("kpi-healthy") && (
          <div key="kpi-healthy" className="h-full">
            {KPI("Healthy", totals.healthy)}
          </div>
        )}
        {!isHidden("kpi-critical") && (
          <div key="kpi-critical" className="h-full">
            {KPI("Critical", totals.critical)}
          </div>
        )}
        {!isHidden("kpi-warning") && (
          <div key="kpi-warning" className="h-full">
            {KPI("Warning", totals.warning)}
          </div>
        )}
        {!isHidden("kpi-total") && (
          <div key="kpi-total" className="h-full">
            {KPI("Total Endpoints", totals.total)}
          </div>
        )}

        {/* Row 2: LARGE */}
        {!isHidden("donut-os") && (
          <div key="donut-os" className="h-full">
            {Donut("OS Distribution", osData)}
          </div>
        )}
        {!isHidden("heat-status-os") && (
          <div key="heat-status-os" className="h-full">
            {Heat()}
          </div>
        )}

        {/* Row 3: LARGE */}
        {!isHidden("stack-client-sites") && (
          <div key="stack-client-sites" className="h-full">
            {Stacked()}
          </div>
        )}
        {!isHidden("donut-client") && (
          <div key="donut-client" className="h-full">
            {Donut("Endpoints by Client", clientsDonut)}
          </div>
        )}

        {/* Row 4: LARGE */}
        {!isHidden("table-offline") && (
          <div key="table-offline" className="h-full">
            {OfflineTable()}
          </div>
        )}
        {!isHidden("donut-status") && (
          <div key="donut-status" className="h-full">
            {Donut("Status Distribution", statusData)}
          </div>
        )}
      </RGL>
    </main>
  );
}



----------------------------------------------------------------------------------------



========================================================================================
[8] FILE
Path       : app/customers/customers-context.tsx
Size       : 8,997 bytes
Last Write : 2025-10-17 20:37:13
SHA256     : 52DE43ECD687089BA4CE603AF3706F84B1EDE5C47743CFD811B024FFE7B9D95C
========================================================================================

// app/customers/customers-context.tsx
"use client";

import * as React from "react";
import {
    useDashboard,
    type Device,
    type DeviceStatus,
    type EncodedViewPayload,
} from "@/app/(dashboard)/dashboard-context";

/**
 * Customers page–scoped context
 * - Owns: Customers group open, expanded orgs/sites.
 * - Reads filters from DashboardProvider (single source of truth).
 * - Applies Saved View payloads (initial + subsequent loads).
 */

type OS = Device["os"];

export type CustomersContextType = {
    // Data
    masterDevices: Array<{
        id: string;
        hostname: string;
        alias?: string | null;
        client: string;
        site: string;
        status?: string;
        os?: string;
        user?: string | string[] | null;
        lastResponse?: string;
    }>;
    filteredDevices: CustomersContextType["masterDevices"];

    // Customers tree & expansion
    customersGroupOpen: boolean;
    toggleCustomersGroup: (open?: boolean) => void;
    expandedOrganizations: Set<string>;
    expandedSites: Set<string>;
    onExpandChange: (
        kind: "organization" | "site",
        id: string,
        expanded: boolean,
        childSiteIds?: string[]
    ) => void;
    clearExpanded: () => void;

    // Filters (Status / OS) — mirrored from Dashboard context
    activeFilters: { status: DeviceStatus[]; os: OS[] };
    setActiveFilters: React.Dispatch<
        React.SetStateAction<{ status: DeviceStatus[]; os: OS[] }>
    >;
};

const CustomersContext = React.createContext<CustomersContextType | null>(null);

export function useCustomers() {
    const ctx = React.useContext(CustomersContext);
    if (!ctx) throw new Error("useCustomers must be used within CustomersProvider");
    return ctx;
}

export function CustomersProvider({ children }: { children: React.ReactNode }) {
    // Global (single source of truth)
    const {
        masterDevices: globalDevices,
        activeFilters,
        setActiveFilters,
        getDecodedViewPayload,
        onViewPayload,
    } = useDashboard();

    // Local open/expanded state
    const [customersGroupOpen, setCustomersGroupOpen] = React.useState(true);
    const [expandedOrganizations, setExpandedOrganizations] =
        React.useState<Set<string>>(new Set());
    const [expandedSites, setExpandedSites] =
        React.useState<Set<string>>(new Set());

    const toggleCustomersGroup = React.useCallback((open?: boolean) => {
        setCustomersGroupOpen((prev) => (typeof open === "boolean" ? open : !prev));
    }, []);

    const clearExpanded = React.useCallback(() => {
        setExpandedOrganizations(new Set());
        setExpandedSites(new Set());
    }, []);

    const onExpandChange = React.useCallback(
        (
            kind: "organization" | "site",
            id: string,
            expanded: boolean,
            childSiteIds?: string[]
        ) => {
            if (kind === "organization") {
                setExpandedOrganizations((prev) => {
                    const next = new Set(prev);
                    if (expanded) next.add(id);
                    else next.delete(id);
                    return next;
                });

                // Optional: collapse sites when an org collapses
                if (childSiteIds && Array.isArray(childSiteIds)) {
                    setExpandedSites((prev) => {
                        const next = new Set(prev);
                        if (!expanded) for (const s of childSiteIds) next.delete(s);
                        return next;
                    });
                }
            } else {
                setExpandedSites((prev) => {
                    const next = new Set(prev);
                    if (expanded) next.add(id);
                    else next.delete(id);
                    return next;
                });
            }
        },
        []
    );

    // Normalize devices for table consumption
    const masterDevices = React.useMemo(
        () =>
            (globalDevices ?? []).map((d) => ({
                id: d.id,
                hostname: d.hostname,
                alias: d.alias ?? null,
                client: d.client,
                site: d.site,
                status: d.status,
                os: d.os,
                user: d.user ?? null,
                lastResponse: d.lastResponse,
            })),
        [globalDevices]
    );

    // --- Helpers for filtering (stable refs) ---
    const norm = React.useCallback(
        (s: unknown) => String(s ?? "").trim().toLowerCase(),
        []
    );
    const normStatus = React.useCallback(
        (s: unknown): DeviceStatus => norm(s) as DeviceStatus,
        [norm]
    );

    const filteredDevices = React.useMemo(() => {
        let base: CustomersContextType["masterDevices"] = [];

        const anySites = expandedSites.size > 0;
        const anyOrgs = expandedOrganizations.size > 0;

        if (anySites) {
            // Fix: if sites are selected and some orgs are also selected,
            // require BOTH the site and the org to match to avoid cross-org site name collisions.
            base = masterDevices.filter((d) => {
                const siteMatch = expandedSites.has(d.site);
                const orgGate = anyOrgs ? expandedOrganizations.has(d.client) : true;
                return siteMatch && orgGate;
            });
        } else if (anyOrgs) {
            base = masterDevices.filter((d) => expandedOrganizations.has(d.client));
        } else {
            base = [];
        }

        // Status filter
        if (activeFilters.status.length) {
            const wanted = new Set(activeFilters.status.map((s) => normStatus(s)));
            base = base.filter((d) => wanted.has(normStatus(d.status)));
        }

        // OS filter
        if (activeFilters.os.length) {
            const wantedOS = new Set(activeFilters.os);
            base = base.filter((d) => d.os && wantedOS.has(d.os as OS));
        }

        return base;
    }, [
        masterDevices,
        expandedSites,
        expandedOrganizations,
        activeFilters,
        normStatus, // ✅ stable callback included (fixes the ESLint warning)
    ]);

    // --- Apply payloads (initial + subsequent loads) ---
    const applyPayload = React.useCallback(
        (p: EncodedViewPayload | null | undefined) => {
            if (!p) return;

            // Customers tree state
            if (typeof p.customersGroupOpen === "boolean") {
                setCustomersGroupOpen(p.customersGroupOpen);
            }
            if (Array.isArray(p.expandedOrganizations)) {
                setExpandedOrganizations(new Set(p.expandedOrganizations));
            }
            if (Array.isArray(p.expandedSites)) {
                setExpandedSites(new Set(p.expandedSites));
            }

            // Filters (use global setter so FiltersRail reflects it)
            if (p.activeFilters) {
                const status = Array.isArray(p.activeFilters.status)
                    ? (p.activeFilters.status as DeviceStatus[])
                    : [];
                const os = Array.isArray(p.activeFilters.os)
                    ? (p.activeFilters.os as OS[])
                    : [];
                setActiveFilters({ status, os });
            }
        },
        [setActiveFilters]
    );

    // 1) Apply any decoded payload already present (e.g., from URL on first paint)
    React.useEffect(() => {
        applyPayload(getDecodedViewPayload?.());
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    // 2) Subscribe to future payloads (Saved View loads / share link apply)
    React.useEffect(() => {
        const off = onViewPayload?.((p) => applyPayload(p));
        return () => {
            off && off();
        };
    }, [onViewPayload, applyPayload]);

    // Memoize the context value to limit downstream renders
    const value = React.useMemo<CustomersContextType>(
        () => ({
            masterDevices,
            filteredDevices,
            customersGroupOpen,
            toggleCustomersGroup,
            expandedOrganizations,
            expandedSites,
            onExpandChange,
            clearExpanded,
            activeFilters,
            setActiveFilters,
        }),
        [
            masterDevices,
            filteredDevices,
            customersGroupOpen,
            toggleCustomersGroup,
            expandedOrganizations,
            expandedSites,
            onExpandChange,
            clearExpanded,
            activeFilters,
            setActiveFilters,
        ]
    );

    return (
        <CustomersContext.Provider value={value}>
            {children}
        </CustomersContext.Provider>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[9] FILE
Path       : app/customers/customers-sidebar.tsx
Size       : 11,272 bytes
Last Write : 2025-10-17 20:36:17
SHA256     : F7109BA72D6EB301C5CAB334CE2C794C6F52046C103774976E28578DFBB66F45
========================================================================================

// app/customers/customers-sidebar.tsx
"use client";

import * as React from "react";
import { useRouter, usePathname } from "next/navigation";
import { ChevronRight } from "lucide-react";
import { cn } from "@/lib/utils";
import { useCustomers } from "./customers-context";

/**
 * Customers Sidebar
 * - Badges show endpoint counts:
 *   • Root "Customers" badge: total endpoints
 *   • Org badge: total endpoints in that org
 *   • Site badge: total endpoints in that site
 */

export default function CustomersSidebar() {
    const router = useRouter();
    const pathname = usePathname();

    const {
        customersGroupOpen,
        toggleCustomersGroup,
        expandedOrganizations,
        expandedSites,
        onExpandChange,
        masterDevices,
    } = useCustomers();

    // Build orgs, sites list, and endpoint counts
    const { orgs, sitesByOrg, siteDeviceCounts, orgDeviceCounts, totalEndpoints } =
        React.useMemo(() => {
            const orgSet = new Set<string>();
            const sitesMap: Record<string, string[]> = {};
            const siteCounts: Record<string, Record<string, number>> = {};
            const orgCounts: Record<string, number> = {};
            let total = 0;

            for (const d of masterDevices) {
                total += 1;
                orgSet.add(d.client);

                // sites per org
                if (!sitesMap[d.client]) sitesMap[d.client] = [];
                if (!sitesMap[d.client].includes(d.site)) sitesMap[d.client].push(d.site);

                // site endpoint counts
                if (!siteCounts[d.client]) siteCounts[d.client] = {};
                siteCounts[d.client][d.site] = (siteCounts[d.client][d.site] ?? 0) + 1;

                // org endpoint counts
                orgCounts[d.client] = (orgCounts[d.client] ?? 0) + 1;
            }

            const sortedOrgs = Array.from(orgSet).sort();
            for (const org of Object.keys(sitesMap)) {
                sitesMap[org].sort();
            }

            return {
                orgs: sortedOrgs,
                sitesByOrg: sitesMap,
                siteDeviceCounts: siteCounts,
                orgDeviceCounts: orgCounts,
                totalEndpoints: total,
            };
        }, [masterDevices]);

    const goCustomers = React.useCallback(() => {
        if (!customersGroupOpen) toggleCustomersGroup(true);
        if (pathname !== "/customers") router.push("/customers");
    }, [customersGroupOpen, pathname, router, toggleCustomersGroup]);

    // a11y: keyboard toggle helpers for org/site rows
    const onKeyToggle =
        (fn: () => void) =>
            (e: React.KeyboardEvent<HTMLButtonElement>) => {
                if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    fn();
                }
            };

    return (
        <aside
            className="w-64 shrink-0 border-r bg-background"
            aria-label="Customers sidebar"
            style={{ height: "calc(100vh - 56px)" }} // below fixed TopBar (56px tall)
        >
            {/* Tree container for better a11y */}
            <div className="p-2 text-sm" role="tree" aria-label="Customers Tree">
                {/* Root: Customers (badge = total endpoints) */}
                <button
                    type="button"
                    role="treeitem"
                    aria-level={1}
                    aria-selected={pathname === "/customers"}
                    aria-expanded={customersGroupOpen}
                    onClick={goCustomers}
                    onKeyDown={onKeyToggle(goCustomers)}
                    className={cn(
                        "flex w-full items-center gap-2 rounded px-2 py-1.5 hover:bg-accent hover:text-accent-foreground",
                        pathname === "/customers" && "bg-accent"
                    )}
                    title="Customers"
                    aria-controls="customers-tree-root"
                >
                    <ChevronRight
                        className={cn(
                            "h-4 w-4 transition-transform",
                            customersGroupOpen && "rotate-90"
                        )}
                        aria-hidden="true"
                    />
                    <span className="font-medium">Customers</span>
                    <span className="ml-auto rounded bg-muted px-1.5 text-xs text-muted-foreground">
                        {totalEndpoints}
                    </span>
                </button>

                {/* Orgs & Sites (only when open) */}
                <div
                    id="customers-tree-root"
                    role="group"
                    className={cn("mt-1 pl-5", !customersGroupOpen && "hidden")}
                >
                    {customersGroupOpen &&
                        orgs.map((org) => {
                            const isOrgExpanded = expandedOrganizations.has(org);
                            const orgGroupId = `org-${encodeURIComponent(org)}`;
                            const sites = sitesByOrg[org] ?? [];
                            const orgCount = orgDeviceCounts[org] ?? 0;

                            return (
                                <div key={org} className="mb-1">
                                    {/* Organization row (badge = endpoints in org) */}
                                    <button
                                        type="button"
                                        role="treeitem"
                                        aria-level={2}
                                        aria-selected={isOrgExpanded}
                                        aria-expanded={isOrgExpanded}
                                        aria-controls={orgGroupId}
                                        onClick={() =>
                                            onExpandChange("organization", org, !isOrgExpanded, sites)
                                        }
                                        onKeyDown={onKeyToggle(() =>
                                            onExpandChange("organization", org, !isOrgExpanded, sites)
                                        )}
                                        className="flex w-full items-center gap-2 rounded px-2 py-1.5 hover:bg-accent hover:text-accent-foreground"
                                        title={org}
                                    >
                                        <ChevronRight
                                            className={cn(
                                                "h-4 w-4 transition-transform",
                                                isOrgExpanded && "rotate-90"
                                            )}
                                            aria-hidden="true"
                                        />
                                        <span className="truncate">{org}</span>
                                        <span className="ml-auto rounded bg-muted px-1.5 text-xs text-muted-foreground">
                                            {orgCount}
                                        </span>
                                    </button>

                                    {/* Sites under org (badge = endpoints in site) */}
                                    <div
                                        id={orgGroupId}
                                        role="group"
                                        className={cn("mt-1 pl-5", !isOrgExpanded && "hidden")}
                                    >
                                        {isOrgExpanded &&
                                            sites.map((site) => {
                                                const isSiteExpanded = expandedSites.has(site);
                                                const count = siteDeviceCounts[org]?.[site] ?? 0;
                                                const siteId = `site-${encodeURIComponent(org)}-${encodeURIComponent(
                                                    site
                                                )}`;

                                                return (
                                                    <button
                                                        key={site}
                                                        type="button"
                                                        role="treeitem"
                                                        aria-level={3}
                                                        aria-selected={isSiteExpanded}
                                                        aria-expanded={isSiteExpanded}
                                                        aria-controls={siteId}
                                                        onClick={() =>
                                                            onExpandChange("site", site, !isSiteExpanded)
                                                        }
                                                        onKeyDown={onKeyToggle(() =>
                                                            onExpandChange("site", site, !isSiteExpanded)
                                                        )}
                                                        className={cn(
                                                            "flex w-full items-center gap-2 rounded px-2 py-1.5 hover:bg-accent hover:text-accent-foreground",
                                                            isSiteExpanded && "bg-accent/40"
                                                        )}
                                                        title={site}
                                                    >
                                                        <ChevronRight
                                                            className={cn(
                                                                "h-4 w-4 transition-transform",
                                                                isSiteExpanded && "rotate-90"
                                                            )}
                                                            aria-hidden="true"
                                                        />
                                                        <span className="truncate">{site}</span>
                                                        <span className="ml-auto rounded bg-muted px-1.5 text-xs text-muted-foreground">
                                                            {count}
                                                        </span>
                                                    </button>
                                                );
                                            })}
                                    </div>
                                </div>
                            );
                        })}
                </div>
            </div>
        </aside>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[10] FILE
Path       : app/customers/layout.tsx
Size       : 1,445 bytes
Last Write : 2025-10-17 20:35:34
SHA256     : 37CB593CB4D4A99EF85757E5B364817805A738E8476A00659EE9DF3F07505484
========================================================================================

// app/customers/layout.tsx
"use client";

import * as React from "react";
import TopBar from "@/components/top-bar";
import { CustomersProvider } from "./customers-context";
import CustomersSidebar from "./customers-sidebar";

/**
 * Customers area shell
 * - Fixed TopBar (56px).
 * - Left sidebar with independent scroll.
 * - Main content uses <main> landmark and skip link for a11y.
 */
export default function CustomersLayout({ children }: { children: React.ReactNode }) {
    return (
        <CustomersProvider>
            {/* Skip to content for keyboard users */}
            <a
                href="#customers-main"
                className="sr-only focus:not-sr-only focus:fixed focus:left-2 focus:top-2 focus:z-50 rounded bg-primary px-3 py-2 text-primary-foreground"
            >
                Skip to content
            </a>

            {/* Fixed global header */}
            <TopBar />

            {/* Offset for fixed header (56px) */}
            <div className="pt-14">
                <div className="flex">
                    {/* Local customers sidebar */}
                    <CustomersSidebar />

                    {/* Main content */}
                    <main id="customers-main" className="min-w-0 flex-1 p-4 sm:px-6">
                        {children}
                    </main>
                </div>
            </div>
        </CustomersProvider>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[11] FILE
Path       : app/customers/page.tsx
Size       : 5,587 bytes
Last Write : 2025-10-17 20:34:33
SHA256     : 2018F2856ACA2BE33115B032DE194240A59C1416B9255D8515E463874556E46E
========================================================================================

// app/customers/page.tsx
"use client";

import * as React from "react";
import {
    useDashboard,
    type Device,
    type DeviceStatus,
} from "@/app/(dashboard)/dashboard-context";
import { useCustomers } from "@/app/customers/customers-context";
import FiltersRail from "@/components/filters-rail";
import DeviceTable from "@/components/device-table";

function EmptyEndpointsState() {
    return (
        <main className="flex h-[calc(100vh-56px)] items-center justify-center p-8">
            <div className="text-center">
                <h2 className="text-lg font-semibold">Select a customer or site</h2>
                <p className="mt-1 text-sm text-muted-foreground">
                    Expand one or more customer/site groups in the sidebar to see their devices.
                </p>
            </div>
        </main>
    );
}

// --- normalization helpers ---
const normStatus = (s: unknown): DeviceStatus =>
    String(s ?? "").trim().toLowerCase() as DeviceStatus;
const normOs = (s: unknown): string => String(s ?? "").trim().toLowerCase();

const OS_MAP: Record<string, string> = {
    windows: "windows",
    "microsoft windows": "windows",
    linux: "linux",
    macos: "macos",
    "mac os": "macos",
    osx: "macos",
};
const toOsKey = (s: unknown) => OS_MAP[normOs(s)] ?? normOs(s);

export default function CustomersPage() {
    const {
        masterDevices,

        // table state (participates in Saved Views)
        sorting,
        setSorting,
        columnVisibility,
        setColumnVisibility,
        columnFilters,
        setColumnFilters,

        // Saved Views snapshot registrar
        registerSnapshotGetter,

        // global filters
        activeFilters, // { status: DeviceStatus[], os: Device["os"][] }
    } = useDashboard();

    const {
        customersGroupOpen,
        expandedOrganizations,
        expandedSites,
    } = useCustomers();

    // Register a snapshot getter so Saved Views capture Customers scope + table state + filters
    React.useEffect(() => {
        const off = registerSnapshotGetter(() => ({
            columnVisibility,
            sorting,
            columnFilters,

            // Customers bits:
            customersGroupOpen,
            expandedOrganizations: Array.from(expandedOrganizations),
            expandedSites: Array.from(expandedSites),
            activeFilters,
        }));
        return () => {
            // Unregister when navigating away
            registerSnapshotGetter(null);
            void off; // (no-op; pattern keeps parity if you later return a disposer)
        };
    }, [
        registerSnapshotGetter,
        columnVisibility,
        sorting,
        columnFilters,
        customersGroupOpen,
        expandedOrganizations,
        expandedSites,
        activeFilters,
    ]);

    const nothingExpanded =
        customersGroupOpen &&
        expandedOrganizations.size === 0 &&
        expandedSites.size === 0;

    const statusFilterSet = React.useMemo(() => {
        const arr = activeFilters.status ?? [];
        return new Set(arr.map(normStatus));
    }, [activeFilters.status]);

    const osFilterSet = React.useMemo(() => {
        const arr = activeFilters.os ?? [];
        return new Set(arr.map(toOsKey));
    }, [activeFilters.os]);

    const matchesStatus = React.useCallback(
        (d: Device) => {
            if (!statusFilterSet.size) return true;
            return statusFilterSet.has(normStatus(d.status));
        },
        [statusFilterSet]
    );

    const matchesOs = React.useCallback(
        (d: Device) => {
            if (!osFilterSet.size) return true;
            return osFilterSet.has(toOsKey(d.os));
        },
        [osFilterSet]
    );

    const matchesSidebarScope = React.useCallback(
        (d: Device) => {
            if (expandedOrganizations.size === 0 && expandedSites.size === 0) return false;

            const orgSelected =
                expandedOrganizations.size > 0 ? expandedOrganizations.has(d.client) : false;

            const siteSelected =
                expandedSites.size > 0 ? expandedSites.has(d.site) : false;

            if (expandedSites.size > 0) {
                const orgGate = expandedOrganizations.size > 0 ? orgSelected : true;
                return siteSelected && orgGate;
            }

            if (expandedOrganizations.size > 0) {
                return orgSelected;
            }

            return false;
        },
        [expandedOrganizations, expandedSites]
    );

    const filteredForView = React.useMemo(() => {
        return masterDevices.filter(
            (d) => matchesSidebarScope(d) && matchesOs(d) && matchesStatus(d)
        );
    }, [masterDevices, matchesSidebarScope, matchesOs, matchesStatus]);

    if (nothingExpanded) return <EmptyEndpointsState />;

    return (
        <main className="grid grid-cols-12 gap-4 p-4 sm:px-6 sm:py-0">
            <aside className="col-span-12 md:col-span-3 lg:col-span-2 pt-4">
                <FiltersRail />
            </aside>
            <section className="col-span-12 md:col-span-9 lg:col-span-10 pt-4 min-w-0">
                <DeviceTable
                    dataOverride={filteredForView}
                    filterColumnId="hostname"
                    filterPlaceholder="Filter devices…"
                    compact={false}
                />
            </section>
        </main>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[12] FILE
Path       : app/(dashboard)/devices/[deviceId]/page.tsx
Size       : 16,037 bytes
Last Write : 2025-10-30 11:51:50
SHA256     : 4294931A26C0CB4C85D7E4DCBD6F1432334AF97B0B11DD744F14445E426E2768
========================================================================================

// app/(dashboard)/devices/[deviceId]/page.tsx
"use client";

import * as React from "react";
import Link from "next/link";
import { useRouter, useSearchParams, usePathname } from "next/navigation";
import { Power, Play, ShieldCheck, Tag, Move, Copy } from "lucide-react";

import {
    Breadcrumb,
    BreadcrumbItem,
    BreadcrumbLink,
    BreadcrumbList,
    BreadcrumbPage,
    BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";

import { useDashboard, type Device as UiDevice } from "@/app/(dashboard)/dashboard-context";
import { StatusBadge } from "@/components/status-badge";
import SoftwareTab from "@/components/software-tab";
import ChecksAndAlertsTab from "@/components/checks-and-alerts-tab";
import PatchTab from "@/components/patch-tab";
import RemoteTab from "@/components/remote-tab";

import { useDevice } from "@/lib/use-device";

// US-style "MM/DD/YYYY - H:MM AM/PM"
const dtFmt = new Intl.DateTimeFormat("en-US", {
    month: "2-digit",
    day: "2-digit",
    year: "numeric",
    hour: "numeric",
    minute: "2-digit",
    hour12: true,
});

type BadgeStatus = "healthy" | "warning" | "critical" | "offline";
function normalizeStatus(s?: string): BadgeStatus {
    switch ((s || "").toLowerCase()) {
        case "healthy":
            return "healthy";
        case "warning":
            return "warning";
        case "critical":
            return "critical";
        case "online":
            return "healthy";
        default:
            return "offline";
    }
}

export default function DeviceDetailPage({ params }: { params: { deviceId: string } }) {
    const { masterDevices, filteredDevices } = useDashboard();
    const devices = masterDevices?.length ? masterDevices : filteredDevices;

    // Local (dashboard) device if present
    const localDevice: UiDevice | undefined = React.useMemo(
        () => devices.find((d) => d.id === params.deviceId),
        [devices, params.deviceId]
    );

    // Backend device (authoritative)
    const { device: apiDevice, loading, error, refresh } = useDevice(params.deviceId);

    // Merge API device into the UI shape your page expects.
    const device: UiDevice | undefined = React.useMemo(() => {
        if (!apiDevice && !localDevice) return undefined;

        const status = normalizeStatus(apiDevice?.status ?? (localDevice as any)?.status);
        const merged: Partial<UiDevice> = {
            id: apiDevice?.id ?? localDevice?.id ?? params.deviceId,
            hostname: apiDevice?.hostname ?? localDevice?.hostname ?? "",
            alias: localDevice?.alias ?? apiDevice?.hostname ?? "",
            client: (localDevice as any)?.client ?? "—",
            site: (localDevice as any)?.site ?? "—",
            os: apiDevice?.os ?? (localDevice as any)?.os ?? "Unknown",
            status,
            // carry lastSeen through as lastResponse for display
            lastResponse: apiDevice?.lastSeen ?? (localDevice as any)?.lastResponse ?? null,
            // extra fields from backend we’ll show directly below
            ...(apiDevice
                ? {
                    arch: apiDevice.arch,
                    primaryIp: apiDevice.primaryIp,
                    version: apiDevice.version,
                    user: apiDevice.user,
                    agentUuid: (apiDevice as any)?.agentUuid ?? (localDevice as any)?.agentUuid ?? null,
                }
                : {
                    agentUuid: (localDevice as any)?.agentUuid ?? null,
                }),
        };

        return merged as unknown as UiDevice;
    }, [apiDevice, localDevice, params.deviceId]);

    const router = useRouter();
    const pathname = usePathname();
    const search = useSearchParams();

    const openRunScript = React.useCallback(() => {
        const current = new URLSearchParams(search?.toString() ?? "");
        current.set("device", params.deviceId);
        router.push(`${pathname}?${current.toString()}`);
    }, [params.deviceId, pathname, router, search]);

    const onReboot = React.useCallback(async () => {
        // TODO: wire your reboot call if available
    }, []);
    const onPatchNow = React.useCallback(async () => {
        // TODO: wire your patch call if available
    }, []);

    // ✅ HOOK DECLARED BEFORE ANY CONDITIONAL RETURNS
    const copy = React.useCallback(async (text: string) => {
        try {
            await navigator.clipboard.writeText(text);
            // optional: toast here
        } catch {
            // ignore
        }
    }, []);

    // ----- Conditional returns (no hooks below this line) -----
    if (loading && !device) {
        return (
            <div className="flex flex-col items-center justify-center h-full gap-3 text-center p-6">
                <div className="text-sm text-muted-foreground">Loading device…</div>
            </div>
        );
    }
    if (error && !device) {
        return (
            <div className="flex flex-col items-center justify-center h-full gap-4 text-center p-6">
                <h2 className="text-2xl font-semibold">Error loading device</h2>
                <p className="text-muted-foreground">{String(error)}</p>
                <div className="flex gap-2">
                    <Button variant="outline" onClick={refresh}>
                        Retry
                    </Button>
                    <Button asChild>
                        <Link href="/">Return to Dashboard</Link>
                    </Button>
                </div>
            </div>
        );
    }
    if (!device) {
        return (
            <div className="flex flex-col items-center justify-center h-full gap-4 text-center p-6">
                <h2 className="text-2xl font-semibold">Device Not Found</h2>
                <p className="text-muted-foreground">
                    The device with ID &apos;{params.deviceId}&apos; could not be found.
                </p>
                <Button asChild>
                    <Link href="/">Return to Dashboard</Link>
                </Button>
            </div>
        );
    }

    const badgeStatus: BadgeStatus = normalizeStatus(device.status as unknown as string);

    const lastSeenIso = (device as any).lastResponse as string | null;
    const lastSeenStr = lastSeenIso ? dtFmt.format(new Date(lastSeenIso)).replace(",", " -") : "—";

    const os = (device as any).os ?? "Unknown";
    const arch = (device as any).arch ?? "—";
    const primaryIp = (device as any).primaryIp ?? "—";
    const version = (device as any).version ?? "—";
    const currentUser = (device as any).user ?? "—";
    const agentUuid = (device as any)?.agentUuid as string | undefined | null;

    return (
        <main className="grid flex-1 items-start gap-4 p-4 sm:px-6 sm:py-0 md:gap-8">
            <div className="mx-auto grid w-full flex-1 auto-rows-max gap-4">
                <div className="flex items-center justify-between gap-4">
                    <Breadcrumb className="hidden md:flex">
                        <BreadcrumbList>
                            <BreadcrumbItem>
                                <BreadcrumbLink asChild>
                                    <Link href="/">Dashboard</Link>
                                </BreadcrumbLink>
                            </BreadcrumbItem>
                            <BreadcrumbSeparator />
                            <BreadcrumbItem>
                                <BreadcrumbLink asChild>
                                    <Link href="/customers">Devices</Link>
                                </BreadcrumbLink>
                            </BreadcrumbItem>
                            <BreadcrumbSeparator />
                            <BreadcrumbItem>
                                <BreadcrumbPage>{(device as any).alias || (device as any).hostname}</BreadcrumbPage>
                            </BreadcrumbItem>
                        </BreadcrumbList>
                    </Breadcrumb>

                    <div className="flex items-center gap-2">
                        <Button
                            variant="default"
                            size="sm"
                            onClick={openRunScript}
                            className="gap-2"
                            title="Open Run Script"
                        >
                            <Play className="h-4 w-4" /> Run Script
                        </Button>
                        <Button variant="outline" size="sm" title="Trigger a patch cycle" onClick={onPatchNow}>
                            <ShieldCheck className="h-4 w-4" /> Patch Now
                        </Button>
                        <Button variant="destructive" size="sm" title="Reboot this device" onClick={onReboot}>
                            <Power className="h-4 w-4" /> Reboot
                        </Button>
                    </div>
                </div>

                <Tabs defaultValue="overview">
                    <div className="flex items-center">
                        <TabsList>
                            <TabsTrigger value="overview">Overview</TabsTrigger>
                            <TabsTrigger value="remote">Remote</TabsTrigger>
                            <TabsTrigger value="checks">Checks &amp; Alerts</TabsTrigger>
                            <TabsTrigger value="patch">Patch</TabsTrigger>
                            <TabsTrigger value="software">Software</TabsTrigger>
                        </TabsList>
                        <div className="ml-auto flex items-center gap-2">
                            <Button variant="outline" size="sm" onClick={refresh} title="Refresh device data">
                                Refresh
                            </Button>
                        </div>
                    </div>

                    <TabsContent value="overview">
                        <Card>
                            <CardHeader>
                                <div className="flex justify-between items-start gap-4">
                                    <div className="min-w-0">
                                        <CardTitle className="truncate">
                                            {(device as any).alias || (device as any).hostname}
                                        </CardTitle>
                                        <CardDescription className="truncate">
                                            {(device as any).client} / {(device as any).site}
                                        </CardDescription>
                                    </div>
                                    <div className="flex items-center gap-2 shrink-0">
                                        <Button variant="outline" size="icon" title="Edit alias" aria-label="Edit alias">
                                            <Tag className="h-4 w-4" />
                                        </Button>
                                        <Button variant="outline" size="icon" title="Move device" aria-label="Move device">
                                            <Move className="h-4 w-4" />
                                        </Button>
                                    </div>
                                </div>
                            </CardHeader>
                            <CardContent>
                                <Separator className="my-4" />
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                                    <div className="space-y-1">
                                        <h3 className="font-medium text-muted-foreground">Status</h3>
                                        <StatusBadge status={badgeStatus} />
                                    </div>
                                    <div className="space-y-1">
                                        <h3 className="font-medium text-muted-foreground">Operating System</h3>
                                        <p>{os}</p>
                                    </div>
                                    <div className="space-y-1">
                                        <h3 className="font-medium text-muted-foreground">Architecture</h3>
                                        <p>{arch}</p>
                                    </div>
                                    <div className="space-y-1">
                                        <h3 className="font-medium text-muted-foreground">IP Address</h3>
                                        <p>{primaryIp}</p>
                                    </div>
                                    <div className="space-y-1">
                                        <h3 className="font-medium text-muted-foreground">Agent Version</h3>
                                        <p>{version}</p>
                                    </div>
                                    <div className="space-y-1">
                                        <h3 className="font-medium text-muted-foreground">Last Response</h3>
                                        <p>{lastSeenStr}</p>
                                    </div>

                                    {/* Agent UUID (optional) */}
                                    {agentUuid ? (
                                        <div className="space-y-1 md:col-span-3">
                                            <h3 className="font-medium text-muted-foreground">Agent UUID</h3>
                                            <div className="flex items-center gap-2">
                                                <code className="text-xs break-all">{agentUuid}</code>
                                                <Button
                                                    size="sm"
                                                    variant="outline"
                                                    title="Copy agent UUID"
                                                    onClick={() => copy(agentUuid)}
                                                    className="gap-2"
                                                >
                                                    <Copy className="h-3.5 w-3.5" />
                                                    Copy
                                                </Button>
                                            </div>
                                        </div>
                                    ) : null}

                                    <div className="space-y-1 md:col-span-3">
                                        <h3 className="font-medium text-muted-foreground">Logged-in User</h3>
                                        <p>{currentUser}</p>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    </TabsContent>

                    <TabsContent value="remote">
                        <RemoteTab />
                    </TabsContent>
                    <TabsContent value="checks">
                        <ChecksAndAlertsTab />
                    </TabsContent>
                    <TabsContent value="patch">
                        <PatchTab />
                    </TabsContent>
                    <TabsContent value="software">
                        <SoftwareTab />
                    </TabsContent>
                </Tabs>
            </div>
        </main>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[13] FILE
Path       : components/top-bar.tsx
Size       : 32,383 bytes
Last Write : 2025-10-26 17:23:50
SHA256     : 12252D1EBD69F0F2B0AAA0CCBB4FD43F48A3658F72C7570AF09BE6214ED05344
========================================================================================

// app/(dashboard)/top-bar.tsx
"use client";

/**
 * Top Bar
 * ----------------------------------------------------------------
 * Saved Views + Automation + Search + Theme + Admin + Avatar
 * Adds "Dashboard" and "Customers" tabs next to the brand.
 * Uses user avatar from /api/users/me when available.
 */

import React, { useEffect, useRef, useState } from "react";
import {
    Moon,
    Search,
    Sun,
    Bell,
    Bookmark,
    PlusCircle,
    Trash2,
    Laptop,
    PlaySquare,
    ChevronDown,
    Link as LinkIcon,
    Save,
    ActivitySquare,
    MemoryStick,
    Shield,
} from "lucide-react";
import Link from "next/link";
import { useTheme } from "next-themes";
import { usePathname, useRouter, useSearchParams } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
    DropdownMenuSeparator,
} from "@/components/ui/dropdown-menu";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Label } from "@/components/ui/label";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import RunScriptModal from "@/components/run-script-modal";
import { useDashboard, SavedView } from "@/app/(dashboard)/dashboard-context";
import { useBranding } from "@/app/providers/BrandingProvider";

const TOP_BAR_HEIGHT = 56;
const PLACEHOLDER_AVATAR = "/avatar-placeholder.png"; // ensure this exists in FE /public

type ToastKind = "success" | "destructive" | "default";
type ToastAction = { label: string; onClick: () => void };
type Toast = { id: string; title: string; desc?: string; kind: ToastKind; action?: ToastAction };

function useToasts() {
    const [toasts, setToasts] = useState<Toast[]>([]);
    const push = (toast: Omit<Toast, "id">) => {
        const id = Math.random().toString(36).slice(2);
        setToasts((t) => [...t, { ...toast, id }]);
        window.setTimeout(() => setToasts((t) => t.filter((x) => x.id !== id)), 4200);
    };
    return { toasts, push };
}

function useMiniRmmStats() {
    const [cpu, setCpu] = useState(18);
    const [ram, setRam] = useState(42);
    useEffect(() => {
        const id = window.setInterval(() => {
            setCpu((c) => Math.max(1, Math.min(99, Math.round(c + (Math.random() * 6 - 3)))));
            setRam((m) => Math.max(1, Math.min(99, Math.round(m + (Math.random() * 6 - 3)))));
        }, 4000);
        return () => clearInterval(id);
    }, []);
    return { cpu, ram };
}

/** Brand logo that respects saved branding (light/dark) */
function AppLogo() {
    const { branding } = useBranding();
    const light = branding?.logoLightUrl ?? undefined;
    const dark = branding?.logoDarkUrl ?? undefined;
    return (
        <div className="flex items-center gap-2">
            <picture>
                {dark ? <source srcSet={dark} media="(prefers-color-scheme: dark)" /> : null}
                <img
                    src={light || dark || "/logo.png"}
                    alt="RemoteIQ"
                    width={28}
                    height={28}
                    className="rounded-sm"
                />
            </picture>
            <span className="font-semibold">RemoteIQ</span>
        </div>
    );
}

function getInitials(name?: string, email?: string) {
    const fromName =
        (name || "")
            .split(" ")
            .map((s) => s.trim()[0])
            .filter(Boolean)
            .slice(0, 2)
            .join("")
            .toUpperCase();
    if (fromName) return fromName;
    const fromEmail = (email || "").trim()[0];
    return (fromEmail || "U").toUpperCase();
}

function normalizeAvatarUrl(raw?: string): string | undefined {
    if (!raw) return undefined;
    const url = raw.trim();
    if (!url) return undefined;
    // Absolute: http(s)://... or data:
    if (/^(https?:)?\/\//i.test(url) || url.startsWith("data:")) return url;
    // Relative to API base
    const base = (process.env.NEXT_PUBLIC_API_BASE || "").replace(/\/+$/, "");
    if (!base) return url; // hope same-origin
    if (url.startsWith("/")) return `${base}${url}`;
    return `${base}/${url}`;
}

type MeProfileResponse = {
    id: string;
    name?: string;
    email?: string;
    avatarUrl?: string;
    avatar_url?: string;
};

export default function TopBar() {
    const pathname = usePathname();
    const isDashboard = pathname === "/" || pathname === "/(dashboard)";
    const isCustomers = pathname.startsWith("/customers");

    // TODO: wire to real auth/role state
    const isSuperAdmin = true;

    const { setTheme } = useTheme();
    const {
        savedViews,
        saveCurrentView,
        loadView,
        deleteView,
        overwriteViewFromCurrent,
        getEncodedCurrentView,
    } = useDashboard();

    const router = useRouter();
    const searchParams = useSearchParams();

    const [newViewName, setNewViewName] = useState("");
    const [isSaveDialogOpen, setSaveDialogOpen] = useState(false);
    const [nameError, setNameError] = useState<string | null>(null);
    const [viewToDelete, setViewToDelete] = useState<SavedView | null>(null);
    const [viewToOverwrite, setViewToOverwrite] = useState<SavedView | null>(null);

    const [isRunScriptOpen, setRunScriptOpen] = useState(false);
    const [preselectIds, setPreselectIds] = useState<string[] | undefined>(undefined);
    const [automationOpen, setAutomationOpen] = useState(false);

    const { toasts, push } = useToasts();

    // ---------- CURRENT USER (avatar + initials) ----------
    const [avatarUrl, setAvatarUrl] = useState<string | undefined>(undefined);
    const [avatarErrored, setAvatarErrored] = useState(false);
    const [initials, setInitials] = useState("U");

    useEffect(() => {
        let cancelled = false;
        (async () => {
            try {
                // Pull full profile which contains avatarUrl
                const res = await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/api/users/me`, {
                    credentials: "include",
                });
                if (!res.ok) throw new Error(`Profile fetch failed (${res.status})`);
                const data: MeProfileResponse = await res.json();
                if (cancelled) return;

                const raw = (data as any)?.avatarUrl || (data as any)?.avatar_url || "";
                const normalized = normalizeAvatarUrl(raw);
                setAvatarUrl(normalized);
                setInitials(getInitials(data?.name, data?.email));
            } catch {
                // keep initials-only fallback
            }
        })();
        return () => {
            cancelled = true;
        };
    }, []);

    const setQuery = (key: string, value?: string) => {
        const url = new URL(window.location.href);
        if (!value) url.searchParams.delete(key);
        else url.searchParams.set(key, value);
        router.replace(`${url.pathname}?${url.searchParams.toString()}`);
    };

    // modal open-from-URL guard
    const lastOpenedIdRef = useRef<string | null>(null);
    const openedFromUrlRef = useRef<boolean>(false);
    useEffect(() => {
        const runScriptId = searchParams.get("runScript");
        const deviceId = searchParams.get("device");
        const theId = runScriptId || deviceId;
        if (!theId || isRunScriptOpen || lastOpenedIdRef.current === theId) return;

        lastOpenedIdRef.current = theId;
        openedFromUrlRef.current = true;
        setPreselectIds([theId]);
        setRunScriptOpen(true);
        setAutomationOpen(false);
    }, [searchParams, isRunScriptOpen]);

    const handleRunScriptOpenChange = (open: boolean) => {
        setRunScriptOpen(open);
        if (!open) {
            setPreselectIds(undefined);
            if (openedFromUrlRef.current) {
                openedFromUrlRef.current = false;
                router.back();
            } else {
                setQuery("runScript");
                setQuery("device");
            }
            window.setTimeout(() => {
                lastOpenedIdRef.current = null;
            }, 0);
        }
    };

    // Saved views actions
    const handleSaveView = () => {
        const trimmed = newViewName.trim();
        if (!trimmed) return setNameError("Please enter a name.");
        if (savedViews.some((v) => v.name.toLowerCase() === trimmed.toLowerCase())) {
            return setNameError("A view with this name already exists.");
        }
        saveCurrentView(trimmed);
        push({ title: "Saved view created", desc: `"${trimmed}" was saved.`, kind: "success" });
        setNewViewName("");
        setNameError(null);
        setSaveDialogOpen(false);
    };
    const confirmDelete = () => {
        if (!viewToDelete) return;
        deleteView(viewToDelete.id);
        push({ title: "Saved view deleted", desc: `"${viewToDelete.name}" was removed.`, kind: "destructive" });
        setViewToDelete(null);
    };
    const confirmOverwrite = () => {
        if (!viewToOverwrite) return;
        overwriteViewFromCurrent(viewToOverwrite.id);
        push({ title: "Saved view updated", desc: `"${viewToOverwrite.name}" was overwritten.`, kind: "success" });
        setViewToOverwrite(null);
    };

    const handleCopyViewLink = async () => {
        try {
            const encoded = getEncodedCurrentView({ includeLayouts: true });
            const url = new URL(window.location.href);
            if (encoded) url.searchParams.set("v", encoded);
            else url.searchParams.delete("v");
            const href = url.toString();
            await navigator.clipboard.writeText(href);
            push({
                title: "Link copied",
                desc: "The current view URL is in your clipboard.",
                kind: "success",
                action: { label: "Open", onClick: () => window.open(href, "_blank", "noopener,noreferrer") },
            });
        } catch {
            push({ title: "Copy failed", desc: "Could not write to clipboard.", kind: "destructive" });
        }
    };

    const { cpu, ram } = useMiniRmmStats();

    const handleLogout = async () => {
        try {
            await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/api/auth/logout`, {
                method: "POST",
                credentials: "include",
            });
        } catch { }
        router.replace("/login?next=/");
    };

    return (
        <>
            <header
                className="fixed inset-x-0 top-0 z-50 flex h-14 items-center border-b bg-background"
                style={{ height: TOP_BAR_HEIGHT }}
            >
                {/* Left cluster: brand + tabs + automation */}
                <div className="flex items-center gap-2 px-2 sm:px-3">
                    <Link href="/" className="flex items-center gap-2">
                        <AppLogo />
                    </Link>

                    <div className="ml-1 hidden sm:flex items-center">
                        <div className="flex items-center">
                            <Button
                                asChild
                                variant={isDashboard ? "secondary" : "ghost"}
                                size="sm"
                                title="Dashboard"
                                className="rounded-none first:rounded-l-md px-4"
                            >
                                <Link href="/">Dashboard</Link>
                            </Button>
                            <div className="h-6 w-px bg-border self-center" />
                            <Button
                                asChild
                                variant={isCustomers ? "secondary" : "ghost"}
                                size="sm"
                                title="Customers"
                                className="rounded-none last:rounded-r-md px-4"
                            >
                                <Link href="/customers">Customers</Link>
                            </Button>
                        </div>
                    </div>

                    <DropdownMenu open={automationOpen} onOpenChange={setAutomationOpen}>
                        <DropdownMenuTrigger asChild>
                            <Button variant="ghost" size="sm" className="gap-2" title="Open automation tools">
                                Automation
                                <ChevronDown className="h-4 w-4" aria-hidden="true" />
                            </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="start">
                            <DropdownMenuItem
                                onSelect={(e) => {
                                    e.preventDefault();
                                    setAutomationOpen(false);
                                    setPreselectIds(undefined);
                                    setRunScriptOpen(true);
                                    const url = new URL(window.location.href);
                                    url.searchParams.delete("runScript");
                                    url.searchParams.delete("device");
                                    history.replaceState(null, "", url.toString());
                                    openedFromUrlRef.current = false;
                                    lastOpenedIdRef.current = null;
                                }}
                            >
                                <PlaySquare className="mr-2 h-4 w-4" />
                                Run Script
                            </DropdownMenuItem>
                            <DropdownMenuSeparator />
                            <DropdownMenuItem disabled>More tools coming…</DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                </div>

                <div className="flex-1" />

                {/* Right cluster — avatar MUST be last */}
                <div className="flex items-center gap-2 pr-2 sm:pr-3">
                    <Button
                        variant="outline"
                        size="sm"
                        className="gap-2"
                        onClick={handleCopyViewLink}
                        title="Copy link to current view"
                    >
                        <LinkIcon className="h-4 w-4" />
                        <span className="hidden sm:inline">Copy View Link</span>
                    </Button>

                    <Dialog open={isSaveDialogOpen} onOpenChange={setSaveDialogOpen}>
                        <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                                <Button variant="outline" size="sm" title="Manage saved views">
                                    <Bookmark className="h-4 w-4 mr-2" />
                                    Saved Views
                                </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="end" className="w-64">
                                <DialogTrigger asChild>
                                    <DropdownMenuItem
                                        onSelect={(e) => {
                                            e.preventDefault();
                                            setSaveDialogOpen(true);
                                        }}
                                    >
                                        <PlusCircle className="mr-2 h-4 w-4" />
                                        <span>Save Current View</span>
                                    </DropdownMenuItem>
                                </DialogTrigger>
                                <DropdownMenuSeparator />
                                {savedViews.length === 0 && (
                                    <DropdownMenuItem disabled>No saved views</DropdownMenuItem>
                                )}
                                {savedViews.map((view) => (
                                    <DropdownMenuItem
                                        key={view.id}
                                        onSelect={() => {
                                            const ok = loadView(view.id);
                                            if (ok)
                                                push({
                                                    title: "Saved view loaded",
                                                    desc: `"${view.name}" applied.`,
                                                    kind: "success",
                                                });
                                        }}
                                        className="flex items-center gap-2 py-2"
                                    >
                                        <span className="flex-1 truncate">{view.name}</span>
                                        <Button
                                            variant="warning"
                                            size="icon"
                                            className="h-6 w-6"
                                            title="Overwrite from current"
                                            onClick={(e) => {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                setViewToOverwrite(view);
                                            }}
                                        >
                                            <Save className="h-4 w-4" />
                                        </Button>
                                        <Button
                                            variant="destructive"
                                            size="icon"
                                            className="h-6 w-6"
                                            onClick={(e) => {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                setViewToDelete(view);
                                            }}
                                            aria-label={`Delete ${view.name}`}
                                            title="Delete"
                                        >
                                            <Trash2 className="h-4 w-4" />
                                        </Button>
                                    </DropdownMenuItem>
                                ))}
                            </DropdownMenuContent>
                        </DropdownMenu>

                        {/* Save dialog */}
                        <DialogContent>
                            <form
                                onSubmit={(e) => {
                                    e.preventDefault();
                                    handleSaveView();
                                }}
                            >
                                <DialogHeader>
                                    <DialogTitle>Save New View</DialogTitle>
                                    <DialogDescription>
                                        Saves column visibility, scope, and any active filters/sorting.
                                    </DialogDescription>
                                </DialogHeader>

                                <div className="grid gap-4 py-4">
                                    <div className="grid grid-cols-4 items-center gap-4">
                                        <Label htmlFor="sv-name" className="text-right">
                                            Name
                                        </Label>
                                        <div className="col-span-3">
                                            <Input
                                                id="sv-name"
                                                value={newViewName}
                                                onChange={(e) => {
                                                    setNewViewName(e.target.value);
                                                    setNameError(null);
                                                }}
                                                placeholder="e.g., Global Windows Servers"
                                                autoFocus
                                            />
                                            {nameError && (
                                                <p className="mt-1 text-xs text-destructive">{nameError}</p>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <DialogFooter>
                                    <Button
                                        type="button"
                                        variant="outline"
                                        onClick={() => setSaveDialogOpen(false)}
                                        title="Cancel"
                                    >
                                        Cancel
                                    </Button>
                                    <Button type="submit" variant="success" title="Save view">
                                        Save
                                    </Button>
                                </DialogFooter>
                            </form>
                        </DialogContent>
                    </Dialog>

                    {/* Search */}
                    <div className="relative hidden md:block">
                        <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                        <Input
                            type="search"
                            placeholder="Search devices, sites, customers…"
                            className="w-[320px] rounded-lg bg-background pl-8"
                        />
                    </div>

                    {/* Mini CPU/RAM */}
                    <div className="hidden sm:flex items-center gap-2">
                        <Button variant="outline" size="sm" className="gap-2 cursor-default" title="RMM Server CPU">
                            <ActivitySquare className="h-4 w-4" />
                            <span className="tabular-nums">{cpu}%</span>
                        </Button>
                        <Button variant="outline" size="sm" className="gap-2 cursor-default" title="RMM Server RAM">
                            <MemoryStick className="h-4 w-4" />
                            <span className="tabular-nums">{ram}%</span>
                        </Button>
                    </div>

                    {/* Theme */}
                    <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                            <Button variant="outline" size="icon" title="Theme">
                                <Sun className="h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
                                <Moon className="absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
                                <span className="sr-only">Toggle theme</span>
                            </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                            <DropdownMenuItem onClick={() => setTheme("light")}>
                                <Sun className="mr-2 h-4 w-4" />
                                Light
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => setTheme("dark")}>
                                <Moon className="mr-2 h-4 w-4" />
                                Dark
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => setTheme("system")}>
                                <Laptop className="mr-2 h-4 w-4" />
                                System
                            </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>

                    {/* Notifications */}
                    <Button variant="outline" size="icon" aria-label="Notifications" title="Notifications">
                        <Bell className="h-5 w-5" />
                    </Button>

                    {/* Admin (shield) — only for super admins */}
                    {isSuperAdmin && (
                        <Button asChild variant="outline" size="icon" title="Administration" aria-label="Administration">
                            <Link href="/administration">
                                <Shield className="h-5 w-5" />
                            </Link>
                        </Button>
                    )}

                    {/* Avatar menu — ALWAYS LAST */}
                    <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                            <Button
                                variant="outline"
                                size="icon"
                                title="Account"
                                aria-label="Account"
                                className="rounded-full overflow-hidden"
                            >
                                <Avatar className="h-8 w-8">
                                    <AvatarImage
                                        src={avatarErrored ? PLACEHOLDER_AVATAR : (avatarUrl || PLACEHOLDER_AVATAR)}
                                        alt="User"
                                        onError={() => setAvatarErrored(true)}
                                        referrerPolicy="no-referrer"
                                    />
                                    <AvatarFallback className="text-xs">{initials}</AvatarFallback>
                                </Avatar>
                            </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end" className="w-56">
                            <DropdownMenuItem asChild>
                                <Link href="/account">Account</Link>
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => router.push("/account#security")}>
                                Security
                            </DropdownMenuItem>
                            <DropdownMenuSeparator />
                            <DropdownMenuItem onClick={handleLogout}>Sign out</DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                </div>
            </header>

            {/* Overwrite confirm */}
            <AlertDialog open={!!viewToOverwrite} onOpenChange={(o) => !o && setViewToOverwrite(null)}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>Overwrite saved view?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Replace settings of <b>{viewToOverwrite?.name}</b> with your current configuration.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancel</AlertDialogCancel>
                        <AlertDialogAction
                            className="bg-amber-500 text-white hover:bg-amber-500/90 dark:bg-amber-600 dark:hover:bg-amber-600/90"
                            onClick={() => {
                                // will be set by confirmOverwrite outside
                            }}
                        >
                            Overwrite
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            {/* Delete confirm */}
            <AlertDialog open={!!viewToDelete} onOpenChange={(o) => !o && setViewToDelete(null)}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>Delete saved view?</AlertDialogTitle>
                        <AlertDialogDescription>
                            This will permanently delete <b>{viewToDelete?.name}</b>.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancel</AlertDialogCancel>
                        <AlertDialogAction
                            className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                            onClick={() => {
                                // will be set by confirmDelete outside
                            }}
                        >
                            Delete
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            {/* Run Script modal */}
            <RunScriptModal
                open={isRunScriptOpen}
                onOpenChange={setRunScriptOpen}
                preselectDeviceIds={preselectIds}
            />

            {/* Toasts */}
            <div className="fixed bottom-4 right-4 z-[100] space-y-2">
                {toasts.map((t) => {
                    const klass =
                        t.kind === "success"
                            ? "border-emerald-200 bg-emerald-50 text-emerald-900 dark:border-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-200"
                            : t.kind === "destructive"
                                ? "border-red-200 bg-red-50 text-red-900 dark:border-red-700 dark:bg-red-900/20 dark:text-red-200"
                                : "border-border bg-card text-card-foreground";
                    return (
                        <div key={t.id} className={`rounded-md border px-4 py-3 shadow-md w-[340px] ${klass}`}>
                            <div className="flex items-start justify-between gap-3">
                                <div>
                                    <div className="text-sm font-medium">{t.title}</div>
                                    {t.desc && <div className="mt-1 text-xs/5 opacity-90">{t.desc}</div>}
                                </div>
                                {t.action && (
                                    <button
                                        className="text-xs underline underline-offset-2 hover:opacity-80"
                                        onClick={t.action.onClick}
                                        title={t.action.label}
                                    >
                                        {t.action.label}
                                    </button>
                                )}
                            </div>
                        </div>
                    );
                })}
            </div>
        </>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[14] FILE
Path       : components/sidebar.tsx
Size       : 7,286 bytes
Last Write : 2025-10-17 18:34:46
SHA256     : FBDCD4DF6F7B3A808E20FAD2D7DE07406E13279FC2F92BCF40DE5CCD397554AB
========================================================================================

//components\sidebar.tsx

"use client";

import * as React from "react";
import { useRouter, useSearchParams, usePathname } from "next/navigation";
import { ChevronRight, ChevronDown, Building2, Users2, Monitor } from "lucide-react";
import { cn } from "@/lib/utils";
import { useDashboard } from "@/app/(dashboard)/dashboard-context";

type SiteKey = `${string}|${string}`; // "Org|Site"

export default function Sidebar() {
    const pathname = usePathname();
    const isCustomers = pathname.startsWith("/customers");
    const { masterDevices } = useDashboard();

    // Build Clients → Sites tree
    const tree = React.useMemo(() => {
        const byOrg = new Map<string, Set<string>>();
        for (const d of masterDevices) {
            if (!byOrg.has(d.client)) byOrg.set(d.client, new Set());
            byOrg.get(d.client)!.add(d.site);
        }
        return Array.from(byOrg.entries())
            .map(([org, set]) => ({ org, sites: Array.from(set).sort((a, b) => a.localeCompare(b)) }))
            .sort((a, b) => a.org.localeCompare(b.org));
    }, [masterDevices]);

    const allOrgNames = React.useMemo(() => tree.map(t => t.org), [tree]);

    const router = useRouter();
    const qs = useSearchParams();

    const scope = qs.get("scope") || "";
    const orgsParam = qs.get("orgs") || "";
    const sitesParam = qs.get("sites") || "";

    const expandedOrgs = React.useMemo(() => {
        const list = orgsParam ? orgsParam.split(",").filter(Boolean) : [];
        return new Set(list.filter((o) => allOrgNames.includes(o)));
    }, [orgsParam, allOrgNames]);

    const selectedSites = React.useMemo(() => {
        const list = sitesParam ? sitesParam.split(",").filter(Boolean) : [];
        const valid = new Set<SiteKey>();
        for (const item of list) {
            const [org, site] = item.split("|");
            if (!org || !site) continue;
            const entry = tree.find((t) => t.org === org);
            if (entry && entry.sites.includes(site)) valid.add(`${org}|${site}`);
        }
        return valid;
    }, [sitesParam, tree]);

    const setQuery = React.useCallback((updater: (u: URL) => void) => {
        const url = new URL(window.location.href);
        updater(url);
        router.replace(`${url.pathname}?${url.searchParams.toString()}`);
    }, [router]);

    const gotoRootCustomers = () => {
        setQuery((url) => {
            url.searchParams.set("scope", "customers");
            url.searchParams.delete("orgs");
            url.searchParams.delete("sites");
        });
    };

    const toggleOrg = (org: string) => {
        const next = new Set(expandedOrgs);
        next.has(org) ? next.delete(org) : next.add(org);
        setQuery((url) => {
            url.searchParams.set("scope", "customers");
            url.searchParams.set("orgs", Array.from(next).join(","));
            // trim sites to only those under expanded orgs
            const kept = Array.from(selectedSites).filter((s) => next.has(s.split("|")[0]!));
            if (kept.length) url.searchParams.set("sites", kept.join(","));
            else url.searchParams.delete("sites");
        });
    };

    const toggleSite = (org: string, site: string) => {
        const key = `${org}|${site}` as SiteKey;
        const nextSites = new Set<SiteKey>(selectedSites);
        nextSites.has(key) ? nextSites.delete(key) : nextSites.add(key);

        const nextOrgs = new Set(expandedOrgs);
        nextOrgs.add(org);

        setQuery((url) => {
            url.searchParams.set("scope", "customers");
            url.searchParams.set("orgs", Array.from(nextOrgs).join(","));
            if (nextSites.size) url.searchParams.set("sites", Array.from(nextSites).join(","));
            else url.searchParams.delete("sites");
        });
    };

    const rootActive = isCustomers && scope === "customers";
    const orgIsExpanded = (org: string) => expandedOrgs.has(org);
    const siteIsSelected = (org: string, site: string) => selectedSites.has(`${org}|${site}`);

    return (
        <aside
            className={cn(
                "w-64 shrink-0 border-r bg-background",
                // starts below top bar; its own scroller
                "h-[calc(100vh-3.5rem)] overflow-y-auto"
            )}
        >
            <div className="px-3 py-2">
                {/* Customers root */}
                <button
                    onClick={gotoRootCustomers}
                    className={cn(
                        "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm hover:bg-accent",
                        rootActive ? "bg-accent text-accent-foreground" : "text-foreground"
                    )}
                    title="Customers"
                >
                    <Users2 className="h-4 w-4" />
                    <span className="truncate">Customers</span>
                </button>

                {/* Orgs + sites */}
                <div className="mt-2 space-y-1">
                    {tree.map(({ org, sites }) => (
                        <div key={org}>
                            <button
                                onClick={() => toggleOrg(org)}
                                className={cn(
                                    "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm hover:bg-accent",
                                    orgIsExpanded(org) ? "bg-muted" : ""
                                )}
                                title={org}
                            >
                                {orgIsExpanded(org) ? <ChevronDown className="h-4 w-4" /> : <ChevronRight className="h-4 w-4" />}
                                <Building2 className="h-4 w-4 opacity-70" />
                                <span className="truncate">{org}</span>
                            </button>

                            {orgIsExpanded(org) && (
                                <div className="ml-6 mt-1 space-y-1">
                                    {sites.map((site) => (
                                        <button
                                            key={site}
                                            onClick={() => toggleSite(org, site)}
                                            className={cn(
                                                "flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-accent",
                                                siteIsSelected(org, site) ? "bg-accent text-accent-foreground" : "text-foreground"
                                            )}
                                            title={`${org} • ${site}`}
                                        >
                                            <Monitor className="h-3.5 w-3.5 opacity-70" />
                                            <span className="truncate">{site}</span>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        </aside>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[15] FILE
Path       : components/dashboard-shell.tsx
Size       : 969 bytes
Last Write : 2025-10-17 18:32:56
SHA256     : 0BED6E6327DEABD2A538846B0D0A1C103BACF49E33CB69F1647C8F5730C0BCBF
========================================================================================

//components\dashboard-shell.tsx

"use client";

import * as React from "react";
import { useDashboard } from "@/app/(dashboard)/dashboard-context";
import {
    TOP_BAR_HEIGHT,
    SIDEBAR_WIDTH_COLLAPSED,
    SIDEBAR_WIDTH_EXPANDED,
} from "@/components/layout-constants";

/**
 * Positions the main app content so it's never hidden under the fixed TopBar/Sidebar.
 * This component must be client-side to read sidebar collapse state.
 */
export default function DashboardShell({ children }: { children: React.ReactNode }) {
    const { isSidebarCollapsed } = useDashboard();

    const paddingLeft = isSidebarCollapsed
        ? SIDEBAR_WIDTH_COLLAPSED
        : SIDEBAR_WIDTH_EXPANDED;

    return (
        <div
            className="min-h-screen bg-background"
            style={{
                paddingTop: TOP_BAR_HEIGHT,
                paddingLeft,
            }}
        >
            {children}
        </div>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[16] FILE
Path       : components/layout-constants.ts
Size       : 274 bytes
Last Write : 2025-10-17 18:34:08
SHA256     : B2320BC2AA27F9B90E214697629F6B693947F2DE7D12065DC14B4E62DBDF4953
========================================================================================

//components\layout-constants.ts

// Shared layout constants (keep these in sync with your Tailwind classes)
export const TOP_BAR_HEIGHT = 56;            // h-14
export const SIDEBAR_WIDTH_EXPANDED = 256;   // w-64
export const SIDEBAR_WIDTH_COLLAPSED = 56;   // w-14



----------------------------------------------------------------------------------------



========================================================================================
[17] FILE
Path       : components/data-table.tsx
Size       : 11,130 bytes
Last Write : 2025-11-02 21:11:08
SHA256     : CFBD4682400875EF4E7DC34123B9479B110958AB4D7FFF26E76119DC61BE20A3
========================================================================================

//remoteiq-frontend\components\data-table.tsx

"use client";

import * as React from "react";
import {
    ColumnDef,
    flexRender,
    getCoreRowModel,
    getFilteredRowModel,
    getSortedRowModel,
    getPaginationRowModel,
    SortingState,
    VisibilityState,
    ColumnFiltersState,
    RowSelectionState,
    useReactTable,
} from "@tanstack/react-table";

import { cn } from "@/lib/utils";

import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
    DropdownMenu,
    DropdownMenuTrigger,
    DropdownMenuContent,
    DropdownMenuCheckboxItem,
} from "@/components/ui/dropdown-menu";
import {
    Table,
    TableHeader,
    TableHead,
    TableRow,
    TableBody,
    TableCell,
} from "@/components/ui/table";
import { ChevronLeft, ChevronRight, SlidersHorizontal } from "lucide-react";

type ColumnMeta = { headerClassName?: string; cellClassName?: string };

export type TableSnapshot = {
    sorting: SortingState;
    columnVisibility: VisibilityState;
    columnFilters: ColumnFiltersState;
    pagination: { pageIndex: number; pageSize: number };
};

export type DataTableProps<TData extends { id?: string }, TValue> = {
    columns: ColumnDef<TData, TValue>[];
    data: TData[];

    filterColumn?: string;
    filterInputPlaceholder?: string;

    sorting: SortingState;
    setSorting: React.Dispatch<React.SetStateAction<SortingState>>;
    columnVisibility: VisibilityState;
    setColumnVisibility: React.Dispatch<React.SetStateAction<VisibilityState>>;
    columnFilters: ColumnFiltersState;
    setColumnFilters: React.Dispatch<React.SetStateAction<ColumnFiltersState>>;

    rowSelection?: RowSelectionState;
    setRowSelection?: React.Dispatch<React.SetStateAction<RowSelectionState>>;

    compact?: boolean;

    // Saved Views plumbing + styling
    className?: string;
    /** Register a function that returns the current table snapshot (used by Saved Views). */
    registerSnapshotGetter?: (fn: () => TableSnapshot) => void;
    /** Optional: notify parent whenever table state changes. */
    onTableStateChange?: (snap: TableSnapshot) => void;
};

export function DataTable<TData extends { id?: string }, TValue>({
    columns,
    data,
    filterColumn,
    filterInputPlaceholder = "Filter…",
    sorting,
    setSorting,
    columnVisibility,
    setColumnVisibility,
    columnFilters,
    setColumnFilters,
    rowSelection,
    setRowSelection,
    compact = false,
    className,
    registerSnapshotGetter,
    onTableStateChange,
}: DataTableProps<TData, TValue>) {
    const table = useReactTable({
        data,
        columns,
        state: {
            sorting,
            columnVisibility,
            columnFilters,
            rowSelection: rowSelection ?? {},
        },
        onSortingChange: setSorting,
        onColumnVisibilityChange: setColumnVisibility,
        onColumnFiltersChange: setColumnFilters,
        enableRowSelection: !!setRowSelection,
        onRowSelectionChange: setRowSelection,
        getRowId: (row: any, index) => (row?.id ? String(row.id) : String(index)),
        getCoreRowModel: getCoreRowModel(),
        getFilteredRowModel: getFilteredRowModel(),
        getSortedRowModel: getSortedRowModel(),
        getPaginationRowModel: getPaginationRowModel(),
    });

    // ---- Saved Views snapshot getter (FUNCTION, not value) ----
    const getSnapshot = React.useCallback<() => TableSnapshot>(() => {
        const s = table.getState();
        return {
            sorting: s.sorting,
            columnVisibility: s.columnVisibility,
            columnFilters: s.columnFilters,
            pagination: {
                pageIndex: s.pagination.pageIndex,
                pageSize: s.pagination.pageSize,
            },
        };
    }, [table]);

    // Register getter with consumer (e.g., DashboardContext)
    React.useEffect(() => {
        if (registerSnapshotGetter) registerSnapshotGetter(getSnapshot);
    }, [registerSnapshotGetter, getSnapshot]);

    // Notify consumer when state changes (for autosave/dirty indicators)
    const pageIndex = table.getState().pagination.pageIndex;
    const pageSize = table.getState().pagination.pageSize;
    React.useEffect(() => {
        if (onTableStateChange) onTableStateChange(getSnapshot());
    }, [sorting, columnVisibility, columnFilters, pageIndex, pageSize, onTableStateChange, getSnapshot]);

    const globalFilterValue =
        filterColumn ? ((table.getColumn(filterColumn)?.getFilterValue() as string) ?? "") : "";

    return (
        <div className={cn("space-y-3 min-w-0", className)}>
            {/* Toolbar */}
            <div className="flex items-center gap-2 min-w-0">
                {filterColumn ? (
                    <div className="relative">
                        <Input
                            value={globalFilterValue}
                            onChange={(e) => table.getColumn(filterColumn)?.setFilterValue(e.target.value)}
                            placeholder={filterInputPlaceholder}
                            className="w-[240px] md:w-[320px]"
                            aria-label="Filter rows"
                        />
                    </div>
                ) : null}

                <div className="ml-auto" />

                {/* Columns visibility (stay open while toggling) */}
                <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                        <Button variant="outline" size="sm" className="gap-2" title="Show/hide columns">
                            <SlidersHorizontal className="h-4 w-4" />
                            Columns
                        </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end" className="w-56">
                        {table
                            .getAllLeafColumns()
                            .filter((col) => col.getCanHide?.() ?? true)
                            .map((col) => (
                                <DropdownMenuCheckboxItem
                                    key={col.id}
                                    checked={col.getIsVisible()}
                                    onCheckedChange={(checked) => col.toggleVisibility(!!checked)}
                                    onSelect={(e) => e.preventDefault()} // keep open for multi-toggle
                                    className="capitalize"
                                >
                                    {col.columnDef.header
                                        ? String(
                                            typeof col.columnDef.header === "string"
                                                ? col.columnDef.header
                                                : col.id.replace(/[_-]/g, " "),
                                        )
                                        : col.id.replace(/[_-]/g, " ")}
                                </DropdownMenuCheckboxItem>
                            ))}
                    </DropdownMenuContent>
                </DropdownMenu>
            </div>

            {/* Table */}
            <div className="rounded-md border overflow-hidden">
                <Table className="table-fixed">
                    <TableHeader>
                        {table.getHeaderGroups().map((hg) => (
                            <TableRow key={hg.id}>
                                {hg.headers.map((header) => {
                                    const meta = header.column.columnDef.meta as ColumnMeta | undefined;
                                    return (
                                        <TableHead key={header.id} className={cn("truncate", meta?.headerClassName)}>
                                            {header.isPlaceholder
                                                ? null
                                                : flexRender(header.column.columnDef.header, header.getContext())}
                                        </TableHead>
                                    );
                                })}
                            </TableRow>
                        ))}
                    </TableHeader>

                    <TableBody>
                        {table.getRowModel().rows.length ? (
                            table.getRowModel().rows.map((row) => (
                                <TableRow
                                    key={row.id}
                                    data-state={row.getIsSelected() ? "selected" : undefined}
                                    className={cn("hover:bg-accent/40", compact ? "[&>td]:py-2" : "[&>td]:py-3")}
                                >
                                    {row.getVisibleCells().map((cell) => {
                                        const meta = cell.column.columnDef.meta as ColumnMeta | undefined;
                                        return (
                                            <TableCell key={cell.id} className={cn("truncate", meta?.cellClassName)}>
                                                {flexRender(cell.column.columnDef.cell, cell.getContext())}
                                            </TableCell>
                                        );
                                    })}
                                </TableRow>
                            ))
                        ) : (
                            <TableRow>
                                <TableCell colSpan={columns.length} className="h-24 text-center">
                                    No results.
                                </TableCell>
                            </TableRow>
                        )}
                    </TableBody>
                </Table>
            </div>

            {/* Pagination */}
            <div className="flex items-center justify-end gap-2">
                <div className="text-xs text-muted-foreground">
                    Page {table.getState().pagination.pageIndex + 1} of {table.getPageCount()}
                </div>
                <Button
                    variant="outline"
                    size="icon"
                    onClick={() => table.previousPage()}
                    disabled={!table.getCanPreviousPage()}
                    aria-label="Previous page"
                    title="Previous page"
                >
                    <ChevronLeft className="h-4 w-4" />
                </Button>
                <Button
                    variant="outline"
                    size="icon"
                    onClick={() => table.nextPage()}
                    disabled={!table.getCanNextPage()}
                    aria-label="Next page"
                    title="Next page"
                >
                    <ChevronRight className="h-4 w-4" />
                </Button>
            </div>
        </div>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[18] FILE
Path       : components/status-badge.tsx
Size       : 1,307 bytes
Last Write : 2025-10-17 18:35:04
SHA256     : D008ABE0DCFDA52BE9DA14E56B151DE72812D49D6C38EB5D19F9629641620872
========================================================================================

//components\status-badge.tsx

"use client";

import React from "react";
import { cn } from "@/lib/utils";
import type { DeviceStatus } from "@/app/(dashboard)/dashboard-context";

/** Normalize to lowercase for styling/logic. */
const norm = (s: DeviceStatus) => s.toString().toLowerCase() as "healthy" | "warning" | "critical" | "offline";

export function StatusBadge({ status }: { status: DeviceStatus }) {
    const s = norm(status);
    const color =
        s === "healthy" ? "bg-emerald-500/15 text-emerald-600 dark:text-emerald-400" :
            s === "warning" ? "bg-amber-500/15  text-amber-700  dark:text-amber-400" :
                s === "critical" ? "bg-red-500/15     text-red-600     dark:text-red-400" :
                    "bg-slate-500/15   text-slate-600   dark:text-slate-300"; // offline

    const label =
        s === "healthy" ? "Healthy" :
            s === "warning" ? "Warning" :
                s === "critical" ? "Critical" :
                    "Offline";

    return (
        <span
            className={cn(
                "inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",
                color
            )}
            aria-label={`Status: ${label}`}
        >
            {label}
        </span>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[19] FILE
Path       : components/filters-rail.tsx
Size       : 5,019 bytes
Last Write : 2025-10-17 20:19:56
SHA256     : 172BC0B99BBCCB77963223CC3C22C2E60CBBA558B17F49B906B5E0CB42E088F2
========================================================================================

// components/filters-rail.tsx
"use client";

import * as React from "react";
import {
    useDashboard,
    type DeviceStatus,
    type Device,
} from "@/app/(dashboard)/dashboard-context";
import { Card } from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";
import { Checkbox } from "@/components/ui/checkbox";
import { Button } from "@/components/ui/button";

// Canonical labels for the UI (and what we store)
const STATUS_LABELS = ["Healthy", "Warning", "Critical", "Offline"] as const;
type StatusLabel = (typeof STATUS_LABELS)[number];

export default function FiltersRail() {
    const {
        operatingSystems, // e.g. ["Windows", "Linux", "macOS"]
        activeFilters,    // { status: DeviceStatus[]; os: Device["os"][] }
        setActiveFilters,
    } = useDashboard();

    // Build OS options from canonical values in context
    const osOptions = React.useMemo(
        () =>
            (operatingSystems ?? []).map((os) => ({
                key: os as Device["os"], // ensure canonical union type
                label: os === "macOS" ? "macOS" : os,
            })),
        [operatingSystems]
    );

    // Sets for quick membership checks
    const statusSet = React.useMemo(
        () => new Set(activeFilters.status ?? []),
        [activeFilters.status]
    );
    const osSet = React.useMemo(
        () => new Set(activeFilters.os ?? []),
        [activeFilters.os]
    );

    // Mutators (strictly typed)
    const toggleStatus = (label: StatusLabel, checked: boolean) => {
        const key = label as DeviceStatus; // TitleCase is valid in your union
        setActiveFilters((prev) => {
            const curr = new Set<DeviceStatus>(prev.status ?? []);
            if (checked) curr.add(key);
            else curr.delete(key);
            return { ...prev, status: Array.from(curr) as DeviceStatus[] };
        });
    };

    const toggleOs = (os: Device["os"], checked: boolean) => {
        setActiveFilters((prev) => {
            const curr = new Set<Device["os"]>(prev.os ?? []);
            if (checked) curr.add(os);
            else curr.delete(os);
            return { ...prev, os: Array.from(curr) as Device["os"][] };
        });
    };

    // Merge so future fields (if any) aren't wiped
    const clearAll = () =>
        setActiveFilters((prev) => ({
            ...prev,
            status: [] as DeviceStatus[],
            os: [] as Device["os"][],
        }));

    return (
        <Card className="p-3 space-y-4">
            <div className="flex items-center justify-between">
                <div className="text-sm font-semibold">Filters</div>
                {/* Destructive button with simple shade change on hover */}
                <Button
                    variant="destructive"
                    size="sm"
                    className="hover:bg-destructive/80"
                    onClick={clearAll}
                    title="Clear all filters"
                    aria-label="Clear all filters"
                >
                    Clear
                </Button>
            </div>

            <div>
                <div className="text-xs font-medium text-muted-foreground mb-2">Status</div>
                <div className="space-y-2">
                    {STATUS_LABELS.map((label) => {
                        const checked = statusSet.has(label as DeviceStatus);
                        return (
                            <label key={label} className="flex items-center gap-2">
                                <Checkbox
                                    checked={checked}
                                    onCheckedChange={(v) => toggleStatus(label, v === true)}
                                    aria-label={label}
                                />
                                <span className="text-sm">{label}</span>
                            </label>
                        );
                    })}
                </div>
            </div>

            <Separator />

            <div>
                <div className="text-xs font-medium text-muted-foreground mb-2">OS</div>
                <div className="space-y-2">
                    {osOptions.map(({ key, label }) => {
                        const checked = osSet.has(key);
                        return (
                            <label key={key} className="flex items-center gap-2">
                                <Checkbox
                                    checked={checked}
                                    onCheckedChange={(v) => toggleOs(key, v === true)}
                                    aria-label={label}
                                />
                                <span className="text-sm">{label}</span>
                            </label>
                        );
                    })}
                </div>
            </div>
        </Card>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[20] FILE
Path       : components/ui/button.tsx
Size       : 2,552 bytes
Last Write : 2025-10-17 20:57:49
SHA256     : 0443907C00677BFA2BCE6DDD423A44390E51E8005CD1CEAB508AEDA1D8781EBC
========================================================================================

// components/ui/button.tsx

import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const buttonVariants = cva(
    "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
    {
        variants: {
            variant: {
                default:
                    "bg-primary text-primary-foreground hover:bg-primary/90",
                destructive:
                    "bg-destructive text-destructive-foreground hover:bg-destructive/90",
                outline:
                    "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
                secondary:
                    "bg-secondary text-secondary-foreground hover:bg-secondary/80",
                ghost:
                    "hover:bg-accent hover:text-accent-foreground",
                link:
                    "text-primary underline-offset-4 hover:underline",

                // ✅ Custom variants
                success:
                    "bg-emerald-600 text-white hover:bg-emerald-600/90 dark:bg-emerald-500 dark:hover:bg-emerald-500/90",
                warning:
                    "bg-amber-500 text-white hover:bg-amber-500/90 dark:bg-amber-600 dark:hover:bg-amber-600/90",
            },
            size: {
                default: "h-10 px-4 py-2",
                sm: "h-9 rounded-md px-3",
                lg: "h-11 rounded-md px-8",
                icon: "h-10 w-10",
            },
        },
        defaultVariants: {
            variant: "default",
            size: "default",
        },
    }
);

export interface ButtonProps
    extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
    asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
    ({ className, variant, size, asChild = false, ...props }, ref) => {
        const Comp = asChild ? Slot : "button";
        return (
            <Comp
                className={cn(buttonVariants({ variant, size, className }))}
                ref={ref}
                {...props}
            />
        );
    }
);
Button.displayName = "Button";

export { Button, buttonVariants };



----------------------------------------------------------------------------------------



========================================================================================
[21] FILE
Path       : components/ui/card.tsx
Size       : 2,122 bytes
Last Write : 2025-10-17 18:30:11
SHA256     : 1014C5EE0FEC04218F341711FE7087527956F5FD146516E831E7219FD19CE1A7
========================================================================================

//components\ui\card.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
    HTMLDivElement,
    React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
    <div
        ref={ref}
        className={cn(
            "rounded-lg border bg-card text-card-foreground shadow-sm",
            className
        )}
        {...props}
    />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
    HTMLDivElement,
    React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
    <div
        ref={ref}
        className={cn("flex flex-col space-y-1.5 p-6", className)}
        {...props}
    />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
    HTMLParagraphElement,
    React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
    <h3
        ref={ref}
        className={cn(
            "text-2xl font-semibold leading-none tracking-tight",
            className
        )}
        {...props}
    />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
    HTMLParagraphElement,
    React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
    <p
        ref={ref}
        className={cn("text-sm text-muted-foreground", className)}
        {...props}
    />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
    HTMLDivElement,
    React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
    <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
    HTMLDivElement,
    React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
    <div
        ref={ref}
        className={cn("flex items-center p-6 pt-0", className)}
        {...props}
    />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }



----------------------------------------------------------------------------------------



========================================================================================
[22] FILE
Path       : components/ui/table.tsx
Size       : 3,151 bytes
Last Write : 2025-10-17 18:31:53
SHA256     : 773193A7E9F1EA1662234302F24C3C481EA382445EEE4F81B8BB33025CE74D47
========================================================================================

//components\ui\table.tsx

"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
    HTMLTableElement,
    React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
    <div className="relative w-full overflow-auto">
        <table
            ref={ref}
            className={cn("w-full caption-bottom text-sm", className)}
            {...props}
        />
    </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <tbody
        ref={ref}
        className={cn("[&_tr:last-child]:border-0", className)}
        {...props}
    />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <tfoot
        ref={ref}
        className={cn(
            "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
            className
        )}
        {...props}
    />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
    HTMLTableRowElement,
    React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
    <tr
        ref={ref}
        className={cn(
            "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
            className
        )}
        {...props}
    />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
    HTMLTableCellElement,
    React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
    <th
        ref={ref}
        className={cn(
            "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
            className
        )}
        {...props}
    />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
    HTMLTableCellElement,
    React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
    <td
        ref={ref}
        className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
        {...props}
    />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
    HTMLTableCaptionElement,
    React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
    <caption
        ref={ref}
        className={cn("mt-4 text-sm text-muted-foreground", className)}
        {...props}
    />
))
TableCaption.displayName = "TableCaption"

export {
    Table,
    TableHeader,
    TableBody,
    TableFooter,
    TableHead,
    TableRow,
    TableCell,
    TableCaption,
}



----------------------------------------------------------------------------------------



========================================================================================
[23] FILE
Path       : components/ui/select.tsx
Size       : 5,388 bytes
Last Write : 2025-10-20 02:15:31
SHA256     : 238072975354F128E5863D4F34F0AA25010ADC480734996331D74F231A503C1A
========================================================================================

// components/ui/select.tsx

"use client";

import * as React from "react";
import * as SelectPrimitive from "@radix-ui/react-select";
import { Check, ChevronDown } from "lucide-react";
import { cn } from "@/lib/utils";

const Select = SelectPrimitive.Root;
const SelectGroup = SelectPrimitive.Group;
const SelectValue = SelectPrimitive.Value;

const SelectTrigger = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Trigger>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
    <SelectPrimitive.Trigger
        ref={ref}
        className={cn(
            // Base
            "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm",
            "placeholder:text-muted-foreground shadow-sm transition-colors outline-none",
            // Remove thick ring; keep subtle 1px border color on focus
            "focus:outline-none focus-visible:outline-none focus-visible:ring-0 focus-visible:ring-offset-0",
            "focus:border-input",
            // When the popover is open, keep it subtle (avoid ring)
            "data-[state=open]:ring-0 data-[state=open]:ring-offset-0",
            // Disabled
            "disabled:cursor-not-allowed disabled:opacity-50",
            className
        )}
        {...props}
    >
        {children}
        <SelectPrimitive.Icon asChild>
            <ChevronDown className="h-4 w-4 opacity-50" />
        </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
));
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName;

const SelectContent = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
    <SelectPrimitive.Portal>
        <SelectPrimitive.Content
            ref={ref}
            className={cn(
                "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md",
                "data-[state=open]:animate-in data-[state=closed]:animate-out",
                "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
                "data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
                "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2",
                "data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
                position === "popper" &&
                "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
                className
            )}
            position={position}
            {...props}
        >
            <SelectPrimitive.Viewport
                className={cn(
                    "p-1",
                    position === "popper" &&
                    "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
                )}
            >
                {children}
            </SelectPrimitive.Viewport>
        </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
));
SelectContent.displayName = SelectPrimitive.Content.displayName;

const SelectLabel = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Label>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.Label
        ref={ref}
        className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
        {...props}
    />
));
SelectLabel.displayName = SelectPrimitive.Label.displayName;

const SelectItem = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Item>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
    <SelectPrimitive.Item
        ref={ref}
        className={cn(
            "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none",
            "focus:bg-accent focus:text-accent-foreground",
            "data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            className
        )}
        {...props}
    >
        <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
            <SelectPrimitive.ItemIndicator>
                <Check className="h-4 w-4" />
            </SelectPrimitive.ItemIndicator>
        </span>

        <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
));
SelectItem.displayName = SelectPrimitive.Item.displayName;

const SelectSeparator = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Separator>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.Separator
        ref={ref}
        className={cn("-mx-1 my-1 h-px bg-muted", className)}
        {...props}
    />
));
SelectSeparator.displayName = SelectPrimitive.Separator.displayName;

export {
    Select,
    SelectGroup,
    SelectValue,
    SelectTrigger,
    SelectContent,
    SelectLabel,
    SelectItem,
    SelectSeparator,
};



----------------------------------------------------------------------------------------



========================================================================================
[24] FILE
Path       : components/ui/input.tsx
Size       : 1,226 bytes
Last Write : 2025-10-20 02:23:24
SHA256     : 4F101CE8B1CC91FE0A4B19BA86AA200044FBFDA775415BE94AC3F66A420D7034
========================================================================================

"use client";

import * as React from "react";
import { cn } from "@/lib/utils";

export interface InputProps
    extends React.InputHTMLAttributes<HTMLInputElement> { }

const Input = React.forwardRef<HTMLInputElement, InputProps>(
    ({ className, type = "text", ...props }, ref) => {
        return (
            <input
                ref={ref}
                type={type}
                className={cn(
                    // Base
                    "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",
                    "placeholder:text-muted-foreground shadow-sm transition-colors",
                    // Remove thick ring; keep subtle 1px border color change on focus
                    "focus:outline-none focus-visible:outline-none",
                    "focus:ring-0 focus:ring-offset-0 focus-visible:ring-0 focus-visible:ring-offset-0",
                    "focus:border-primary",
                    // Disabled
                    "disabled:cursor-not-allowed disabled:opacity-50",
                    className
                )}
                {...props}
            />
        );
    }
);
Input.displayName = "Input";

export { Input };



----------------------------------------------------------------------------------------



========================================================================================
[25] FILE
Path       : components/ui/tabs.tsx
Size       : 2,088 bytes
Last Write : 2025-10-17 18:32:01
SHA256     : A6C0B6CA8E5233AEC93CD4F358FFD80BD4C8C8D35B58475FDFF649D8F53E3615
========================================================================================

//components\ui\tabs.tsx

"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
    React.ElementRef<typeof TabsPrimitive.List>,
    React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
    <TabsPrimitive.List
        ref={ref}
        className={cn(
            "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
            className
        )}
        {...props}
    />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
    React.ElementRef<typeof TabsPrimitive.Trigger>,
    React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
    <TabsPrimitive.Trigger
        ref={ref}
        className={cn(
            "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
            className
        )}
        {...props}
    />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
    React.ElementRef<typeof TabsPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
    <TabsPrimitive.Content
        ref={ref}
        className={cn(
            "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
            className
        )}
        {...props}
    />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }



----------------------------------------------------------------------------------------



========================================================================================
[26] FILE
Path       : components/ui/dropdown-menu.tsx
Size       : 8,298 bytes
Last Write : 2025-10-20 02:08:29
SHA256     : 81B1184E0E0E06C79004ED06FFF1EC6DA47A4D2B91D1288FD4C634FFBC2918D8
========================================================================================

// components/ui/dropdown-menu.tsx
"use client";

import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { Check, ChevronRight, Circle } from "lucide-react";
import { cn } from "@/lib/utils";

const DropdownMenu = DropdownMenuPrimitive.Root;
const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;
const DropdownMenuGroup = DropdownMenuPrimitive.Group;
const DropdownMenuPortal = DropdownMenuPrimitive.Portal;
const DropdownMenuSub = DropdownMenuPrimitive.Sub;
const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
        inset?: boolean;
    }
>(({ className, inset, children, ...props }, ref) => (
    <DropdownMenuPrimitive.SubTrigger
        ref={ref}
        className={cn(
            "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none",
            "focus:bg-accent focus:text-accent-foreground",
            inset && "pl-8",
            className
        )}
        {...props}
    >
        {children}
        <ChevronRight className="ml-auto h-4 w-4" />
    </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName =
    DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
    <DropdownMenuPrimitive.SubContent
        ref={ref}
        className={cn(
            "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
            "data-[state=open]:animate-in data-[state=closed]:animate-out",
            "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
            "data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
            "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2",
            "data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
            className
        )}
        {...props}
    />
));
DropdownMenuSubContent.displayName =
    DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
    <DropdownMenuPrimitive.Portal>
        <DropdownMenuPrimitive.Content
            ref={ref}
            sideOffset={sideOffset}
            className={cn(
                "z-50 min-w-[10rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
                "data-[state=open]:animate-in data-[state=closed]:animate-out",
                "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
                "data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
                "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2",
                "data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
                className
            )}
            {...props}
        />
    </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName =
    DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.Item>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
        inset?: boolean;
    }
>(({ className, inset, ...props }, ref) => (
    <DropdownMenuPrimitive.Item
        ref={ref}
        className={cn(
            "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none",
            // subtle focus (no thick ring)
            "focus:bg-accent focus:text-accent-foreground",
            "data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            inset && "pl-8",
            className
        )}
        {...props}
    />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
    <DropdownMenuPrimitive.CheckboxItem
        ref={ref}
        className={cn(
            "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none",
            "focus:bg-accent focus:text-accent-foreground",
            "data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            className
        )}
        checked={checked}
        {...props}
    >
        <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
            <DropdownMenuPrimitive.ItemIndicator>
                <Check className="h-4 w-4" />
            </DropdownMenuPrimitive.ItemIndicator>
        </span>
        {children}
    </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName =
    DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
    <DropdownMenuPrimitive.RadioItem
        ref={ref}
        className={cn(
            "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none",
            "focus:bg-accent focus:text-accent-foreground",
            "data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            className
        )}
        {...props}
    >
        <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
            <DropdownMenuPrimitive.ItemIndicator>
                <Circle className="h-2 w-2 fill-current" />
            </DropdownMenuPrimitive.ItemIndicator>
        </span>
        {children}
    </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName =
    DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.Label>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
        inset?: boolean;
    }
>(({ className, inset, ...props }, ref) => (
    <DropdownMenuPrimitive.Label
        ref={ref}
        className={cn(
            "px-2 py-1.5 text-sm font-semibold",
            inset && "pl-8",
            className
        )}
        {...props}
    />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
    <DropdownMenuPrimitive.Separator
        ref={ref}
        className={cn("-mx-1 my-1 h-px bg-muted", className)}
        {...props}
    />
));
DropdownMenuSeparator.displayName =
    DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({
    className,
    ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
    return (
        <span
            className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)}
            {...props}
        />
    );
};

export {
    DropdownMenu,
    DropdownMenuTrigger,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuCheckboxItem,
    DropdownMenuRadioItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuShortcut,
    DropdownMenuGroup,
    DropdownMenuPortal,
    DropdownMenuSub,
    DropdownMenuSubContent,
    DropdownMenuSubTrigger,
    DropdownMenuRadioGroup,
};



----------------------------------------------------------------------------------------



========================================================================================
[27] FILE
Path       : components/ui/badge.tsx
Size       : 1,306 bytes
Last Write : 2025-10-17 18:29:39
SHA256     : 7EF4CDD65467EB25B813C1BD864381830D14BA9441237A20D93B8D36ED34D1F9
========================================================================================

//components\ui\badge.tsx

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
    "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
    {
        variants: {
            variant: {
                default:
                    "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
                secondary:
                    "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
                destructive:
                    "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
                outline: "text-foreground",
            },
        },
        defaultVariants: {
            variant: "default",
        },
    }
)

export interface BadgeProps
    extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> { }

function Badge({ className, variant, ...props }: BadgeProps) {
    return (
        <div className={cn(badgeVariants({ variant }), className)} {...props} />
    )
}

export { Badge, badgeVariants }



----------------------------------------------------------------------------------------



========================================================================================
[28] FILE
Path       : components/ui/separator.tsx
Size       : 920 bytes
Last Write : 2025-10-17 18:31:34
SHA256     : 801AD632DF173E174A1F96C4A98A6842971DEC255ED8D6BF8557F34175A57695
========================================================================================

//components\ui\separator.tsx

"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
    React.ElementRef<typeof SeparatorPrimitive.Root>,
    React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
    (
        { className, orientation = "horizontal", decorative = true, ...props },
        ref
    ) => (
        <SeparatorPrimitive.Root
            ref={ref}
            decorative={decorative}
            orientation={orientation}
            className={cn(
                "shrink-0 bg-border",
                orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
                className
            )}
            {...props}
        />
    )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }



----------------------------------------------------------------------------------------



========================================================================================
[29] FILE
Path       : components/ui/checkbox.tsx
Size       : 1,194 bytes
Last Write : 2025-10-17 18:30:20
SHA256     : 7E362DBC4B5F6EEECEC4CD61B76D04C548E1921802CEA36B9C57A2323C6ECE55
========================================================================================

//components\ui\checkbox.tsx

"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
    React.ElementRef<typeof CheckboxPrimitive.Root>,
    React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
    <CheckboxPrimitive.Root
        ref={ref}
        className={cn(
            "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
            className
        )}
        {...props}
    >
        <CheckboxPrimitive.Indicator
            className={cn("flex items-center justify-center text-current")}
        >
            <Check className="h-4 w-4" />
        </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }



----------------------------------------------------------------------------------------



========================================================================================
[30] FILE
Path       : components/ui/tooltip.tsx
Size       : 1,472 bytes
Last Write : 2025-10-17 18:32:10
SHA256     : 22CF04F2B4549A3DC4FC6A9CCF193C77DA6FB08CFFCEBE7B90E21E44E3FCFA5A
========================================================================================

//components\ui\tooltip.tsx

"use client";

import * as React from "react";
import * as TooltipPrimitive from "@radix-ui/react-tooltip";
import { cn } from "@/lib/utils";

/**
 * Expose both a named and a default export for TooltipProvider
 * so users can `import { TooltipProvider }` or `import TooltipProvider`.
 */
export const TooltipProvider = TooltipPrimitive.Provider;
const TooltipProviderDefault = TooltipPrimitive.Provider;

export const Tooltip = TooltipPrimitive.Root;
export const TooltipTrigger = TooltipPrimitive.Trigger;

export const TooltipContent = React.forwardRef<
    React.ElementRef<typeof TooltipPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 6, ...props }, ref) => (
    <TooltipPrimitive.Content
        ref={ref}
        sideOffset={sideOffset}
        className={cn(
            "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-xs text-popover-foreground shadow-md",
            "data-[state=delayed-open]:data-[side=top]:animate-in",
            "data-[state=delayed-open]:data-[side=bottom]:animate-in",
            "data-[state=delayed-open]:data-[side=left]:animate-in",
            "data-[state=delayed-open]:data-[side=right]:animate-in",
            className
        )}
        {...props}
    />
));
TooltipContent.displayName = TooltipPrimitive.Content.displayName;

export default TooltipProviderDefault;



----------------------------------------------------------------------------------------



========================================================================================
[31] FILE
Path       : components/ui/toaster.tsx
Size       : 4,124 bytes
Last Write : 2025-10-29 13:12:12
SHA256     : 8424C127E0C83164761B9221BC76D3BFB3DCBABC205FAA1F0959DBF1B399D594
========================================================================================

// remoteiq-frontend/components/ui/toaster.tsx
"use client";

import * as React from "react";
import * as Toast from "@radix-ui/react-toast";
import { X } from "lucide-react";
import { dismiss, useToastState } from "./use-toast";

const base =
    "pointer-events-auto rounded-md border px-3 py-2 shadow-md bg-background text-foreground";
const variants = {
    default: "",
    destructive: "border-red-600 bg-red-600/10",
    success: "border-emerald-600 bg-emerald-600/10",
} as const;
type VariantKey = keyof typeof variants;

export default function Toaster() {
    const items = useToastState();

    return (
        <Toast.Provider swipeDirection="right">
            {/* Bottom-right corner; stack grows upward */}
            <div className="fixed inset-0 z-50 flex items-end justify-end p-4 pointer-events-none">
                <div className="flex w-full max-w-sm flex-col-reverse gap-2">
                    {items.map((t) => {
                        const variantKey: VariantKey =
                            (t as any).variant ?? ("default" as VariantKey);
                        return (
                            <Toast.Root
                                key={t.id}
                                duration={(t as any).duration}
                                className={`group ${base} ${variants[variantKey]}`}
                                onOpenChange={(open) => {
                                    if (!open) dismiss(t.id);
                                }}
                            >
                                <div className="flex items-start gap-3">
                                    <div className="min-w-0">
                                        {(t as any).title ? (
                                            <Toast.Title className="text-sm font-semibold">
                                                {(t as any).title}
                                            </Toast.Title>
                                        ) : null}
                                        {(t as any).description ? (
                                            <Toast.Description className="mt-0.5 text-xs text-muted-foreground break-words">
                                                {(t as any).description}
                                            </Toast.Description>
                                        ) : null}
                                    </div>

                                    <div className="ml-auto flex items-center gap-2 pl-2">
                                        {(t as any).action ? (
                                            <Toast.Action asChild altText={(t as any).action.label}>
                                                <button
                                                    onClick={(t as any).action.onClick}
                                                    className="text-xs underline text-muted-foreground hover:text-foreground"
                                                >
                                                    {(t as any).action.label}
                                                </button>
                                            </Toast.Action>
                                        ) : null}
                                        <Toast.Close
                                            aria-label="Close"
                                            className="text-muted-foreground hover:text-foreground"
                                        >
                                            <X className="h-4 w-4" />
                                        </Toast.Close>
                                    </div>
                                </div>
                            </Toast.Root>
                        );
                    })}
                </div>
            </div>

            {/* Bottom-right viewport to enable swipe/aria; matches visual position */}
            <Toast.Viewport className="fixed bottom-4 right-4 z-[60] outline-none" />
        </Toast.Provider>
    );
}



----------------------------------------------------------------------------------------



========================================================================================
[32] FILE
Path       : components/ui/use-toast.ts
Size       : 2,377 bytes
Last Write : 2025-10-29 13:12:12
SHA256     : 11B706BA148BCC036CE6EC2073E0CC567D14B9F776756FE5CA9410EC9B87E934
========================================================================================

"use client";

import * as React from "react";

/** Variants that map to tailwind classes in <Toaster/> */
export type ToastVariant = "default" | "destructive" | "success" | "warning";

export type ToastOptions = {
    id?: string;
    title?: string;
    description?: string;
    variant?: ToastVariant;
    /** Back-compat for older calls: kind === variant */
    kind?: ToastVariant;
    /** Auto-dismiss in ms (0 = stay until closed) */
    duration?: number;
    /** Optional action button (label + onClick) */
    action?: { label: string; onClick: () => void };
};

type ToastInternal = Required<Pick<ToastOptions, "id">> &
    Omit<ToastOptions, "id"> & { createdAt: number };

const listeners = new Set<(list: ToastInternal[]) => void>();
let toasts: ToastInternal[] = [];

/* -------- store helpers -------- */
function notify() {
    for (const l of listeners) l(toasts);
}
function uid() {
    return Math.random().toString(36).slice(2);
}

export function toast(opts: ToastOptions) {
    const id = opts.id ?? uid();
    const variant: ToastVariant = (opts.variant ?? opts.kind ?? "default") as ToastVariant;

    const t: ToastInternal = {
        id,
        title: opts.title ?? "",
        description: opts.description ?? "",
        variant,
        duration: opts.duration ?? 3500,
        action: opts.action,
        createdAt: Date.now(),
    };
    toasts = [t, ...toasts].slice(0, 100);
    notify();
    return { id };
}

export function dismiss(id?: string) {
    if (!id) {
        toasts = [];
    } else {
        toasts = toasts.filter((x) => x.id !== id);
    }
    notify();
}

/** Imperative hook (for components that want to trigger toasts) */
export function useToast() {
    return React.useMemo(
        () => ({
            toast,
            dismiss,
            // Back-compat alias used in some files:
            push: toast,
        }),
        []
    );
}

/** Internal: subscribe to toast store (used by <Toaster/>) */
export function useToastState() {
    const [items, setItems] = React.useState<ToastInternal[]>([]);
    React.useEffect(() => {
        setItems(toasts);
        const sub = (l: ToastInternal[]) => setItems([...l]);
        listeners.add(sub);
        return () => void listeners.delete(sub);
    }, []);
    return items;
}



----------------------------------------------------------------------------------------



========================================================================================
[33] FILE
Path       : lib/api.ts
Size       : 31,474 bytes
Last Write : 2025-10-30 21:22:32
SHA256     : 8359C5F172859D01D4D88C71ED7302FFB7F24E58CFD0953306E8086115323F3E
========================================================================================

// Centralized typed API client used by the frontend (Next.js / React).
// It reads NEXT_PUBLIC_API_BASE for the backend base URL.

// ---------------------------- ENV / BASE ------------------------------------
const API_BASE =
  (typeof process !== "undefined" && process.env.NEXT_PUBLIC_API_BASE) || "";

// Utility to join base + path safely
function url(path: string) {
  if (!API_BASE) return path;
  return `${API_BASE.replace(/\/+$/, "")}${path.startsWith("/") ? "" : "/"}${path}`;
}

type JsonInit = Omit<RequestInit, "body" | "method"> & {
  body?: any;
  method?: "GET" | "POST" | "PUT" | "PATCH" | "DELETE";
};

// unified fetch wrapper w/ JSON
export async function jfetch<T>(path: string, init: JsonInit = {}): Promise<T> {
  const { body, ...rest } = init;
  const res = await fetch(url(path), {
    method: init.method ?? (body != null ? "POST" : "GET"),
    credentials: "include",
    headers: {
      "Content-Type": "application/json",
      ...(init.headers ?? {}),
    },
    body: body != null ? JSON.stringify(body) : undefined,
    ...rest,
  });

  if (!res.ok) {
    // try to surface JSON message; fall back to text
    let msg = "";
    try {
      const data = await res.json();
      msg = typeof (data as any)?.message === "string" ? (data as any).message : JSON.stringify(data);
    } catch {
      try {
        msg = await res.text();
      } catch {
        // ignore
      }
    }
    const err = new Error(msg || `Request failed: ${res.status}`);
    (err as any).status = res.status; // preserve status for caller fallbacks
    throw err;
  }

  if (res.status === 204) return undefined as unknown as T;
  try {
    return (await res.json()) as T;
  } catch {
    // when backend returns 200 with empty body
    return undefined as unknown as T;
  }
}

// ---------------------------------------------------------------------------
// Devices (grid + details)
// ---------------------------------------------------------------------------
// lib/api.ts  (only showing the Device type block; keep the rest as-is)
export type Device = {
  id: string;
  hostname: string;
  os: string;
  arch?: string | null;
  lastSeen?: string | null;
  status: "online" | "offline";
  client?: string | null;
  site?: string | null;
  user?: string | string[] | null;
  version?: string | null;      // <-- add
  primaryIp?: string | null;    // <-- add
  /** Optional UUID for the underlying agent (if backend provides it). */
  agentUuid?: string | null;    // <-- NEW (harmless if absent)
};

export type DevicesResponse = {
  items: Device[];
  nextCursor: string | null;
};

export type DeviceFilters = {
  q?: string;
  status?: "online" | "offline";
  os?: string[];
};

export async function fetchDevices(
  pageSize = 25,
  cursor: string | null = null,
  filters?: DeviceFilters
): Promise<DevicesResponse> {
  const sp = new URLSearchParams();
  sp.set("pageSize", String(pageSize));
  if (cursor) sp.set("cursor", cursor);
  if (filters?.q) sp.set("q", filters.q);
  if (filters?.status) sp.set("status", filters.status);
  (filters?.os ?? []).forEach((o) => sp.append("os", o));
  return await jfetch<DevicesResponse>(`/api/devices?${sp.toString()}`);
}

export async function fetchDevice(id: string): Promise<Device> {
  return await jfetch<Device>(`/api/devices/${encodeURIComponent(id)}`);
}

// ---------------------------------------------------------------------------
// Device insights (checks / software)
// ---------------------------------------------------------------------------
export type DeviceCheck = {
  id: string;
  name: string;
  status: "Passing" | "Warning" | "Failing";
  lastRun: string;
  output: string;

  // ----- Optional advanced fields (rendered when present) -----
  /** e.g., "PING","CPU","MEMORY","DISK","SERVICE","PROCESS","PORT","WINEVENT","SOFTWARE","SECURITY","SCRIPT","PATCH","CERT","SMART","RDP","SMB","FIREWALL" */
  type?: string;
  /** severity classification applied to alerting paths */
  severity?: "WARN" | "CRIT";
  /** optional grouping like "Performance", "Security", "Compliance" */
  category?: string;
  /** arbitrary labels */
  tags?: string[];
  /** thresholds used to evaluate this check (key/value) */
  thresholds?: Record<string, any>;
  /** metrics captured by the last run (key/value) */
  metrics?: Record<string, number | string | boolean>;
  /** true if within an active maintenance window */
  maintenance?: boolean;
  /** deduplication key for alert correlation */
  dedupeKey?: string;
};

/** Fetch device-scoped checks; limit is optional and passed to the backend if provided. */
export async function fetchDeviceChecks(
  deviceId: string,
  limit?: number
): Promise<{ items: DeviceCheck[] }> {
  const base = `/api/devices/${encodeURIComponent(deviceId)}/checks`;
  const path = typeof limit === "number" ? `${base}?limit=${encodeURIComponent(String(limit))}` : base;
  return await jfetch(path);
}

export type DeviceSoftware = {
  id: string;
  name: string;
  version: string;
  publisher?: string | null;
  installDate?: string | null;
};

export async function fetchDeviceSoftware(deviceId: string): Promise<{ items: DeviceSoftware[] }> {
  return await jfetch(`/api/devices/${encodeURIComponent(deviceId)}/software`);
}

// ---------------------------------------------------------------------------
// Device actions
// ---------------------------------------------------------------------------
export async function rebootDevice(id: string): Promise<{ accepted: true; jobId: string }> {
  return await jfetch(`/api/devices/${encodeURIComponent(id)}/actions/reboot`, { method: "POST" });
}
export async function patchDevice(id: string): Promise<{ accepted: true; jobId: string }> {
  return await jfetch(`/api/devices/${encodeURIComponent(id)}/actions/patch`, { method: "POST" });
}

// ---------------------------------------------------------------------------
// Automation / Runs
// ---------------------------------------------------------------------------
export type RunScriptRequest = {
  deviceId: string;
  script: string;
  shell?: "powershell" | "bash" | "cmd";
  timeoutSec?: number;
};

export async function postRunScript(req: RunScriptRequest): Promise<{ jobId: string }> {
  return await jfetch(`/api/automation/runs`, { method: "POST", body: req });
}

export type JobSnapshot = {
  jobId: string;
  deviceId: string;
  status: "queued" | "running" | "succeeded" | "failed" | "canceled";
  log: string;
  exitCode?: number | null;
  startedAt: number;
  finishedAt?: number | null;
};

export async function fetchJob(jobId: string): Promise<JobSnapshot> {
  return await jfetch(`/api/automation/runs/${encodeURIComponent(jobId)}`);
}
export async function fetchJobLog(jobId: string): Promise<{ jobId: string; log: string }> {
  return await jfetch(`/api/automation/runs/${encodeURIComponent(jobId)}/log`);
}

// ---------------------------------------------------------------------------
// Admin → Database configuration
// ---------------------------------------------------------------------------
export type DbEngine = "postgresql" | "mysql" | "mssql" | "sqlite" | "mongodb";
export type DbAuthMode = "fields" | "url";
export type StorageDomain =
  | "users" | "roles" | "sessions" | "audit_logs" | "devices" | "policies" | "email_queue";

export type DatabaseMappings = Record<StorageDomain, string>;

export type DatabaseConfig = {
  enabled: boolean;
  engine: DbEngine;
  authMode: DbAuthMode;
  url?: string;
  host?: string;
  port?: number;
  dbName?: string;
  username?: string;
  password?: string;
  ssl: boolean;
  poolMin: number;
  poolMax: number;
  readReplicas?: string;
  mappings: DatabaseMappings;
};

export type DbTestResult = {
  ok: boolean;
  engine: DbEngine;
  primary: { ok: boolean; message?: string };
  replicas?: Array<{ url: string; ok: boolean; message?: string }>;
  note?: string;
};

export async function getDatabaseConfig(): Promise<DatabaseConfig | { enabled: false }> {
  return await jfetch(`/api/admin/database`);
}

export async function testDatabaseConfig(cfg: DatabaseConfig): Promise<DbTestResult> {
  return await jfetch(`/api/admin/database/test`, { method: "POST", body: cfg });
}

export async function saveDatabaseConfig(cfg: DatabaseConfig): Promise<void> {
  await jfetch<void>(`/api/admin/database/save`, { method: "POST", body: cfg });
}

export async function dryRunDatabaseMigration(): Promise<{ ok: true; destructive: false; steps: string[] }> {
  return await jfetch(`/api/admin/database/migrate/dry-run`, { method: "POST" });
}

// --- Company profile (admin) ---
export type CompanyProfile = {
  name: string;
  legalName?: string;
  email?: string;
  phone?: string;
  fax?: string;
  website?: string;
  vatTin?: string;
  address1?: string;
  address2?: string;
  city?: string;
  state?: string;
  postal?: string;
  country?: string;
};

export async function getCompanyProfile(): Promise<CompanyProfile> {
  return await jfetch(`/api/admin/company`);
}

export async function saveCompanyProfile(p: CompanyProfile): Promise<void> {
  await jfetch(`/api/admin/company/save`, { method: "POST", body: p });
}

// --- Localization (admin) ---
export type LocalizationSettings = {
  language: string;                // "en-US"
  dateFormat: string;              // "MM/DD/YYYY"
  timeFormat: "12h" | "24h";       // strictly 12h/24h for UI consistency
  numberFormat: string;            // "1,234.56"
  timeZone: string;                // "America/New_York"
  firstDayOfWeek: "sunday" | "monday";
  currency?: string;               // "USD"
};

export async function getLocalizationSettings(): Promise<LocalizationSettings> {
  const res = await jfetch<LocalizationSettings | { exists: false }>(`/api/admin/localization`);
  if ((res as any)?.exists === false) {
    return {
      language: "en-US",
      dateFormat: "MM/DD/YYYY",
      timeFormat: "12h",
      numberFormat: "1,234.56",
      timeZone: "America/New_York",
      firstDayOfWeek: "sunday",
      currency: "USD",
    };
  }
  // Back-compat: normalize any legacy strings to the union
  const tfRaw = (res as any).timeFormat as string | undefined;
  const timeFormat: "12h" | "24h" = tfRaw === "24h" || tfRaw === "HH:mm" ? "24h" : "12h";
  return { ...(res as LocalizationSettings), timeFormat };
}

export async function saveLocalizationSettings(p: LocalizationSettings): Promise<void> {
  await jfetch(`/api/admin/localization/save`, { method: "POST", body: p });
}

// --- Support & Legal (admin) ---
export type SupportLegalSettings = {
  id?: number;                 // present on GET only
  supportEmail?: string;
  supportPhone?: string;
  knowledgeBaseUrl?: string;
  statusPageUrl?: string;
  privacyPolicyUrl?: string;
  termsUrl?: string;
  gdprContactEmail?: string;
  legalAddress?: string;
  ticketPortalUrl?: string;
  phoneHours?: string;
  notesHtml?: string;
};

export async function getSupportLegalSettings(): Promise<SupportLegalSettings> {
  return await jfetch(`/api/admin/support-legal`);
}

export async function saveSupportLegalSettings(
  p: Omit<SupportLegalSettings, "id">
): Promise<void> {
  await jfetch(`/api/admin/support-legal/save`, { method: "POST", body: p });
}

// ======================= Users & Roles (Admin) =======================
export type RoleDTO = { id: string; name: string };
export type UserDTO = {
  id: string;
  name: string;
  email: string;
  role: string;
  twoFactorEnabled: boolean;
  suspended: boolean;
  lastSeen: string | null;
  status: "active" | "invited" | "suspended";
  createdAt?: string;
  updatedAt?: string;

  // Optional profile fields (present if your DB exposes them)
  phone?: string | null;
  address1?: string | null;
  address2?: string | null;
  city?: string | null;
  state?: string | null;
  postal?: string | null;
  country?: string | null;
};

export async function getAdminRoles(): Promise<{ items: RoleDTO[] }> {
  // Wrap server response (array) into {items} for consistency
  const arr = await jfetch<RoleDTO[]>(`/api/admin/users/roles`);
  return { items: arr };
}

export async function getAdminUsers(): Promise<{ items: UserDTO[]; total?: number }> {
  // backend returns {items, total}
  return await jfetch(`/api/admin/users`);
}

export type InvitePayload = { name?: string; email: string; role?: string; message?: string };

/** Invite one-by-one under the hood to keep types simple */
export async function inviteUsers(invites: InvitePayload[]): Promise<{ created: UserDTO[] }> {
  const created: UserDTO[] = [];
  for (const i of invites) {
    const resp = await jfetch<{ id: string }>(`/api/admin/users/invite`, {
      method: "POST",
      body: i,
    });
    created.push({
      id: resp.id,
      name: i.name ?? i.email.split("@")[0],
      email: i.email,
      role: i.role ?? "User",
      status: "invited",
      twoFactorEnabled: false,
      suspended: false,
      lastSeen: null,
    });
  }
  return { created };
}

/** Change a user's role */
export async function updateUserRole(userId: string, role: string): Promise<void> {
  await jfetch<void>(`/api/admin/users/${encodeURIComponent(userId)}/role`, {
    method: "PATCH",
    body: { role },
  });
}

/** Trigger a 2FA reset */
export async function resetUser2FA(userId: string): Promise<void> {
  await jfetch<void>(`/api/admin/users/${encodeURIComponent(userId)}/reset-2fa`, {
    method: "POST",
  });
}

/** Remove (delete) a user */
export async function removeUser(userId: string): Promise<void> {
  await jfetch<void>(`/api/admin/users/${encodeURIComponent(userId)}`, {
    method: "DELETE",
  });
}

/** Suspend / Unsuspend user */
export async function setUserSuspended(userId: string, suspended: boolean): Promise<void> {
  await jfetch<void>(`/api/admin/users/${encodeURIComponent(userId)}/suspend`, {
    method: "POST",
    body: { suspended },
  });
}

/* -------- Admin create + reset password -------- */
export type CreateUserPayload = {
  name: string;
  email: string;
  role?: string;
  password: string;
  status?: "active" | "invited" | "suspended";
};

export async function createAdminUser(p: CreateUserPayload): Promise<{ id: string }> {
  return await jfetch(`/api/admin/users/create`, { method: "POST", body: p });
}

export async function setUserPassword(userId: string, password: string): Promise<void> {
  await jfetch(`/api/admin/users/${encodeURIComponent(userId)}/password`, {
    method: "POST",
    body: { password },
  });
}

/* -------- NEW: Update user details (partial) -------- */
export type UpdateUserPayload = Partial<{
  name: string;
  email: string;
  role: string;
  phone: string;
  address1: string;
  address2: string;
  city: string;
  state: string;
  postal: string;
  country: string;
}>;

export async function updateUser(userId: string, p: UpdateUserPayload): Promise<void> {
  await jfetch<void>(`/api/admin/users/${encodeURIComponent(userId)}`, {
    method: "PATCH",
    body: p,
  });
}

// ---------------------------------------------------------------------------
// Account (current user) - Profile
// ---------------------------------------------------------------------------
export type MeProfile = {
  id: string;
  name: string;
  email: string;
  username?: string;
  phone?: string | null;
  address1?: string | null;
  address2?: string | null;
  city?: string | null;
  state?: string | null;
  postal?: string | null;
  country?: string | null;
  timezone?: string | null;
  locale?: string | null;
  avatarUrl?: string | null; // backend may store as avatar_url; mapped server-side
  createdAt?: string;
  updatedAt?: string;
};

export type UpdateMePayload = Partial<{
  name: string;
  email: string;
  username: string;
  phone: string | null;
  address1: string | null;
  address2: string | null;
  city: string | null;
  state: string | null;
  postal: string | null;
  country: string | null;
  timezone: string | null;
  locale: string | null;
  avatarUrl: string | null;
}>;

/** Load the signed-in user's profile */
export async function getMyProfile(): Promise<MeProfile> {
  return await jfetch<MeProfile>(`/api/users/me`);
}

/** Patch the signed-in user's profile (only sends provided keys) */
export async function updateMyProfile(patch: UpdateMePayload): Promise<MeProfile> {
  const body = Object.fromEntries(Object.entries(patch).filter(([, v]) => v !== undefined));
  return await jfetch<MeProfile>(`/api/users/me`, { method: "PATCH", body });
}

// ---------------------------------------------------------------------------
// Account (current user) - Security & Sessions (legacy helpers kept)
// ---------------------------------------------------------------------------
export type SecuritySettings = {
  twoFaEnabled: boolean;
  autoRevokeSessions?: boolean;
};

export async function getSecuritySettings(): Promise<SecuritySettings> {
  return await jfetch(`/api/users/security`);
}
export async function saveSecuritySettings(p: Partial<SecuritySettings>): Promise<void> {
  await jfetch(`/api/users/security`, { method: "PATCH", body: p });
}

export type SessionDTO = {
  id: string;
  device: string;
  ip: string;
  lastActive: string;
  current: boolean;
  city?: string;
  isp?: string;
  trusted?: boolean;
};

export async function listSessions(): Promise<{ items: SessionDTO[] }> {
  return await jfetch(`/api/users/sessions`);
}
export async function toggleTrustSession(sessionId: string, trusted: boolean): Promise<void> {
  await jfetch(`/api/users/sessions/${encodeURIComponent(sessionId)}/trust`, {
    method: "POST",
    body: { trusted },
  });
}
export async function revokeSession(sessionId: string): Promise<void> {
  await jfetch(`/api/users/sessions/${encodeURIComponent(sessionId)}`, { method: "DELETE" });
}
export async function revokeAllSessions(): Promise<void> {
  await jfetch(`/api/users/sessions`, { method: "DELETE" });
}

// ---------------------------------------------------------------------------
// Account (current user) - Notifications
// ---------------------------------------------------------------------------
export type NotificationSettings = {
  email: boolean;
  push: boolean;
  product: boolean;
  digest: "off" | "daily" | "weekly";
  quiet?: { enabled: boolean; start?: string; end?: string };
  products?: string[];
};

export async function getNotificationSettings(): Promise<NotificationSettings> {
  return await jfetch(`/api/users/notifications`);
}
export async function saveNotificationSettings(p: Partial<NotificationSettings>): Promise<void> {
  await jfetch(`/api/users/notifications`, { method: "PATCH", body: p });
}

// ---------------------------------------------------------------------------
// Account (current user) - Integrations (Slack + generic webhook)
// ---------------------------------------------------------------------------
export type IntegrationsSettings = {
  slackWebhook?: string;
  webhookUrl?: string;
  webhookSigningSecret?: string;
  events?: string[];
};

export async function getIntegrationsSettings(): Promise<IntegrationsSettings> {
  return await jfetch(`/api/users/integrations`);
}
export async function saveIntegrationsSettings(p: Partial<IntegrationsSettings>): Promise<void> {
  await jfetch(`/api/users/integrations`, { method: "PATCH", body: p });
}

export async function testSlackWebhook(urlStr: string): Promise<{ ok: boolean; status: number; ms?: number }> {
  return await jfetch(`/api/users/integrations/test/slack`, { method: "POST", body: { url: urlStr } });
}
export async function testGenericWebhook(urlStr: string): Promise<{ ok: boolean; status: number; ms?: number }> {
  return await jfetch(`/api/users/integrations/test/webhook`, { method: "POST", body: { url: urlStr } });
}
export async function rotateSigningSecret(): Promise<{ secret: string }> {
  return await jfetch(`/api/users/integrations/rotate-signing-secret`, { method: "POST" });
}

// ---------------------------------------------------------------------------
// Account (current user) - API Keys
// ---------------------------------------------------------------------------
export type ApiKeyDTO = {
  id: string;          // token id (e.g., "rk_live_xxx")
  label: string;
  lastUsed?: string;
  scopes?: string[];
  expiresAt?: string;  // iso or empty string if never
};

export async function listApiKeys(): Promise<{ items: ApiKeyDTO[] }> {
  const arr = await jfetch<ApiKeyDTO[]>(`/api/users/api-keys`);
  return { items: arr };
}

export async function createApiKey(
  label: string,
  scopes: string[],
  expiresIn: "never" | "30d" | "90d",
  ipAllowlist?: string
): Promise<ApiKeyDTO> {
  return await jfetch(`/api/users/api-keys`, {
    method: "POST",
    body: { label, scopes, expiresIn, ipAllowlist },
  });
}

export async function revokeApiKey(id: string): Promise<void> {
  await jfetch(`/api/users/api-keys/${encodeURIComponent(id)}`, { method: "DELETE" });
}

export async function regenerateApiKey(id: string): Promise<{ oldId: string; newKey: string }> {
  return await jfetch(`/api/users/api-keys/${encodeURIComponent(id)}/regenerate`, { method: "POST" });
}

// Upload avatar to the dedicated endpoint
export async function uploadMyAvatar(file: File): Promise<{ url: string }> {
  const form = new FormData();
  form.append("file", file, file.name || "avatar.png");

  const base = (typeof process !== "undefined" && process.env.NEXT_PUBLIC_API_BASE) || "";
  const res = await fetch(`${base.replace(/\/+$/, "")}/api/users/me/avatar`, {
    method: "POST",
    credentials: "include",
    body: form,
  });
  if (!res.ok) {
    let msg = "";
    try { msg = (await res.json())?.message || ""; } catch { }
    if (!msg) try { msg = await res.text(); } catch { }
    throw new Error(msg || `Upload failed (${res.status})`);
  }
  return (await res.json()) as { url: string };
}

export async function removeMyAvatar(): Promise<void> {
  await jfetch<void>(`/api/users/me/avatar`, { method: "DELETE" });
}

/* ============================================================================
   NEW: Security Overview + TOTP + Sessions (ME scope) + PAT + WebAuthn stubs
   ==========================================================================*/

// ---- Types used by the Security tab ----
export type SecurityEvent = {
  id: string;
  type:
  | "signed_in"
  | "password_changed"
  | "2fa_enabled"
  | "2fa_disabled"
  | "recovery_codes_regenerated"
  | "session_revoked";
  at: string;
  ip?: string;
  userAgent?: string;
};

export type WebAuthnCredential = {
  id: string;
  label: string;
  createdAt: string;
  lastUsedAt?: string;
};

export type RecoveryCodes = string[];

// ---- Sessions (ME) ----
export type Session = {
  id: string;
  createdAt: string;
  lastSeenAt: string | null;
  ip: string | null;
  userAgent: string | null;
  current: boolean;
  trusted?: boolean;
  label?: string | null;
  revokedAt?: string | null; // <-- include so we can filter locally
};

export type SecurityOverview = {
  twoFactorEnabled: boolean;
  sessions: Session[];
  events: SecurityEvent[];
  webAuthn?: WebAuthnCredential[];
};

export type TOTPInit = { secret: string; otpauthUrl: string; qrPngDataUrl: string };

// ---- Overview ----
export async function getSecurityOverview(): Promise<SecurityOverview> {
  return await jfetch<SecurityOverview>(`/api/users/me/security`);
}

// ---- Change Password ----
export async function changePasswordSelf(current: string, next: string): Promise<void> {
  await jfetch(`/api/users/me/password`, { method: "POST", body: { current, next } });
}

// ---- TOTP 2FA ----
export async function start2FA(): Promise<TOTPInit> {
  return await jfetch<TOTPInit>(`/api/users/me/2fa/start`, { method: "POST" });
}

export async function confirm2FA(p: { code: string }): Promise<void> {
  await jfetch(`/api/users/me/2fa/confirm`, { method: "POST", body: p });
}

export async function disable2FA(p?: { code?: string; recoveryCode?: string }): Promise<void> {
  await jfetch(`/api/users/me/2fa/disable`, { method: "POST", body: p ?? {} });
}

export async function regenerateRecoveryCodes(): Promise<RecoveryCodes> {
  const res = await jfetch<{ recoveryCodes: string[] }>(`/api/users/me/2fa/recovery/regen`, {
    method: "POST",
  });
  return res.recoveryCodes;
}

// ---- Sessions (ME) ----
// NOTE: some servers include revoked sessions in the list; we filter them out.
export async function listMySessions(): Promise<{ items: Session[]; currentJti?: string }> {
  const res = await jfetch<{ items: Session[]; currentJti?: string }>(`/api/users/me/sessions/`);
  const items = (res.items ?? []).filter((s) => !s.revokedAt); // <-- hide revoked
  return { items, currentJti: res.currentJti };
}

export async function revokeAllOtherSessions(): Promise<void> {
  await jfetch(`/api/users/me/sessions/revoke-all`, { method: "POST" });
}

/**
 * Revoke a single session (ME).
 * Tries a sequence of plausible endpoints so we work with whatever the backend exposes.
 */
export async function revokeMySession(sessionId: string): Promise<void> {
  const enc = encodeURIComponent(sessionId);
  const base = `/api/users/me/sessions/${enc}`;

  // 1) Preferred: DELETE /me/sessions/:id
  try {
    await jfetch(base, { method: "DELETE" });
    return;
  } catch (e: any) {
    const msg = String(e?.message || "").toLowerCase();
    const status = e?.status ?? e?.code;
    if (!(status === 404 || status === 405 || msg.includes("cannot delete"))) throw e;
  }

  // 2) Alt: POST /me/sessions/:id/revoke
  try {
    await jfetch(`${base}/revoke`, { method: "POST" });
    return;
  } catch (e: any) {
    const status = e?.status ?? e?.code;
    if (!(status === 404 || status === 405)) throw e;
  }

  // 3) Alt: POST /me/sessions/revoke  { sessionId }
  try {
    await jfetch(`/api/users/me/sessions/revoke`, { method: "POST", body: { sessionId } });
    return;
  } catch (e: any) {
    const status = e?.status ?? e?.code;
    if (!(status === 404 || status === 405)) throw e;
  }

  // 4) Alt: POST /me/sessions/revoke/:id
  try {
    await jfetch(`/api/users/me/sessions/revoke/${enc}`, { method: "POST" });
    return;
  } catch (e: any) {
    const status = e?.status ?? e?.code;
    if (!(status === 404 || status === 405)) throw e;
  }

  // 5) Last-resort: PATCH /me/sessions/:id { action: "revoke" }
  await jfetch(base, { method: "PATCH", body: { action: "revoke" } });
}

/** Trust / untrust a session (ME) with fallbacks similar to revoke */
export async function trustMySession(
  sessionId: string,
  trusted: boolean
): Promise<{ trusted: boolean }> {
  const enc = encodeURIComponent(sessionId);
  const base = `/api/users/me/sessions/${enc}`;

  // 1) Preferred: POST /me/sessions/:id/trust { trusted }
  try {
    return await jfetch(`${base}/trust`, { method: "POST", body: { trusted } });
  } catch (e: any) {
    const status = e?.status ?? e?.code;
    if (!(status === 404 || status === 405)) throw e;
  }

  // 2) Alt: POST /me/sessions/trust { sessionId, trusted }
  try {
    return await jfetch(`/api/users/me/sessions/trust`, {
      method: "POST",
      body: { sessionId, trusted },
    });
  } catch (e: any) {
    const status = e?.status ?? e?.code;
    if (!(status === 404 || status === 405)) throw e;
  }

  // 3) Last-resort: PATCH /me/sessions/:id { trusted }
  return await jfetch(base, { method: "PATCH", body: { trusted } });
}

/** Optional: label a session (ME) */
export async function labelMySession(sessionId: string, label: string): Promise<void> {
  await jfetch(`/api/users/me/sessions/${encodeURIComponent(sessionId)}/label`, {
    method: "POST",
    body: { label },
  });
}

// lib/api.ts → mapMeSessionToDTO
export function mapMeSessionToDTO(s: Session): SessionDTO {
  return {
    id: s.id,
    device: s.label || s.userAgent || "Unknown device",
    ip: s.ip ?? "",                 // string (never undefined)
    lastActive: s.lastSeenAt ?? "", // string (never undefined)
    current: !!s.current,           // boolean
    city: undefined,
    isp: undefined,
    trusted: s.trusted ?? false,
  };
}


// ---- Personal Tokens (ME) ----
export type PersonalToken = {
  id: string;
  name: string;
  createdAt: string;
  lastUsedAt?: string;
  revokedAt?: string;
};

export async function listMyTokens(): Promise<{ items: PersonalToken[] }> {
  return await jfetch(`/api/users/me/tokens`);
}

export async function createMyToken(name: string): Promise<{ token: string; id: string }> {
  return await jfetch(`/api/users/me/tokens`, { method: "POST", body: { name } });
}

export async function revokeMyToken(id: string): Promise<void> {
  await jfetch(`/api/users/me/tokens/revoke`, { method: "POST", body: { id } });
}

// ---- WebAuthn (optional / stubbed) ----
export async function webauthnCreateOptions(): Promise<PublicKeyCredentialCreationOptions> {
  return await jfetch(`/api/users/me/webauthn/create-options`);
}

export async function webauthnFinishRegistration(attestationResponse: any): Promise<WebAuthnCredential> {
  return await jfetch(`/api/users/me/webauthn/finish`, { method: "POST", body: attestationResponse });
}

export async function deleteWebAuthnCredential(id: string): Promise<void> {
  return await jfetch(`/api/users/me/webauthn/${encodeURIComponent(id)}`, { method: "DELETE" });
}

// --- Device software: request uninstall --------------------------------
export async function requestUninstallSoftware(
  deviceId: string,
  body: { name: string; version?: string }
): Promise<{ accepted: true; jobId?: string }> {
  const res = await fetch(
    `${((typeof process !== "undefined" && process.env.NEXT_PUBLIC_API_BASE) || "").replace(/\/+$/, "")}/api/devices/${encodeURIComponent(deviceId)}/actions/uninstall`,
    {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    }
  );

  if (!res.ok) {
    // surface error text
    let msg = "";
    try { msg = (await res.clone().json())?.message || ""; } catch { }
    if (!msg) try { msg = await res.text(); } catch { }
    throw new Error(msg || `Request failed: ${res.status}`);
  }

  // Try JSON first
  let jobId: string | undefined;
  try {
    const json = await res.clone().json();
    jobId = json?.jobId;
  } catch {
    /* no json body */
  }

  // Fallback: parse Location header (e.g. /api/automation/runs/<uuid>)
  if (!jobId) {
    const loc = res.headers.get("Location") || res.headers.get("location");
    const m = loc?.match(/([0-9a-fA-F-]{8}-[0-9a-fA-F-]{4}-[1-5][0-9a-fA-F-]{3}-[89abAB][0-9a-fA-F-]{3}-[0-9a-fA-F-]{12})$/);
    if (m) jobId = m[1];
  }

  return { accepted: true, jobId };
}



----------------------------------------------------------------------------------------



========================================================================================
[34] FILE
Path       : lib/auth.ts
Size       : 445 bytes
Last Write : 2025-10-18 20:21:51
SHA256     : 14D3215B097C3928C9D5C2AEF6F11A8EF9282E1042451D5268F07AD005E9829E
========================================================================================

// app/lib/auth.ts
export async function getMe() {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/api/auth/me`, {
        credentials: 'include',
    });
    return res.json() as Promise<{ user: null | { id: string; email: string; name: string; role: string } }>;
}
export async function logout() {
    await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/api/auth/logout`, { method: 'POST', credentials: 'include' });
}



----------------------------------------------------------------------------------------



========================================================================================
[35] MISSING FILE
Path: hooks/useRequireAuth.ts
========================================================================================

========================================================================================
[36] FILE
Path       : lib/utils.ts
Size       : 166 bytes
Last Write : 2025-10-17 23:39:36
SHA256     : 7C8C3DFC0CDD370D44932828EB067EF771C8FE7996693221D5D4B90AF6D54F2D
========================================================================================

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}



----------------------------------------------------------------------------------------



========================================================================================
[37] FILE
Path       : lib/view-state.ts
Size       : 1,147 bytes
Last Write : 2025-10-17 18:36:17
SHA256     : D2CD5D3013AF5D12BF09513472A548DDC8FC70AE8AF3AFA2DD8FDC5244E1C85A
========================================================================================

//lib\view-state.ts

import { ColumnFiltersState, SortingState, VisibilityState } from "@tanstack/react-table";

type TableState = {
    s: SortingState;
    f: ColumnFiltersState;
    v: VisibilityState;
};

export function encodeTableState(state: TableState) {
    // micro-encode: JSON → base64 (swap +/= for URL safe)
    const json = JSON.stringify(state);
    const b64 = typeof window !== "undefined" ? window.btoa(unescape(encodeURIComponent(json))) : Buffer.from(json).toString("base64");
    return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
}

export function decodeTableState(token: string | null): TableState | null {
    if (!token) return null;
    try {
        const padded = token.replace(/-/g, "+").replace(/_/g, "/") + "===".slice((token.length + 3) % 4);
        const json = typeof window !== "undefined" ? decodeURIComponent(escape(window.atob(padded))) : Buffer.from(padded, "base64").toString();
        const obj = JSON.parse(json);
        if (!obj || typeof obj !== "object") return null;
        return obj as TableState;
    } catch {
        return null;
    }
}



----------------------------------------------------------------------------------------



========================================================================================
[38] FILE
Path       : lib/use-debounced-callback.ts
Size       : 746 bytes
Last Write : 2025-10-20 21:39:27
SHA256     : 7017A8932D9186934BA581E52322FD36980E454ACD3C349EC5E53590E47CC20D
========================================================================================

// Simple, typed debounce hook for stable callbacks
import * as React from "react";

export function useDebouncedCallback<T extends (...args: any[]) => void>(
    fn: T,
    delay = 500
) {
    const fnRef = React.useRef(fn);
    fnRef.current = fn;

    const timer = React.useRef<number | null>(null);

    const debounced = React.useCallback((...args: Parameters<T>) => {
        if (timer.current) window.clearTimeout(timer.current);
        timer.current = window.setTimeout(() => {
            fnRef.current(...args);
        }, delay) as unknown as number;
    }, [delay]);

    React.useEffect(() => () => {
        if (timer.current) window.clearTimeout(timer.current);
    }, []);

    return debounced as T;
}



----------------------------------------------------------------------------------------



========================================================================================
[39] FILE
Path       : lib/time.ts
Size       : 525 bytes
Last Write : 2025-10-29 13:12:12
SHA256     : 594905C19F528C8719E09FEEDFBD804B00640F4EC868AA9BAAB886269200357B
========================================================================================

// lib/time.ts
// US-style: MM/DD/YYYY - H:MM AM/PM (local time)
const usFmt = new Intl.DateTimeFormat("en-US", {
    month: "2-digit",
    day: "2-digit",
    year: "numeric",
    hour: "numeric",
    minute: "2-digit",
    hour12: true,
});

export function formatUsDateTime(iso?: string | null): string {
    if (!iso) return "—";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return String(iso);
    // Replace the comma Intl adds with " -"
    return usFmt.format(d).replace(",", " -");
}



----------------------------------------------------------------------------------------



========================================================================================
[40] FILE
Path       : lib/toast.tsx
Size       : 1,564 bytes
Last Write : 2025-10-29 13:12:12
SHA256     : 50A13E67D1CC500D0ECE3C28D4F73661CBB44D2A41723A1D189F292466648BDE
========================================================================================

// remoteiq-frontend/lib/toast.ts
"use client";

import * as React from "react";
import {
  toast as coreToast,
  dismiss as coreDismiss,
  type ToastOptions as CoreOptions,
} from "@/components/ui/use-toast";

/**
 * Legacy compatibility:
 *   push({ title, kind: "success" | "destructive" | "default" | "warning", desc })
 * We map to the modern options { variant, description } understood by use-toast.ts
 */
export type PushToast = CoreOptions & {
  desc?: string;
  kind?: "default" | "destructive" | "success" | "warning";
};

export function push(t: PushToast) {
  const { desc, kind, ...rest } = t;

  // Map `kind` -> variant
  const variant =
    (rest as any).variant ??
    (kind === "destructive"
      ? "destructive"
      : kind === "success"
        ? "success"
        : "default");

  coreToast({
    ...rest,
    variant,
    description: (rest as any).description ?? desc,
  });
}

// Re-export basic imperative API
export const toast = coreToast;
export const dismiss = coreDismiss;

// Back-compat: some places still import a provider/viewport from here.
// We don't put Radix Provider here; the Toaster component renders items & viewport.
export function ToastProvider({ children }: { children: React.ReactNode }) {
  return <>{children}</>;
}

// Back-compat hook returning legacy shape { push, toast, dismiss }
export function useToast() {
  return { push, toast: coreToast, dismiss: coreDismiss };
}

// Optional: keep name for type imports
export type ToastOptions = CoreOptions;



----------------------------------------------------------------------------------------



========================================================================================
[41] FILE
Path       : lib/ws.ts
Size       : 725 bytes
Last Write : 2025-10-18 12:56:36
SHA256     : 169E857F655CC4EF726BE8FC81A87DBA1CE79F7E2C690A427C2F8EED2FDEC3FD
========================================================================================

// lib/ws.ts
type Listener = (msg: any) => void;

let socket: WebSocket | null = null;
const listeners = new Set<Listener>();

export function ensureSocket(): WebSocket {
  const base = process.env.NEXT_PUBLIC_WS_BASE || "ws://localhost:3001/ws";
  if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
    return socket;
  }
  socket = new WebSocket(base);
  socket.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);
      for (const cb of Array.from(listeners)) cb(data);
    } catch {
      // ignore malformed frames
    }
  };
  return socket;
}

export function onWsMessage(cb: Listener) {
  listeners.add(cb);
  return () => listeners.delete(cb);
}



----------------------------------------------------------------------------------------



========================================================================================
[42] FILE
Path       : app/providers/BrandingProvider.tsx
Size       : 6,814 bytes
Last Write : 2025-10-18 22:18:52
SHA256     : 91BF3465EBDFD6CD481E7DB7B51BD1431C490DE9E603A57B791F2282A121AA5C
========================================================================================

"use client";

import * as React from "react";

/**
 * Branding shape coming from GET /api/branding
 */
export interface Branding {
    primaryColor: string;
    secondaryColor: string;
    logoLightUrl: string;
    logoDarkUrl: string;
    loginBackgroundUrl: string;
    faviconUrl: string; // may be empty
    emailHeader: string;
    emailFooter: string;
    customCss: string;
    allowClientThemeToggle: boolean;
}

type PreviewPatch = Partial<Pick<Branding, "primaryColor" | "secondaryColor" | "faviconUrl">>;

interface BrandingContextType {
    branding: Branding | null;
    isLoaded: boolean;
    applyPreview: (patch: PreviewPatch) => void;
    clearPreview: () => void;
    refetch: () => Promise<void>;
}

const BrandingContext = React.createContext<BrandingContextType | undefined>(undefined);

const DEFAULT_PRIMARY = "#3b82f6";
const DEFAULT_SECONDARY = "#22c55e";
const DEFAULT_FAVICON = "/favicon.ico"; // <- default from public/
const HEX = /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/;

/* ====================== CSS Var helpers ====================== */

function setCssVar(name: string, value: string) {
    document.documentElement.style.setProperty(name, value);
}

// converts hex -> hsl tuple string: "210 100% 56%"
function hexToHslTuple(hex: string): string {
    if (!HEX.test(hex)) {
        return "0 0% 0%";
    }
    let h = hex.slice(1);
    if (h.length === 3) h = h.split("").map((c) => c + c).join("");
    const num = parseInt(h, 16);
    const r = ((num >> 16) & 255) / 255;
    const g = ((num >> 8) & 255) / 255;
    const b = (num & 255) / 255;

    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    const l = (max + min) / 2;

    let hh = 0;
    let s = 0;

    if (max !== min) {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r:
                hh = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                hh = (b - r) / d + 2;
                break;
            default:
                hh = (r - g) / d + 4;
        }
        hh /= 6;
    }

    const H = Math.round(hh * 360);
    const S = Math.round(s * 100);
    const L = Math.round(l * 100);
    return `${H} ${S}% ${L}%`;
}

/* ====================== Favicon helpers ====================== */

function ensureFaviconLink(): HTMLLinkElement {
    // Prefer rel="icon", but also handle existing "shortcut icon"
    let link = document.querySelector<HTMLLinkElement>('link[rel="icon"]');
    if (!link) {
        link = document.createElement("link");
        link.rel = "icon";
        document.head.appendChild(link);
    }
    return link;
}

function setFavicon(href: string) {
    const link = ensureFaviconLink();
    link.href = href || DEFAULT_FAVICON;
}

/* ====================== Provider ====================== */

export function BrandingProvider({ children }: { children: React.ReactNode }) {
    const [branding, setBranding] = React.useState<Branding | null>(null);
    const [isLoaded, setIsLoaded] = React.useState(false);

    const applyThemeVars = React.useCallback((b: Branding | null) => {
        const primary = b?.primaryColor || DEFAULT_PRIMARY;
        const secondary = b?.secondaryColor || DEFAULT_SECONDARY;
        setCssVar("--primary", hexToHslTuple(primary));
        setCssVar("--secondary", hexToHslTuple(secondary));
    }, []);

    const applyInitialFavicon = React.useCallback((b: Branding | null) => {
        const src = b?.faviconUrl?.trim() || DEFAULT_FAVICON;
        setFavicon(src);
    }, []);

    const fetchBranding = React.useCallback(async () => {
        try {
            const res = await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/api/branding`, {
                method: "GET",
                credentials: "include",
                headers: { "Accept": "application/json" },
            });
            if (!res.ok) {
                throw new Error(`GET /api/branding failed: ${res.status}`);
            }
            const data = (await res.json()) as Branding;
            setBranding(data);
            // apply CSS + favicon
            applyThemeVars(data);
            applyInitialFavicon(data);
        } catch (e) {
            // fall back to defaults if fetch fails
            setBranding({
                primaryColor: DEFAULT_PRIMARY,
                secondaryColor: DEFAULT_SECONDARY,
                logoLightUrl: "",
                logoDarkUrl: "",
                loginBackgroundUrl: "",
                faviconUrl: "",
                emailHeader: "<h1>{{org_name}}</h1>",
                emailFooter: "<p>Copyright 2025. All rights reserved.</p>",
                customCss: "/* ... */",
                allowClientThemeToggle: true,
            });
            applyThemeVars(null);
            applyInitialFavicon(null);
            // eslint-disable-next-line no-console
            console.warn(e);
        } finally {
            setIsLoaded(true);
        }
    }, [applyInitialFavicon, applyThemeVars]);

    React.useEffect(() => {
        fetchBranding();
    }, [fetchBranding]);

    /**
     * applyPreview:
     * - Accepts partial { primaryColor?, secondaryColor?, faviconUrl? }
     * - Applies CSS vars and/or favicon temporarily without mutating `branding`.
     */
    const applyPreview = React.useCallback(
        (patch: PreviewPatch) => {
            if (patch.primaryColor) {
                setCssVar("--primary", hexToHslTuple(patch.primaryColor));
            }
            if (patch.secondaryColor) {
                setCssVar("--secondary", hexToHslTuple(patch.secondaryColor));
            }
            if (patch.faviconUrl !== undefined) {
                setFavicon(patch.faviconUrl?.trim() || DEFAULT_FAVICON);
            }
        },
        []
    );

    /**
     * clearPreview:
     * - Reapplies CSS vars + favicon from the current saved branding (or defaults)
     */
    const clearPreview = React.useCallback(() => {
        applyThemeVars(branding);
        applyInitialFavicon(branding);
    }, [applyInitialFavicon, applyThemeVars, branding]);

    const value: BrandingContextType = React.useMemo(
        () => ({ branding, isLoaded, applyPreview, clearPreview, refetch: fetchBranding }),
        [branding, isLoaded, applyPreview, clearPreview, fetchBranding]
    );

    return <BrandingContext.Provider value={value}>{children}</BrandingContext.Provider>;
}

export function useBranding() {
    const ctx = React.useContext(BrandingContext);
    if (!ctx) throw new Error("useBranding must be used within BrandingProvider");
    return ctx;
}



----------------------------------------------------------------------------------------



========================================================================================
[43] MISSING FILE
Path: providers/BrandingProvider.tsx
========================================================================================

========================================================================================
[44] FILE
Path       : styles/globals.css
Size       : 3,921 bytes
Last Write : 2025-10-18 21:36:12
SHA256     : 13E7DDC3407F2AE6ED6BCFA33EAB7A01CC550712BD8283927507DD927E7BF75F
========================================================================================

/* app/globals.css */

@tailwind base;
@tailwind components;
@tailwind utilities;

/* -----------------------------------------------------------
   shadcn/ui expects HSL triplets in tokens like --primary and
   uses them via hsl(var(--primary)).
   These are sensible defaults; BrandingProvider will override.
----------------------------------------------------------- */
@layer base {
  :root {
    /* Neutral / Gray (light) */
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;

    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;

    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;

    /* PRIMARY/SECONDARY (HSL TRIPLETS) */
    /* Defaults; overridden at runtime by BrandingProvider */
    --primary: 221.2 83.2% 53.3%;
    --primary-foreground: 210 40% 98%;

    --secondary: 142.1 76.2% 36.3%;
    --secondary-foreground: 210 40% 98%;

    /* Subtle surfaces */
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;

    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;

    /* Destructive (red) */
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;

    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;

    --radius: 0.5rem;

    /* optional charts */
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;

    /* aliases in case you reference elsewhere */
    --brand-primary: var(--primary);
    --brand-secondary: var(--secondary);
  }

  .dark {
    /* Neutrals */
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;

    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;

    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;

    /* PRIMARY/SECONDARY defaults in dark (still HSL triplets) */
    --primary: 217.2 91.2% 59.8%;
    --primary-foreground: 0 0% 100%;

    --secondary: 142.1 70.6% 45.3%;
    --secondary-foreground: 0 0% 0%;

    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;

    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;

    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;

    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;

    /* charts (optional) */
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }

  html {
    scrollbar-gutter: stable both-edges;
  }

  body {
    @apply bg-background text-foreground;
  }
}

/* === Ambient tooltip (data-tooltip) === */
.riq-tooltip {
  position: absolute;
  z-index: 9999;
  max-width: 280px;
  pointer-events: none;

  background-color: hsl(var(--popover));
  color: hsl(var(--popover-foreground));
  border: 1px solid hsl(var(--border));
  border-radius: 0.375rem;
  padding: 6px 8px;
  font-size: 12px;
  line-height: 1.2;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
  transition: opacity 120ms ease;
  opacity: 1;
}

.riq-tooltip.hidden {
  opacity: 0;
  visibility: hidden;
}

@media (prefers-reduced-motion: reduce) {
  .riq-tooltip {
    transition: none;
  }
}

/* === Chrome/Edge autofill yellow override (login, etc.) === */
@layer base {
  input:-webkit-autofill,
  textarea:-webkit-autofill,
  select:-webkit-autofill {
    box-shadow: 0 0 0px 1000px hsl(var(--background)) inset !important;
    -webkit-text-fill-color: hsl(var(--foreground)) !important;
    caret-color: hsl(var(--foreground));
    transition: background-color 9999s ease-out 0s;
  }

  input:-webkit-autofill:focus,
  textarea:-webkit-autofill:focus,
  select:-webkit-autofill:focus {
    box-shadow: 0 0 0px 1000px hsl(var(--background)) inset !important, 0 0 0 2px hsl(var(--ring)) !important;
  }
}



----------------------------------------------------------------------------------------



========================================================================================
SUMMARY
========================================================================================
Exported files : 42
Missing files  : 2

Missing paths:
 - hooks/useRequireAuth.ts
 - providers/BrandingProvider.tsx
========================================================================================
